"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var path=require("path");var hasOwnProp=require("has-own-prop");var nike_hercules_1=require("@implydata/nike-hercules");var innerServer=require("./app");var cluster_actions_1=require("./actions/cluster-actions/cluster-actions");var launcher_data_source_1=require("../common/models/launcher-data-source/launcher-data-source");var utils_1=require("@implydata/im-auth/build/server/utils");var im_auth_1=require("@implydata/im-auth");var immutable_class_1=require("immutable-class");var immutable_store_1=require("@implydata/immutable-store");var models_1=require("@implydata/pivot/build/common/models");var launcher_cluster_1=require("../common/models/launcher-cluster/launcher-cluster");var DUMMY_CLUSTER=launcher_cluster_1.LauncherCluster.fromJS({name:"launcherCluster",clusterId:"hi",queryHosts:["172.31.7.55"],dataSources:[new launcher_data_source_1.LauncherDataSource({name:"wikipedia",clusterId:"hi",columns:[{name:"__time",type:"time"}]})]});var MockClusterActions=function(e){tslib_1.__extends(r,e);function r(){var r=e!==null&&e.apply(this,arguments)||this;r.getCluster=function(e){return tslib_1.__awaiter(r,void 0,void 0,function(){return tslib_1.__generator(this,function(e){return[2,Promise.resolve(DUMMY_CLUSTER)]})})};r.getAllClusters=function(){return tslib_1.__awaiter(r,void 0,void 0,function(){return tslib_1.__generator(this,function(e){return[2,Promise.resolve([DUMMY_CLUSTER])]})})};return r}return r}(cluster_actions_1.ClusterActions);var adminUser=im_auth_1.User.fromJS({name:"admin@bigdatacompany.com",email:"admin@bigdatacompany.com",firstName:"Admin",lastName:"Imply",roles:["super-admin"]});var userUser=im_auth_1.User.fromJS({name:"user@bigdatacompany.com",email:"user@bigdatacompany.com",firstName:"User",lastName:"Imply",roles:["user"]});var MockAuthorizer=function(){function e(){this.users=[adminUser,userUser]}e.prototype.getAllUsers=function(){return this.users};e.prototype.addOrUpdateUser=function(e){this.users=immutable_class_1.NamedArray.overrideByName(this.users,e);return this.users};e.prototype.deleteUser=function(e){this.users=this.users.filter(function(r){return r.name!==e});return this.users};return e}();var clusterStore=new immutable_store_1.ArrayStore({initArray:[models_1.Cluster.fromJS({name:"druid",title:"Demo Druid",type:"druid",host:"172.31.7.56",timeout:3e4,socksHost:"localhost"})]});function makeWrapperServer(e){var r=e.serverConfig,t=e.version,a=e.sideDrawerItems;var s=new nike_hercules_1.HerculesServer({serverRoot:r.getServerRoot()});if(r.getTrustProxy()==="always"){s.getApp().set("trust proxy",1)}s.addCompress();s.decorateReqRes();s.getApp().use(nike_hercules_1.logAndTrack({morganFormat:r.getRequestLogFormat(),customTokens:{requestId:function(e,r){return e.requestId}}}));s.addStaticRoutes([path.join(__dirname,"../../build/public"),path.join(__dirname,"../../assets")]);var i=new utils_1.LicenseManager({appName:"Launcher",logger:nike_hercules_1.LOGGER,varDir:path.resolve("var"),licenseFile:path.resolve("launcher-license")});var u=[im_auth_1.Role.SUPER_ADMIN,im_auth_1.Role.USER];var o={getAll:function(){return u},get:function(e){return immutable_class_1.NamedArray.findByName(u,e)},addOrUpdate:function(e){u=immutable_class_1.NamedArray.overrideByName(u,e);return u},deleteByKey:function(e){u=immutable_class_1.NamedArray.deleteByName(u,e);return u}};var n=new immutable_store_1.ArrayStore({initArray:[models_1.Customization.BLANK]});s.getApp().use(function(e,s,u){e.serverConfig=r;e.clusterStore=clusterStore;e.clusterActions=new MockClusterActions;e.authorizer=new MockAuthorizer;e.rolesStore=o;e.customizationStore=n;e.hasUsersConcept=true;e.showRolesTab=true;e.licenseManager=i;e.sideDrawerItems=a;e.user=im_auth_1.User.fromJS({name:"admin@bigdatacompany.com",email:"admin@bigdatacompany.com",firstName:"Admin",lastName:"Imply",roles:["super-admin"]});e.version=t;u()});s.getApp().use("/",innerServer.makeLauncherServer({appTitle:"Wrapper APPPPPS",version:"standalone",serverConfig:r,logoutHref:"/logout",homeHref:"/",simplePivot:false,hasSubscription:true}).getApp());s.getApp().use(function(e,r,t,a){nike_hercules_1.LOGGER.error("request error: "+r.requestId);if(hasOwnProp(e,"type")&&e.type==="cloudManager"){t.status(e.code).json({error:e.message,info:e.info});return}a(e)});return s.getApp()}exports.makeWrapperServer=makeWrapperServer;