"use strict";var _this=this;var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var middleware_1=require("../../utils/middleware/middleware");var userRouter=nike_hercules_1.HerculesServer.makeRouter();userRouter.post("/load",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,a,u,n;return tslib_1.__generator(this,function(i){switch(i.label){case 0:t=e.authorizer,s=e.rolesStore,a=e.user;return[4,t.getAllUsers()];case 1:u=i.sent();return[4,s.getAll()];case 2:n=i.sent();if(!a.can("manage-users",n)){u=u.filter(function(e){return e.name===a.name})}r.send({users:u});return[2]}})})});userRouter.post("/create",middleware_1.makeGuardForUserManagement(),function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,a,u,n;return tslib_1.__generator(this,function(i){switch(i.label){case 0:s=e.body.user;a=e.authorizer;i.label=1;case 1:i.trys.push([1,3,,4]);return[4,a.addOrUpdateUser(im_auth_1.User.fromJS(s))];case 2:i.sent();return[3,4];case 3:u=i.sent();t(u);return[2];case 4:return[4,a.getAllUsers()];case 5:n=i.sent();r.send({users:n});return[2]}})})});userRouter.post("/update",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,a,u,n,i,l,o,c,_;return tslib_1.__generator(this,function(d){switch(d.label){case 0:s=e.body.user;a=e.authorizer,u=e.rolesStore,n=e.user;try{i=im_auth_1.User.fromJS(s)}catch(e){t(e);return[2]}d.label=1;case 1:d.trys.push([1,3,,4]);return[4,a.addOrUpdateUser(i)];case 2:d.sent();return[3,4];case 3:l=d.sent();t(l);return[2];case 4:return[4,u.getAll()];case 5:o=d.sent();if(!n.can("manage-users",o))return[3,7];return[4,a.getAllUsers()];case 6:_=d.sent();return[3,8];case 7:_=[i];d.label=8;case 8:c=_;r.send({users:c});return[2]}})})});userRouter.post("/delete",middleware_1.makeGuardForUserManagement(),function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,a,u,n,i,l,o;return tslib_1.__generator(this,function(c){switch(c.label){case 0:s=e.body,a=e.user,u=e.authorizer,n=e.requestId;i=s.user;c.label=1;case 1:c.trys.push([1,3,,4]);return[4,u.deleteUser(i.name)];case 2:c.sent();return[3,4];case 3:l=c.sent();t(l);return[2];case 4:return[4,u.getAllUsers()];case 5:o=c.sent();r.send({users:o});return[2]}})})});module.exports=userRouter;