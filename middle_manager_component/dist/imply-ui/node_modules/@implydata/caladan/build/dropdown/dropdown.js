"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var little_pictures_1=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var svg_icon_1=require("../svg-icon/svg-icon");function simpleEqual(e,t){return e===t}var Dropdown=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.focusAlreadyGiven=false;t.state={open:false,hoveredIndex:-1};return t}t.specialize=function(){return t};t.prototype.componentDidUpdate=function(){this.maybeFocus()};t.prototype.componentDidMount=function(){this.maybeFocus()};t.prototype.maybeFocus=function(){if(!this.focusAlreadyGiven&&this.props.focusOnStartUp&&this.focusTarget){ReactDOM.findDOMNode(this.focusTarget).focus();this.focusAlreadyGiven=true}};t.prototype.onClick=function(){var e=this.state.open;this.setState({open:!e,hoveredIndex:-1})};t.prototype.onMouseDown=function(e){var t=this.state.open;if(!t)return;var n=ReactDOM.findDOMNode(this);if(!n)return;if(!beltful_1.DOMUtils.isInside(e.target,n))this.close()};t.prototype.onEscape=function(e){if(this.state.open){e.preventDefault();this.close()}};t.prototype.close=function(){this.setState({open:false,hoveredIndex:-1})};t.prototype.open=function(){this.setState({open:true,hoveredIndex:-1})};t.prototype.renderMenu=function(){var e=this.props,t=e.items,n=e.renderItem,r=e.keyItem,i=e.selectedItem,o=e.equal,s=e.onSelect,a=e.menuClassName;var l=this.state.hoveredIndex;if(!t||!t.length)return null;if(!n)n=String;if(!r)r=n;if(!o)o=simpleEqual;var c=t.map(function(e,t){return React.createElement("div",{className:classNames("dropdown-item",{selected:o(e,i),hovered:l===t}),key:r(e),onClick:function(){return s(e)}},n(e))});return React.createElement("div",{className:classNames("dropdown-menu",a)},c)};t.prototype.getSelectedIndex=function(){var e=this.props,t=e.items,n=e.selectedItem,r=e.equal;var i=-1;t.forEach(function(e,t){if((r||simpleEqual)(e,n)){i=t;return}});return i};t.prototype.shiftIndex=function(e,t){var n=this.props.items;e+=t;if(e>=n.length)e=0;if(e<0)e=n.length-1;return e};t.prototype.shiftSelection=function(e){var t=this.shiftIndex(this.getSelectedIndex(),e);this.props.onSelect(this.props.items[t])};t.prototype.shiftHoveredIndex=function(e){var t=this.state.hoveredIndex;if(t===-1)t=this.getSelectedIndex();var n=this.shiftIndex(t,e);this.setState({hoveredIndex:n})};t.prototype.onKeyDown=function(e){var t=this.props,n=t.items,r=t.onSelect;var i=this.state,o=i.open,s=i.hoveredIndex;if(o&&[13,27].indexOf(e.keyCode)>-1){e.preventDefault();return}if(!n)return;var a=n.length;if(e.keyCode===32){if(o){if(s>-1)r(n[s]);this.close()}else{this.open()}e.preventDefault()}if(e.keyCode===40){o?this.shiftHoveredIndex(1):this.shiftSelection(1);e.preventDefault()}if(e.keyCode===38){o?this.shiftHoveredIndex(-1):this.shiftSelection(-1);e.preventDefault()}};t.prototype.render=function(){var e=this;var t=this.props,n=t.label,r=t.renderItem,i=t.selectedItem,o=t.direction,s=t.renderSelectedItem,a=t.className,l=t.onFocus,c=t.onBlur;var u=this.state.open;if(!r)r=String;if(!o)o="down";if(!s)s=r;var p=null;if(n){p=React.createElement("div",{className:"dropdown-label"},n)}return React.createElement("div",{tabIndex:0,className:classNames("dropdown",o,a),onClick:function(){return e.onClick()},onKeyDown:this.onKeyDown.bind(this),ref:function(t){return e.focusTarget=t},onFocus:l,onBlur:c},React.createElement(global_event_listener_1.GlobalEventListener,{mouseDown:this.onMouseDown.bind(this),escape:this.onEscape.bind(this)}),p,React.createElement("div",{className:classNames("selected-item",{active:u})},s(i),React.createElement(svg_icon_1.SvgIcon,{className:"caret-icon",svg:little_pictures_1.DROPDOWN_CARET})),u?this.renderMenu():null)};return t}(React.Component);exports.Dropdown=Dropdown;