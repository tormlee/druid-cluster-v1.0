"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var caladan_1=require("@implydata/caladan");var classNames=require("classnames");var immutable_class_1=require("immutable-class");var React=require("react");function isPromiseAlike(thing){return Boolean(thing&&typeof thing.then==="function")}var ImmutableList=function(_super){tslib_1.__extends(ImmutableList,_super);function ImmutableList(){var _this=_super.call(this)||this;_this.state={};return _this}ImmutableList.specialize=function(){return ImmutableList};ImmutableList.prototype.editItem=function(index){this.setState({editedIndex:index})};ImmutableList.prototype.addItem=function(){this.setState({pendingAddItem:this.props.getNewItem()})};ImmutableList.prototype.componentWillReceiveProps=function(nextProps){if(nextProps.items){this.setState({tempItems:nextProps.items})}};ImmutableList.prototype.componentDidMount=function(){if(this.props.items){this.setState({tempItems:this.props.items})}};ImmutableList.prototype.deleteItems=function(indices){var tempItems=this.state.tempItems;this.setState({tempItems:tempItems.filter(function(item,i){return indices.indexOf(i)===-1})},this.onChange)};ImmutableList.prototype.onReorder=function(newIndices){var groupField=this.props.groupField;var tempItems=this.state.tempItems;var newTempItems=[];newIndices.forEach(function(_a,i){var group=_a.group,index=_a.index;var item=tempItems[index];if(groupField)item=item.change(groupField,group);newTempItems[i]=item});this.setState({tempItems:newTempItems},this.onChange)};ImmutableList.prototype.onGroupRename=function(oldName,newName,indices){var groupField=this.props.groupField;var tempItems=this.state.tempItems;indices.forEach(function(i){var item=tempItems[i];if(groupField)item=item.change(groupField,newName);tempItems[i]=item});this.setState({tempItems:tempItems},this.onChange)};ImmutableList.prototype.onChange=function(){var _this=this;var onChange=this.props.onChange;var tempItems=this.state.tempItems;var result=onChange(tempItems);if(isPromiseAlike(result)){this.setState({loadingChange:true});result.then(function(res){_this.setState({editedIndex:undefined,pendingAddItem:null,loadingChange:false})}).catch(function(error){_this.setState({loadingChange:false,changeError:error})})}else{this.setState({editedIndex:undefined,pendingAddItem:null})}};ImmutableList.prototype.onSearchChange=function(value){this.setState({searchString:value?value.toLowerCase():value})};ImmutableList.prototype.renderEditModal=function(itemIndex){var _this=this;var _a=this.state,tempItems=_a.tempItems,loadingChange=_a.loadingChange,changeError=_a.changeError;var item=tempItems[itemIndex];var onSave=function(newItem){var newItems=immutable_class_1.SimpleArray.change(tempItems,itemIndex,newItem);_this.setState({tempItems:newItems},_this.onChange)};var onClose=function(){return _this.setState({editedIndex:undefined})};return React.cloneElement(this.props.getModal(item),{onSave:onSave,onClose:onClose,mode:"edit",loading:loadingChange,error:changeError})};ImmutableList.prototype.renderAddModal=function(item){var _this=this;var preAddHook=this.props.preAddHook;var _a=this.state,loadingChange=_a.loadingChange,tempItems=_a.tempItems,changeError=_a.changeError;var onSave=function(newItem){var newItems=immutable_class_1.SimpleArray.append(tempItems,preAddHook?preAddHook(newItem):newItem);_this.setState({tempItems:newItems},_this.onChange)};var onSaveMany=function(newItems){_this.setState({tempItems:tempItems.concat(newItems)},_this.onChange)};var onClose=function(){return _this.setState({pendingAddItem:null})};return React.cloneElement(this.props.getModal(item),{onSave:onSave,onSaveMany:onSaveMany,onClose:onClose,mode:"create",loading:loadingChange,error:changeError})};ImmutableList.prototype.renderEmptyList=function(){var _a=this.props,label=_a.label,icon=_a.icon;return React.createElement("div",{className:"empty-container"},React.createElement("div",{className:"empty-message"},React.createElement("div",{className:"title"},icon?React.createElement("div",{className:"icon"},React.createElement(caladan_1.SvgIcon,{svg:icon})):null,React.createElement("div",{className:"label"},"No ",label))))};ImmutableList.prototype.renderEmptySearchResults=function(){var searchString=this.state.searchString;return React.createElement("div",{className:"empty-container"},React.createElement("div",{className:"empty-message no-search-results"},React.createElement("div",{className:"label"},"No results for ",searchString)))};ImmutableList.prototype.renderList=function(){var _this=this;var _a=this.props,items=_a.items,getRows=_a.getRows,disableReordering=_a.disableReordering,groupField=_a.groupField,actions=_a.actions;var searchString=this.state.searchString;if(items.length===0){return this.renderEmptyList()}var originalRows=getRows(items);if(groupField){originalRows.forEach(function(r,i){return r.group=items[i][groupField]})}var filteredRows=originalRows;if(searchString){filteredRows=filteredRows.filter(function(row){return row.title.toLowerCase().indexOf(searchString)>-1});if(filteredRows.length===0)return this.renderEmptySearchResults()}var edit={callback:function(indices){return _this.editItem(originalRows.indexOf(filteredRows[indices[0]]))}};if(actions&&actions.edit)edit=Object.assign(edit,actions.edit);var remove={callback:function(indices){return _this.deleteItems(indices.map(function(index){return originalRows.indexOf(filteredRows[index])}))}};if(actions&&actions.remove)remove=Object.assign(remove,actions.remove);return React.createElement(caladan_1.SimpleList,{rows:filteredRows,actions:{edit:edit,remove:remove},onReorder:disableReordering||!!searchString?null:this.onReorder.bind(this),onGroupRename:disableReordering||!groupField||!!searchString?null:this.onGroupRename.bind(this)})};ImmutableList.prototype.renderActions=function(){var getCustomActions=this.props.getCustomActions;if(getCustomActions){return React.createElement("div",{className:"actions"},getCustomActions(this.addItem.bind(this)))}return React.createElement("div",{className:"actions"},React.createElement(caladan_1.SearchButton,{onChange:this.onSearchChange.bind(this)}),React.createElement(caladan_1.Button,{type:"secondary",onClick:this.addItem.bind(this),title:"Add"}))};ImmutableList.prototype.render=function(){var _a=this.props,items=_a.items,label=_a.label,className=_a.className;var _b=this.state,editedIndex=_b.editedIndex,pendingAddItem=_b.pendingAddItem;if(!items)return null;return React.createElement("div",{className:classNames("immutable-list",className)},React.createElement("div",{className:"list-title"},React.createElement("div",{className:"label"},label),this.renderActions()),this.renderList(),editedIndex!=null?this.renderEditModal(editedIndex):null,pendingAddItem?this.renderAddModal(pendingAddItem):null)};return ImmutableList}(React.Component);exports.ImmutableList=ImmutableList;