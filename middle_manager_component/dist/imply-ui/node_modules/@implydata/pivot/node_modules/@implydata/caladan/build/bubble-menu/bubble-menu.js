"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var classNames=require("classnames");var React=require("react");var body_portal_1=require("../body-portal/body-portal");var global_event_listener_1=require("../global-event-listener/global-event-listener");var shpitz_1=require("../shpitz/shpitz");var OFFSET_H=10;var OFFSET_V=0;var SCREEN_OFFSET=5;var BubbleMenu=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.defaultId=beltful_1.DOMUtils.uniqueId("bubble-menu-");t.state={};return t}t.prototype.myId=function(){var e=this.props.id;return e||this.defaultId};t.prototype.updateCoordinates=function(e){if(!e)return;var t=e.alignOn,i=e.openOn,r=e.direction,n=e.align;if(!t&&!i||!r)return;var a=(t||i).getBoundingClientRect();var o;var l;switch(r){case"right":o=a.left+a.width-OFFSET_H;l=a.top+a.height/2;break;case"down":if(n==="center"){o=a.left+a.width/2}else if(n==="start"){o=a.left}else{o=a.left+a.width}l=a.top+a.height-OFFSET_V;break;default:throw new Error("unknown direction: '"+r+"'")}this.setState({x:o,y:l})};t.prototype.onPageScroll=function(){this.updateCoordinates(this.props)};t.prototype.componentDidMount=function(){this.updateCoordinates(this.props)};t.prototype.componentWillReceiveProps=function(e){this.updateCoordinates(e)};t.prototype.onClose=function(e){var t=this.props.onClose;if(t)t(e)};t.prototype.onClick=function(e){var t=this.props.openOn;var i=document.getElementById(this.myId());if(!i)return;var r=e.target;if(beltful_1.DOMUtils.isInside(r,i)||beltful_1.DOMUtils.isInside(r,t))return;this.onClose(e)};t.prototype.render=function(){var e=this.props,t=e.className,i=e.direction,r=e.stage,n=e.fixedSize,a=e.containerStage,o=e.insideId,l=e.layout,s=e.align,u=e.children;var d=this.state,h=d.x,c=d.y;if(isNaN(h)||isNaN(c))return null;var p=r.width;var f=r.height;var v=0;var b=0;var _={};if(n){_.width=p;_.height=f}var g={left:0,top:0};if(!a){a=new beltful_1.Stage({x:SCREEN_OFFSET,y:SCREEN_OFFSET,width:window.innerWidth-SCREEN_OFFSET*2,height:window.innerHeight-SCREEN_OFFSET*2})}switch(i){case"right":var y=c-f/2;y=Math.min(Math.max(y,a.y),a.y+a.height-f);v=h;b=y;g.top=c-y;_.height=f;break;case"down":var E=void 0;if(s==="center"){E=h-p/2}else if(s==="start"){E=h}else{E=h-p}E=Math.min(Math.max(E,a.x),a.x+a.width-p);v=E;b=c;g.left=h-E;_.width=p;break;default:throw new Error("unknown direction: '"+i+"'")}var m=null;if(s==="center"){m=React.createElement(shpitz_1.Shpitz,{style:g,direction:i})}var w=classNames("bubble-menu",i,t,{mini:l==="mini"});return React.createElement(body_portal_1.BodyPortal,{left:v,top:b},React.createElement("div",{className:w,"data-parent":o,style:_,id:this.myId()},React.createElement(global_event_listener_1.GlobalEventListener,{scroll:this.onPageScroll.bind(this),escape:this.onClose.bind(this),click:this.onClick.bind(this),useCaptureFor:["scroll","click"]}),u,m))};t.defaultProps={align:"center"};return t}(React.Component);exports.BubbleMenu=BubbleMenu;