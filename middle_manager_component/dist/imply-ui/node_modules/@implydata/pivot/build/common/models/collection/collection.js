"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var collection_tile_1=require("../collection-tile/collection-tile");var filter_1=require("../filter/filter");var theme_1=require("../theme/theme");var access_list_1=require("../access-list/access-list");var general_1=require("../../utils/general/general");var Collection=function(e){tslib_1.__extends(t,e);function t(i){var a=e.call(this,i)||this;a.tiles=t.fitTiles(a.tiles)||[];return a}t.isCollection=function(e){return e instanceof t};t.fitTiles=function(e){var i=e.map(function(e){return e.position}).filter(Boolean);var a=t.DEFAULT_TILE_SIZE.width+1;var n=0;function l(){return t.DEFAULT_TILE_SIZE.changeXY(n%a,Math.floor(n/a))}function r(){var e=l();while(i.some(function(t){return t.overlapsWith(e)})){n++;e=l()}i.push(e);return e}return e.map(function(e){return e.position?e:e.changePosition(r())})};t.fromJS=function(e,i){if(i===void 0){i={}}if(!e.name)throw new Error("Collection must have a name");var a=e.tiles||e.items||e.linkItems||[];return new t({title:e.title,name:e.name,description:e.description,theme:e.theme,readAccess:e.readAccess?access_list_1.AccessList.fromJS(e.readAccess):null,modifyAccess:e.modifyAccess?access_list_1.AccessList.fromJS(e.modifyAccess):null,shareTimezone:e.shareTimezone,enforceTimeFilter:e.enforceTimeFilter,tiles:a.map(function(e){return collection_tile_1.CollectionTile.fromJS(e,i)})})};t.prototype.isReady=function(){return this.tiles.every(function(e){return e.isReady()})};t.prototype.getDefaultTile=function(){return this.tiles[0]};t.prototype.isNameAvailable=function(e){return!this.getCollectionTile(e)};t.prototype.dependsOnDataCube=function(e){return this.tiles.some(function(t){return t.essence.dataCube===e})};t.prototype.getCommonDataCube=function(){var e=this,t=e.tiles,i=e.enforceTimeFilter,a=e.theme;t=t.filter(function(e){return e.isVisualization()&&e.getDataCube()});if(!t.length)return null;var n=t[0].getDataCube().changeEnforceTimeFilter(Boolean(i)).changeTheme(a);var l=[];var r={};var s={};for(var c=0,o=t;c<o.length;c++){var u=o[c];var m=u.getDataCube();if(s[m.name])continue;s[m.name]=true;var f=m.dimensions;for(var h=0,_=f;h<_.length;h++){var d=_[h];if(!r[d.name]){l.push(d);r[d.name]=true}}}return n.changeDimensions(l)};t.prototype.getDeltaSourceFilter=function(){var e=this,t=e.tiles,i=e.enforceTimeFilter;t=t.filter(function(e){return e.isVisualization()&&e.getDataCube()});if(i||!t.length)return null;return t[0].getDataCube().addMandatoryFiltersIfNeeded(filter_1.Filter.EMPTY)};t.prototype.makeDuplicate=function(e,t){return this.changeMany({name:e,title:this.title+" (copy)",modifyAccess:access_list_1.AccessList.onlyFor(t.name)})};t.prototype.getCollectionTile=function(e){return immutable_class_1.NamedArray.findByName(this.tiles,e)};t.prototype.getSummaries=function(){var e=this.tiles;if(!e.length)return["Empty dashboard"];var t=e.filter(function(e){return e.isVisualization()}).map(function(e){return e.essence.dataCube}).filter(function(e,t,i){return i.indexOf(e)===t});var i=t.length;return[i===1&&e[0].essence.actualDataCube?e[0].essence.actualDataCube.title:general_1.pluralIfNeeded(i,"data cube"),general_1.pluralIfNeeded(e.length,"visualization")]};t.prototype.addOrUpdateTile=function(e){return this.changeTiles(immutable_class_1.NamedArray.overrideByName(this.tiles,e))};t.prototype.deleteTile=function(e){return this.changeTiles(immutable_class_1.NamedArray.deleteByName(this.tiles,e))};t.prototype.duplicateTile=function(e){var t=this;var i=this.getCollectionTile(e);var a=beltful_1.StringUtils.generateAvailableName({isAvailable:function(e){return!t.getCollectionTile(e)}});return this.addOrUpdateTile(i.makeDuplicate(a))};t.prototype.constrainTilesToDataCubes=function(e){return this.changeTiles(this.tiles.filter(function(t){return!t.essence||immutable_class_1.NamedArray.containsByName(e,t.essence.dataCube)}))};t.prototype.getEffectiveTheme=function(e){return theme_1.Theme.getEffectiveTheme(this.theme||e)};t.prototype.getAvailableName=function(){var e=this;return beltful_1.StringUtils.generateAvailableName({isAvailable:function(t){return!e.getCollectionTile(t)}})};t.prototype.initAccess=function(e){return this.changeMany({readAccess:access_list_1.AccessList.ALL,modifyAccess:access_list_1.AccessList.fromJS({access:"single",users:[e.name]})})};t.DEFAULT_TILE_SIZE=beltful_1.Stage.fromSize(8,5);t.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"description",defaultValue:null},{name:"theme",defaultValue:theme_1.Theme.DEFAULT_NAME},{name:"readAccess",immutableClass:access_list_1.AccessList,defaultValue:access_list_1.AccessList.ALL},{name:"modifyAccess",immutableClass:access_list_1.AccessList,defaultValue:access_list_1.AccessList.ALL},{name:"verticalUnits",defaultValue:null},{name:"shareTimezone",defaultValue:false},{name:"enforceTimeFilter",defaultValue:false},{name:"tiles",immutableClassArray:collection_tile_1.CollectionTile}];return t}(immutable_class_1.BaseImmutable);exports.Collection=Collection;immutable_class_1.BaseImmutable.finalize(Collection);