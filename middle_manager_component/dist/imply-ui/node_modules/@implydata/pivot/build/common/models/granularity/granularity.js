"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var beltful_1=require("@implydata/beltful");var chronoshift_1=require("chronoshift");var hasOwnProperty=require("has-own-prop");var immutable_class_2=require("immutable-class");var plywood_1=require("plywood");function convertStringNumberToNumber(e){if(typeof e==="string"&&!isNaN(Number(e)))return parseFloat(e);return e}function days(e){return e*chronoshift_1.day.canonicalLength}function hours(e){return e*chronoshift_1.hour.canonicalLength}function minutes(e){return e*chronoshift_1.minute.canonicalLength}function years(e){return e*chronoshift_1.year.canonicalLength}var Granularity=function(e){tslib_1.__extends(r,e);function r(r){if(r===void 0){r={}}return e.call(this,r)||this}r.fromExpression=function(e){return new r({expression:e})};r.fromJS=function(e){var t=convertStringNumberToNumber(e);if(typeof t==="number")return r.fromExpression(plywood_1.Expression._.numberBucket(t));if(typeof t==="string"){return r.fromExpression(plywood_1.Expression._.timeBucket(chronoshift_1.Duration.fromJS(t)))}else if(typeof t==="object"){if(!hasOwnProperty(t,"action")&&!hasOwnProperty(t,"op")){throw new Error("could not recognize object as action, "+t+", "+typeof t)}var n=plywood_1.Expression.fromJS(t);return r.fromExpression(n)}throw new Error("input should be of type number, string, or expression")};r.getGranularities=function(e,t,n,i){if(n)return n;if(e==="time"){var o=["PT1M","PT5M","PT1H","P1D","P1W"];var u=["PT1M","PT5M","PT1H","PT6H","PT12H","P1D","P1W","P1M","P6M"];var s=t===9?u:o;return s.map(function(e){return r.fromJS(e)})}else{var a=i?i.calculateBucketSize():1;var l=[];var f=Math.log(a)/Math.LN10;var p=beltful_1.NumberUtils.getNumberOfWholeDigits(a);while(l.length<=t){var m=beltful_1.NumberUtils.toSignificantDigits(5*Math.pow(10,f-1),p);if(t===9)l.push(m);if(l.length>=t)break;var c=beltful_1.NumberUtils.toSignificantDigits(Math.pow(10,f),p);l.push(c);f++}return l.map(r.fromJS)}};r.getRangeLength=function(e){if(plywood_1.TimeRange.isTimeRange(e)){return Math.abs(e.end.valueOf()-e.start.valueOf())}else if(plywood_1.NumberRange.isNumberRange(e)){return Math.abs(e.end-e.start)}throw new Error("Unsupported range type: "+e.toString())};r.prototype.toString=function(){var e=this.expression;if(!e)return"None";if(e.op==="timeBucket"){return e.duration.toString()}else if(e.op==="numberBucket"){return e.size.toString()}return e.toString()};r.prototype.toJS=function(){var e=this.expression;if(!e)return null;if(e.op==="timeBucket"&&!e.timezone){return e.duration.toString()}else if(e.op==="numberBucket"&&!e.offset){return e.size}return e.toJS()};r.prototype.equalsExpression=function(e){return immutable_class_2.immutableEqual(this.expression,e)};r.prototype.getDefaultGranularity=function(e,t){var n=this.expression;if(n)return this;if(t)return t[2];if(e==="number"){return r.fromJS(1)}else if(e==="time"){return r.fromJS("P1D")}throw new Error("Unsupported kind "+e)};r.prototype.getRecommendedDuration=function(e){var t=r.getRangeLength(e);var n=this.calculateBucketSize();if(t>days(95)||n>days(95))return"P1W";if(t>days(8)||n>days(8))return"P1D";if(t>hours(8)||n>hours(8))return"PT1H";if(t>hours(3)||n>hours(3))return"PT5M";return"PT1M"};r.prototype.getRecommendedDurationCoarse=function(e){var t=r.getRangeLength(e);var n=this.calculateBucketSize();if(t>years(2)||n>years(2))return"P6M";if(t>days(95)||n>days(95))return"P1M";if(t>days(20)||n>days(20))return"P1W";if(t>days(6)||n>days(6))return"P1D";if(t>days(2)||n>days(2))return"PT12H";if(t>hours(23)||n>hours(23))return"PT6H";if(t>hours(3)||n>hours(3))return"PT1H";if(t>minutes(30)||n>minutes(30))return"PT5M";return"PT1M"};r.prototype.getRecommendedNumber=function(e){var t=r.getRangeLength(e);var n=this.calculateBucketSize();if(t>5e3||n>5e3)return 1e3;if(t>500||n>500)return 100;if(t>100||n>100)return 10;if(t>1||n>1)return 1;return.1};r.prototype.getIdealNonCoarse=function(e){if(plywood_1.TimeRange.isTimeRange(e)){return r.fromJS(this.getRecommendedDuration(e))}else if(plywood_1.NumberRange.isNumberRange(e)){return r.fromJS(this.getRecommendedNumber(e))}throw new Error("Unsupported range type: "+e.toString())};r.prototype.getIdealCoarse=function(e){if(plywood_1.TimeRange.isTimeRange(e)){return r.fromJS(this.getRecommendedDurationCoarse(e))}else if(plywood_1.NumberRange.isNumberRange(e)){return r.fromJS(this.getRecommendedNumber(e))}throw new Error("Unsupported range type: "+e.toString())};r.prototype.getRecommendationForRange=function(e,t,n){var i=this.expression;var o=t===5?this.getIdealNonCoarse(e):this.getIdealCoarse(e);if(!i&&!n)return o;var u=plywood_1.TimeRange.isTimeRange(e)?"time":"number";var s=r.getGranularities(u,t,n);var a=beltful_1.ArrayUtils.findBiggerClosestToIdeal(s,this||o,o,function(e){return e.calculateBucketSize()});return a||this.getDefaultGranularity(u,n)};r.prototype.updateBucketSize=function(e){if(!e)return this.changeExpression(null);if(e.op==="numberBucket"){e=plywood_1.Expression._.numberBucket(e.size,this.expression.offset);return this.changeExpression(e)}else if(e.op==="timeBucket"){e=plywood_1.Expression._.timeBucket(e.duration,this.expression.timezone)}else{throw new Error("Unsupported expression op: "+e.op)}return this.changeExpression(e)};r.prototype.calculateBucketSize=function(){var e=this.expression;if(!e)return 0;if(e.op==="timeBucket"){return e.duration.getCanonicalLength()}else if(e.op==="numberBucket"){return e.size}throw new Error("Unsupported expression op: "+e.op)};r.PROPERTIES=[{name:"title",defaultValue:null},{name:"expression",immutableClass:plywood_1.Expression,defaultValue:null}];return r}(immutable_class_1.BaseImmutable);exports.Granularity=Granularity;immutable_class_1.BaseImmutable.finalize(Granularity);Granularity.NONE=new Granularity({expression:null});