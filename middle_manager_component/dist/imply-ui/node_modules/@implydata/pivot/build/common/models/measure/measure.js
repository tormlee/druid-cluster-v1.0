"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var numeral=require("numeral");var plywood_1=require("plywood");function formatFnFactory(e){return function(t){if(isNaN(t)||!isFinite(t))return"-";return numeral(t).format(e)}}var Measure=function(e){tslib_1.__extends(t,e);function t(t){var n=e.call(this,t)||this;n.title=n.title||beltful_1.StringUtils.makeTitle(n.name);n.expression=plywood_1.Expression.parse(n.formula);n.formatFn=formatFnFactory(n.getFormat());n.companionExpression=n.companion?plywood_1.Expression.parse(n.companion):null;return n}t.isMeasure=function(e){return e instanceof t};t.getMeasure=function(e,t){if(!t)return null;return immutable_class_1.NamedArray.findByNameCI(e,t)};t.measuresFromAttribute=function(e){var n=e.name,r=e.type,a=e.nativeType,i=e.maker;var l=plywood_1.$("main");var o=plywood_1.$(n);if(n==="count"||i&&i.op==="count"){return[new t({name:beltful_1.StringUtils.makeUrlSafeName(n),title:beltful_1.StringUtils.makeTitle(n),formula:l.sum(o).toString()})]}else if(a==="hyperUnique"||a==="thetaSketch"){return[new t({name:beltful_1.StringUtils.makeUrlSafeName("cd_"+n),title:beltful_1.StringUtils.makeTitle(n)+(a==="thetaSketch"?" Unique":""),formula:l.countDistinct(o).toString()})]}else if(a==="approximateHistogram"){return[new t({name:beltful_1.StringUtils.makeUrlSafeName(n+"_p98"),title:beltful_1.StringUtils.makeTitle(n)+" 98th %tile",formula:l.quantile(o,.98).toString()})]}else if(r==="NUMBER"){var u=l.sum(o);var s="sum";if(i){s=i.op;switch(i.op){case"min":u=l.min(o);break;case"max":u=l.max(o);break}}return[new t({name:beltful_1.StringUtils.makeUrlSafeName(s+"_"+n),title:s==="sum"?beltful_1.StringUtils.makeTitle(n):null,formula:u.toString()})]}else{return[]}};t.fromJS=function(e){if(!e.formula){var n=e.expression;e.formula=typeof n==="string"?n:plywood_1.$("main").sum(plywood_1.$(e.name)).toString()}return new t(immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e))};t.prototype.toApplyAction=function(e){var t=this,n=t.name,r=t.expression,a=t.transform;var i="_"+n;var l;switch(a){case"percent-of-parent":l=plywood_1.Expression._.apply(i,r);if(e>0){l=l.apply(n,plywood_1.$(i).divide(plywood_1.$(i,1)).multiply(100))}else{}break;case"percent-of-root":l=plywood_1.Expression._.apply(i,r);if(e>0){l=l.apply(n,plywood_1.$(i).divide(plywood_1.$(i,e)).multiply(100))}else{l=l.apply(n,100)}break;default:l=plywood_1.Expression._.apply(n,r);var o=this.companionExpression;if(o){l=l.apply(this.getCompanionName(),o)}break}return l};t.prototype.toInvisibleRootApplyAction=function(){if(this.getTransform()==="none")return null;var e=this,t=e.name,n=e.expression;var r="_"+t;return plywood_1.Expression._.apply(r,n)};t.prototype.formatDatum=function(e){return e?this.formatFn(e[this.name]):null};t.prototype.formatCompanion=function(e){var t=this.getCompanionName();return e&&t?this.formatFn(e[t]):null};t.prototype.formatDatumWithCompanion=function(e){var t=this.formatDatum(e);if(!t)return null;var n=this.formatCompanion(e);return t+(n?" ("+n+")":"")};t.prototype.getCompanionName=function(){return this.companion?this.name+"_c":null};t.prototype.getTitleWithUnits=function(){if(this.units){return this.title+" ("+this.units+")"}else{return this.title}};t.prototype.usesAttribute=function(e){return this.expression.some(function(t,n,r,a){if(a>0&&t instanceof plywood_1.RefExpression){return t.name===e}else{return null}})};t.prototype.guessName=function(){return this.formula.replace(/main/g,"").replace(/\W/g,"").substr(0,7)||"met"};t.prototype.guessTitle=function(){return beltful_1.StringUtils.makeTitle(this.name)};t.TRANSFORM_VALUES=["none","percent-of-parent","percent-of-root"];t.DEFAULT_TRANSFORM="none";t.DEFAULT_FORMAT="0,0.0 a";t.INTEGER_FORMAT="0,0 a";t.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"group",defaultValue:null},{name:"units",defaultValue:null},{name:"formula"},{name:"transform",defaultValue:t.DEFAULT_TRANSFORM,possibleValues:t.TRANSFORM_VALUES},{name:"format",defaultValue:t.DEFAULT_FORMAT},{name:"companion",defaultValue:null}];return t}(immutable_class_1.BaseImmutable);exports.Measure=Measure;immutable_class_1.BaseImmutable.finalize(Measure);Measure.SIMPLE_COUNT=new Measure({name:"default_count",title:"Default Count",formula:"$main.count()"});