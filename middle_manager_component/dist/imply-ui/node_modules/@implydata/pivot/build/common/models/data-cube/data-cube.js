"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var chronoshift_1=require("chronoshift");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var dimension_1=require("../dimension/dimension");var filter_clause_1=require("../filter-clause/filter-clause");var filter_1=require("../filter/filter");var measure_1=require("../measure/measure");var splits_1=require("../splits/splits");var instances_1=require("../instances/instances");var theme_1=require("../theme/theme");var access_list_1=require("../access-list/access-list");var general_1=require("../../utils/general/general");function formatTimeDiff(e){e=Math.round(Math.abs(e)/1e3);if(e<60)return"less than 1 minute";e=Math.floor(e/60);if(e===1)return"1 minute";if(e<60)return e+" minutes";e=Math.floor(e/60);if(e===1)return"1 hour";if(e<=24)return e+" hours";e=Math.floor(e/24);return e+" days"}function checkUnique(e,t,r){var i={};var n={};if(e){e.forEach(function(e){var t=e.name.toLowerCase();if(i[t]){throw new Error("duplicate dimension name '"+e.name+"' found in data cube: '"+r+"'")}i[t]=e})}if(t){t.forEach(function(e){var t=e.name.toLowerCase();if(n[t]){throw new Error("duplicate measure name '"+e.name+"' found in data cube: '"+r+"'")}if(i[t]){throw new Error("name '"+e.name+"' found in both dimensions and measures in data cube: '"+r+"'")}n[t]=e})}}var INTERESTING_NATIVE_TYPE={__time:true,approximateHistogram:true,hyperUnique:true,thetaSketch:true};function measuresFromLongForm(e){var t=e.metricColumn,r=e.measures,i=e.possibleAggregates;var n={};for(var s in i){if(!hasOwnProperty(i,s))continue;n[s]=plywood_1.Expression.fromJSLoose(i[s])}return r.map(function(e){if(hasOwnProperty(e,"name")){return measure_1.Measure.fromJS(e)}var r=e.title;if(!r){throw new Error("must have title in longForm value")}var i=e.value;var s=e.aggregate;if(!s){throw new Error("must have aggregates in longForm value")}var a=n[s];if(!a)throw new Error("can not find aggregate "+s+" for value "+i);var u=beltful_1.StringUtils.makeUrlSafeName(s+"_"+i);return new measure_1.Measure({name:u,title:r,units:e.units,formula:a.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name==="filtered"){return plywood_1.$("main").filter(plywood_1.$(t).is(plywood_1.r(i)))}return null}).toString()})})}function filterFromLongForm(e){var t=e.metricColumn,r=e.measures;var i=[];for(var n=0,s=r;n<s.length;n++){var a=s[n];if(hasOwnProperty(a,"aggregate"))i.push(a.value)}return plywood_1.$(t).in(i).simplify()}var DataCube=function(e){tslib_1.__extends(t,e);function t(t){var r=e.call(this,t)||this;var i=r,n=i.name,s=i.dimensions,a=i.measures;if(typeof n!=="string")throw new Error("Data cube must have a name");if(!r.source)r.source=n;r.subsetExpression=t.subsetFormula?plywood_1.Expression.fromJSLoose(t.subsetFormula):plywood_1.Expression.TRUE;checkUnique(s,a,n);return r}t.isDataCube=function(e){return e instanceof t};t.getPossibleTimeDimension=function(e){for(var r=0,i=e;r<i.length;r++){var n=i[r];if(n.expression.equals(plywood_1.$("__time")))return n.name}for(var s=0,a=e;s<a.length;s++){var n=a[s];if(n.type==="TIME")return n.name}return t.NO_SPECIAL_TIME_DIMENSION};t.putSpecialTimeOnTop=function(e){var t=immutable_class_1.NamedArray.findByName(e,"__time");if(!t)return e;return[t].concat(e.filter(function(e){return e.name!=="__time"}))};t.suggestDimensions=function(e){return t.putSpecialTimeOnTop(e).map(function(e){if(e.name==="count"||e.unsplitable)return null;var t=e.name,r=e.type;return new dimension_1.Dimension({name:beltful_1.StringUtils.makeUrlSafeName(t),type:r||"STRING",formula:plywood_1.$(t).toString()})}).filter(Boolean)};t.suggestMeasures=function(e){if(!e)return[];var t=[];var r=false;for(var i=0,n=e;i<n.length;i++){var s=n[i];var a=measure_1.Measure.measuresFromAttribute(s);a.forEach(function(e){if(e.name==="count"||e.name==="sum_count"){r=true;t.unshift(e)}else{t.push(e)}})}if(!r){t.unshift(new measure_1.Measure({name:"count",title:"Number of Events",formula:"$main.count()"}))}return t};t.fromClusterAndSource=function(e,r,i){return t.fromJS({name:e,title:beltful_1.StringUtils.makeTitle(i),clusterName:r.name,source:i})};t.fromJS=function(e){var r=e.clusterName||e.engine;var i=e.refreshTimeWith;var n=e.options;var s=e.dimensions||[];var a=s.filter(function(e){return e.unsplitable}).map(function(e){var t={name:e.name,type:"NUMBER",maker:e.maker,unsplitable:true};if(e.special){t.special=e.special;t.type="NULL"}return plywood_1.AttributeInfo.fromJS(t)});var u=s.filter(function(e){return!e.unsplitable}).map(function(e){return dimension_1.Dimension.fromJS(e)});var o=(e.measures||[]).map(function(e){return measure_1.Measure.fromJS(e)});var l=e.attributes||a;l.forEach(function(e){if(e.type==="STRING"&&e.unsplitable&&!e.nativeType){e.type=e.special?"NULL":"NUMBER"}});var m=plywood_1.AttributeInfo.fromJSs(l);var f=e.attributeOverrides||(e.options||{}).attributeOverrides;if(f){m=plywood_1.AttributeInfo.override(m,plywood_1.AttributeInfo.fromJSs(f));if((e.options||{}).attributeOverrides){delete e.options["attributeOverrides"]}}var c=e.specialTimeDimension||e.specialTimeAttribute||e.realTimeAttribute||e.primaryTimeAttribute;if(!c&&e.timeAttribute&&e.timeAttribute!=="__time"){c=e.timeAttribute;if(!n)n={};n.druidTimeAttributeName=c}if(!c){var p=u[0];if(p&&p.name==="__time"&&p.type!=="TIME"){u[0]=p.changeType("TIME")}c=t.getPossibleTimeDimension(u)}if(!i&&e.refreshRule){i=e.refreshRule.rule==="query"?"query":"predefined";if(e.refreshRule.time){if(!n)n={};n.fixedMaxTime=e.refreshRule.time}}var d=e.enforceTimeFilter;if(typeof d==="undefined"){d=c!==t.NO_SPECIAL_TIME_DIMENSION}var _=e.subsetFormula||e.subsetFilter;var h=e.longForm;if(h){o=o.concat(measuresFromLongForm(h));if(h.addSubsetFilter){var y=_?plywood_1.Expression.fromJSLoose(e.subsetFormula):plywood_1.Expression.TRUE;_=JSON.stringify(y.and(filterFromLongForm(h)).simplify())}}var g={name:e.name,title:e.title,description:e.description,clusterName:r,source:e.source,group:e.group,theme:e.theme,subsetFormula:_,rollup:e.rollup,options:n,readAccess:e.readAccess?access_list_1.AccessList.fromJS(e.readAccess):null,modifyAccess:e.modifyAccess?access_list_1.AccessList.fromJS(e.modifyAccess):null,attributes:m,dimensions:u,measures:o,instances:e.instances?instances_1.Instances.fromJS(e.instances):null,specialTimeDimension:c,enforceTimeFilter:d,defaultTimezone:e.defaultTimezone?chronoshift_1.Timezone.fromJS(e.defaultTimezone):null,defaultFilter:e.defaultFilter?filter_1.Filter.fromJS(e.defaultFilter):null,defaultSplits:e.defaultSplits?splits_1.Splits.fromJS(e.defaultSplits):null,defaultDuration:e.defaultDuration?chronoshift_1.Duration.fromJS(e.defaultDuration):null,defaultSortMeasure:e.defaultSortMeasure,defaultSelectedMeasures:e.defaultSelectedMeasures,defaultPinnedDimensions:e.defaultPinnedDimensions,defaultRefreshRate:e.defaultRefreshRate?chronoshift_1.Duration.fromJS(e.defaultRefreshRate):null,refreshTimeWith:i};return new t(g)};t.prototype.toExternal=function(e,t,r){if(this.clusterName==="native")throw new Error("there is no external on a native data cube");var i=this.getOptions();var n=e.type;var s=this.subsetExpression;if(this.instances){s=s.and(this.instances.getFilterFor(t))}var a=this.getEffectiveAttributesAndDerivedAttributes();var u={engine:n,suppress:true,source:this.source,version:e.version,customAggregations:i.customAggregations,customTransforms:i.customTransforms,attributes:a.attributes,derivedAttributes:a.derivedAttributes,filter:s};if(r){u.requester=r}if(n==="druid"||n==="druidsql"){u.rollup=this.rollup;u.introspectionStrategy=e.getIntrospectionStrategy();u.allowSelectQueries=true;u.allowEternity=!this.hasMandatoryTimeFilter();u.exactResultsOnly=Boolean(i.exactResultsOnly);if(i.druidTimeAttributeName){u.timeAttribute=i.druidTimeAttributeName}var o=i.druidContext||{};o["timeout"]=e.getTimeout();if(i.priority)o["priority"]=i.priority;u.context=o}return plywood_1.External.fromValue(u)};t.prototype.validateFilterFormula=function(e){var t=plywood_1.Expression.parse(e);if(t instanceof plywood_1.LiteralExpression){if(t.type==="BOOLEAN")return true;throw new Error("must be a boolean")}return true};t.prototype.validateMeasureFormula=function(e){var t=plywood_1.Expression.parse(e);if(!t.getFreeReferences().includes("main")){throw new Error("Measure formula must contain a $main reference")}return true};t.prototype.getClusterType=function(e){var t=this.clusterName;if(t==="native")return"native";if(!e)return null;return e[t]||null};t.prototype.getMaxTimeQuery=function(){if(this.getRefreshTimeWith()!=="query")return null;var e=this.getSpecialTimeDimensionObject();if(!e)return null;return plywood_1.$("main").max(e.expression)};t.prototype.getMaxTime=function(e){var t=this.name;var r=this.getRefreshTimeWith();if(r==="query"){return e.getTime(t)}else{return new Date(this.getOptions().fixedMaxTime||e.now())}};t.prototype.updatedText=function(e,t){var r=this.getRefreshTimeWith();if(r==="query"){var i=this.getMaxTime(e);if(i){return"Updated "+formatTimeDiff(e.now().valueOf()-i.valueOf().valueOf())+" ago"}else{return null}}else{var n=this.getOptions().fixedMaxTime;if(n){return"Fixed to "+beltful_1.DateUtils.getWallTimeString(new Date(n),t,true)}else{return"Updated ~1 second ago"}}};t.prototype.getSuggestedDimensions=function(e){return this.filterDimensions(t.suggestDimensions(e))};t.prototype.getSpecialTimeDimensionObject=function(){var e=this.specialTimeDimension;if(e===t.NO_SPECIAL_TIME_DIMENSION)return null;var r=immutable_class_1.NamedArray.findByName(this.dimensions,e);if(!r||r.type!=="TIME")return null;return r};t.prototype.isSpecialTimeDimension=function(e){var t=this.getSpecialTimeDimensionObject();if(!e||!t)return false;return t.name===e};t.prototype.isMandatoryTimeFilter=function(e){return this.enforceTimeFilter&&this.isSpecialTimeDimension(e)};t.prototype.hasMandatoryTimeFilter=function(){return this.enforceTimeFilter&&Boolean(this.getSpecialTimeDimensionObject())};t.prototype.getMeasures=function(){if(this.measures.length)return this.measures;return[measure_1.Measure.SIMPLE_COUNT]};t.prototype.getMeasure=function(e){return measure_1.Measure.getMeasure(this.getMeasures(),e)};t.prototype.getMeasureByExpression=function(e){return immutable_class_1.SimpleArray.find(this.getMeasures(),function(t){return t.expression.equals(e)})};t.prototype.getSuggestedMeasures=function(e){return this.filterMeasures(t.suggestMeasures(e))};t.prototype.filterMeasures=function(e){var t=this;return e.filter(function(e){if(immutable_class_1.NamedArray.findByName(t.measures,e.name))return false;if(immutable_class_1.NamedArray.findByName(t.dimensions,e.name))return false;var r=e.expression;if(immutable_class_1.SimpleArray.find(t.measures,function(e){return e.expression.equals(r)}))return false;return true})};t.prototype.removeDimension=function(e){var r=this.valueOf();r.dimensions=immutable_class_1.NamedArray.deleteByName(r.dimensions,e);r.measures=r.measures.filter(function(t){return!t.usesAttribute(e)});return new t(r)};t.prototype.removeMeasure=function(e){var t=this.measures.indexOf(e);if(t===-1){throw new Error("Unknown measure: "+e.toString())}var r=immutable_class_1.SimpleArray.deleteIndex(this.measures,t);return this.changeMeasures(r)};t.prototype.filterDimensions=function(e){var t=this,r=t.dimensions,i=t.measures;return e.filter(function(e){if(immutable_class_1.NamedArray.findByName(r,e.name))return false;if(immutable_class_1.NamedArray.findByName(i,e.name))return false;return true})};t.prototype.getEffectiveAttributes=function(){return this.getEffectiveAttributesAndDerivedAttributes().attributes};t.prototype.getEffectiveAttributesAndDerivedAttributes=function(){var e=this.attributes.slice();var t={};var r={};e.forEach(function(e){return t[e.name]=true});function i(r){if(t[r.name])return;e.push(r);t[r.name]=true}function n(e,t){e.forEach(function(e){if(e instanceof plywood_1.RefExpression){if(t&&e.name==="main")return;i(plywood_1.AttributeInfo.fromJS({name:e.name,type:e.type||"NULL"}))}})}this.dimensions.forEach(function(e){return n(e.expression)});this.measures.forEach(function(e){return n(e.expression,true)});n(this.subsetExpression);if(this.instances)n(this.instances.expression);return{attributes:e,derivedAttributes:r}};t.prototype.changeDimension=function(e){return this.changeDimensions(immutable_class_1.NamedArray.overrideByName(this.dimensions,e))};t.prototype.fillAllFromAttributes=function(e){var t=e.filter(function(e){return INTERESTING_NATIVE_TYPE[e.nativeType]});return this.appendAttributes(t).appendDimensions(this.getSuggestedDimensions(e)).appendMeasures(this.getSuggestedMeasures(e)).adoptSpecialTimeDimensionIfPossible()};t.prototype.addMandatoryFiltersIfNeeded=function(e){var t=this.getSpecialTimeDimensionObject();if(this.enforceTimeFilter&&t&&!e.filteredOn(t.name)){e=e.setDynamic(t.name,plywood_1.$(filter_clause_1.FilterClause.MAX_TIME_REF_NAME).timeRange(this.getDefaultDuration(),-1))}return e};t.prototype.getDefaultSortMeasure=function(){var e=this.defaultSortMeasure;if(e){return(this.getMeasure(e)||this.getMeasures()[0]).name}return this.getMeasures()[0].name};t.prototype.getDefaultSelectedMeasures=function(){var e=this.defaultSelectedMeasures;return e.length?e:this.measures.slice(0,4).map(function(e){return e.name})};t.prototype.makeDuplicate=function(e,t){return this.changeMany({name:e,title:this.title+" (copy)",modifyAccess:access_list_1.AccessList.onlyFor(t.name)})};t.prototype.adoptSpecialTimeDimensionIfPossible=function(){var e=this.getSpecialTimeDimensionObject();if(e)return this;var r=t.getPossibleTimeDimension(this.dimensions);if(r===t.NO_SPECIAL_TIME_DIMENSION)return this;var i=this.changeSpecialTimeDimension(r);if(r==="__time"){i=i.changeEnforceTimeFilter(true)}return i};t.prototype.appendAttributes=function(e){return this.changeAttributes(plywood_1.AttributeInfo.override(this.attributes,e))};t.prototype.appendMeasures=function(e){return this.changeMeasures(this.measures.concat(e))};t.prototype.appendDimensions=function(e){return this.changeDimensions(this.dimensions.concat(e))};t.prototype.sameGroup=function(e){return Boolean(this.group&&this.group===e.group)};t.prototype.guessTitle=function(){if(!this.source)return this.title;var e=this.source.split(/[\/\\]/);var t=e[e.length-1];return beltful_1.StringUtils.makeTitle(t)};t.prototype.getLatitudeLongitudeDimensions=function(){var e=this.dimensions;var r=immutable_class_1.NamedArray.findByName(e,t.LATITUDE_NAME);var i=immutable_class_1.NamedArray.findByName(e,t.LONGITUDE_NAME);return r&&i?{latitude:r,longitude:i}:null};t.prototype.straightenDimensionName=function(e){var t=this.dimensions;e=e.changeName(beltful_1.StringUtils.generateAvailableName({prefix:e.guessName(),minTokens:3,isAvailable:function(e){return!immutable_class_1.NamedArray.findByName(t,e)},separator:"-"}));if(e.title==="New dimension")e=e.changeTitle(e.guessTitle());return e};t.prototype.straightenMeasureName=function(e){var t=this;e=e.changeName(beltful_1.StringUtils.generateAvailableName({prefix:e.guessName(),minTokens:3,isAvailable:function(e){return!t.getMeasure(e)},allowRawPrefix:false,separator:"-"}));if(e.title==="New measure")e=e.changeTitle(e.guessTitle());return e};t.prototype.getSummaries=function(){return[this.source,general_1.pluralIfNeeded(this.dimensions.length,"dimension"),general_1.pluralIfNeeded(this.measures.length,"measure")]};t.prototype.getDefaultInstance=function(){var e=this.instances;return e?e.getDefaultValue():null};t.prototype.initAccess=function(e){return this.changeMany({readAccess:access_list_1.AccessList.ALL,modifyAccess:access_list_1.AccessList.fromJS({access:"single",users:[e.name]})})};t.prototype.refreshNeeded=function(e){if(!this.getMaxTimeQuery())return false;var t=new Date(Date.now()-this.getDefaultRefreshRate().getCanonicalLength());return!e.hasUpdatedSince(this.name,t)};t.DEFAULT_DEFAULT_TIMEZONE=chronoshift_1.Timezone.UTC;t.DEFAULT_DEFAULT_FILTER=filter_1.Filter.EMPTY;t.DEFAULT_DEFAULT_SPLITS=splits_1.Splits.EMPTY;t.DEFAULT_DEFAULT_DURATION=chronoshift_1.Duration.fromJS("P1D");t.DEFAULT_REFRESH_TIME_WITH="query";t.REFRESH_TIME_WITH_VALUES=["query","predefined"];t.DEFAULT_DEFAULT_REFRESH_RATE=chronoshift_1.Duration.fromJS("PT5M");t.NO_SPECIAL_TIME_DIMENSION="!NONE";t.LATITUDE_NAME="lat";t.LONGITUDE_NAME="lon";t.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"description",defaultValue:""},{name:"clusterName",defaultValue:null},{name:"source",defaultValue:null},{name:"group",defaultValue:null},{name:"theme",defaultValue:theme_1.Theme.DEFAULT_NAME},{name:"subsetFormula",defaultValue:null},{name:"rollup",defaultValue:false},{name:"complete",defaultValue:false},{name:"options",defaultValue:{},equal:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{name:"readAccess",immutableClass:access_list_1.AccessList,defaultValue:access_list_1.AccessList.ALL},{name:"modifyAccess",immutableClass:access_list_1.AccessList,defaultValue:access_list_1.AccessList.ALL},{name:"attributes",immutableClassArray:plywood_1.AttributeInfo,type:immutable_class_1.PropertyType.ARRAY},{name:"dimensions",immutableClassArray:dimension_1.Dimension,type:immutable_class_1.PropertyType.ARRAY},{name:"measures",immutableClassArray:measure_1.Measure,type:immutable_class_1.PropertyType.ARRAY},{name:"instances",defaultValue:null,immutableClass:instances_1.Instances},{name:"specialTimeDimension"},{name:"enforceTimeFilter"},{name:"defaultTimezone",immutableClass:chronoshift_1.Timezone,defaultValue:t.DEFAULT_DEFAULT_TIMEZONE},{name:"defaultFilter",immutableClass:filter_1.Filter,defaultValue:t.DEFAULT_DEFAULT_FILTER},{name:"defaultSplits",immutableClass:splits_1.Splits,defaultValue:t.DEFAULT_DEFAULT_SPLITS},{name:"defaultDuration",immutableClass:chronoshift_1.Duration,defaultValue:t.DEFAULT_DEFAULT_DURATION},{name:"defaultSortMeasure",defaultValue:null},{name:"defaultSelectedMeasures",type:immutable_class_1.PropertyType.ARRAY},{name:"defaultPinnedDimensions",type:immutable_class_1.PropertyType.ARRAY},{name:"defaultRefreshRate",defaultValue:t.DEFAULT_DEFAULT_REFRESH_RATE},{name:"refreshTimeWith",possibleValues:t.REFRESH_TIME_WITH_VALUES,defaultValue:t.DEFAULT_REFRESH_TIME_WITH}];return t}(immutable_class_1.BaseImmutable);exports.DataCube=DataCube;immutable_class_1.BaseImmutable.finalize(DataCube);