"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var strings_1=require("../strings");function toSet(e){return e instanceof plywood_1.Set?e:plywood_1.Set.fromJS([e])}function addOneMs(e){return new Date(e.valueOf()+1)}var FilterClause=function(e){tslib_1.__extends(n,e);function n(n){var t=e.call(this,n)||this;var a=Number(Boolean(t.values))+Number(Boolean(t.dynamic))+Number(Boolean(t.search));if(a!==1)throw new Error("must have exactly one of 'values', 'dynamic', and 'search'");if((t.action==="match"||t.action==="contains")!==Boolean(t.search)){throw new Error("match / contains must go with search")}return t}n.isFilterClause=function(e){return e instanceof n};n.evaluate=function(e,t,a,r){if(!e)return null;var i=e.getLiteralValue();if(i instanceof plywood_1.Set){return i.extent()}var s=chronoshift_1.minute.ceil(a?addOneMs(a):t,r);var o={};o[n.NOW_REF_NAME]=t;o[n.MAX_TIME_REF_NAME]=s;return e.defineEnvironment({timezone:r}).getFn()(o)};n.fromExpression=function(e){var t=false;if(e instanceof plywood_1.NotExpression){e=e.operand;t=true}var a;if(e instanceof plywood_1.ChainableExpression){if(e.operand instanceof plywood_1.RefExpression){a=e.operand.name}else{throw new Error("must be a ref "+e.operand)}}else{throw new Error("must be a chainable expression "+e)}if(e instanceof plywood_1.InExpression||e instanceof plywood_1.OverlapExpression){var r=e.expression;var i=r.getLiteralValue();var s=e.op;return new n({action:s==="in"?"overlap":s,dimension:a,values:i?toSet(i):null,dynamic:i?null:r,exclude:t})}if(e instanceof plywood_1.ContainsExpression){return new n({action:"contains",dimension:a,search:e.expression.getLiteralValue(),exclude:t})}if(e instanceof plywood_1.MatchExpression){return new n({action:"match",dimension:a,search:e.regexp,exclude:t})}throw new Error("invalid expression "+e.toString())};n.fromSingleValue=function(e,t){return new n({dimension:e,values:plywood_1.Set.fromJS([t])})};n.fromJS=function(e){return new n(immutable_class_1.BaseImmutable.jsToValue(n.PROPERTIES,e))};n.prototype.toString=function(){return"[FilterClause: "+this.dimension+"]"};n.prototype.changeValues=function(e){var t=this.valueOf();t.values=e;delete t.dynamic;delete t.search;return new n(t)};n.prototype.changeDynamic=function(e){var t=this.valueOf();delete t.values;t.dynamic=e;delete t.search;return new n(t)};n.prototype.changeSearch=function(e){var t=this.valueOf();delete t.values;delete t.dynamic;t.search=e;return new n(t)};n.prototype.toExpression=function(e){var n=this,t=n.dimension,a=n.action,r=n.values,i=n.dynamic,s=n.search;var o=immutable_class_1.NamedArray.findByName(e,t);if(!o)throw new Error("filter clause on unknown dimension '"+t+"'");var l=o.expression;var u=null;if(r||i){u=l.overlap(r||i)}else if(a==="contains"){u=l.contains(plywood_1.r(s),"ignoreCase")}else if(a==="match"){u=l.match(s)}else{throw new Error("should never get here")}if(this.exclude)u=u.not();return u};n.prototype.getLiteralSet=function(){return this.values};n.prototype.getExtent=function(){var e=this.values;return e?e.extent():null};n.prototype.isLessThanFullDay=function(){var e=this.getExtent();if(!e)return false;return e.end.valueOf()-e.start.valueOf()<chronoshift_1.day.canonicalLength};n.prototype.evaluate=function(e,t,a){var r=this.dynamic;if(!r)return this;return this.changeValues(toSet(n.evaluate(r,e,t,a)))};n.NOW_REF_NAME="n";n.MAX_TIME_REF_NAME="m";n.$maxTime=plywood_1.$(n.MAX_TIME_REF_NAME);n.$now=plywood_1.$(n.NOW_REF_NAME);n.LATEST_PRESETS=[{name:"1H",selection:n.$maxTime.timeRange("PT1H",-1),label:strings_1.STRINGS.latest+" "+strings_1.STRINGS.hour},{name:"6H",selection:n.$maxTime.timeRange("PT6H",-1),label:strings_1.STRINGS.latest+" 6 "+strings_1.STRINGS.hours},{name:"1D",selection:n.$maxTime.timeRange("P1D",-1),label:strings_1.STRINGS.latest+" "+strings_1.STRINGS.day},{name:"7D",selection:n.$maxTime.timeRange("P1D",-7),label:strings_1.STRINGS.latest+" 7 "+strings_1.STRINGS.days},{name:"30D",selection:n.$maxTime.timeRange("P1D",-30),label:strings_1.STRINGS.latest+" 30 "+strings_1.STRINGS.days}];n.CURRENT_PRESETS=[{name:"D",selection:n.$now.timeBucket("P1D"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.day},{name:"W",selection:n.$now.timeBucket("P1W"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.week},{name:"M",selection:n.$now.timeBucket("P1M"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.month},{name:"Q",selection:n.$now.timeBucket("P3M"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.quarter},{name:"Y",selection:n.$now.timeBucket("P1Y"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.year}];n.PREVIOUS_PRESETS=[{name:"D",selection:n.$now.timeFloor("P1D").timeRange("P1D",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.day},{name:"W",selection:n.$now.timeFloor("P1W").timeRange("P1W",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.week},{name:"M",selection:n.$now.timeFloor("P1M").timeRange("P1M",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.month},{name:"Q",selection:n.$now.timeFloor("P3M").timeRange("P3M",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.quarter},{name:"Y",selection:n.$now.timeFloor("P1Y").timeRange("P1Y",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.year}];n.PROPERTIES=[{name:"action",defaultValue:"overlap"},{name:"dimension"},{name:"values",immutableClass:plywood_1.Set,defaultValue:null},{name:"dynamic",immutableClass:plywood_1.Expression,defaultValue:null},{name:"search",defaultValue:null},{name:"exclude",defaultValue:false}];return n}(immutable_class_1.BaseImmutable);exports.FilterClause=FilterClause;immutable_class_1.BaseImmutable.finalize(FilterClause);