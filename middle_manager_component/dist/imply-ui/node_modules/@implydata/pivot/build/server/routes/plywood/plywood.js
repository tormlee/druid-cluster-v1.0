"use strict";var _this=this;var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var chronoshift_1=require("chronoshift");var plywood_1=require("plywood");var customization_1=require("../../../common/models/customization/customization");var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/max-time",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,a,u,o,c,i,l,d,g,h,f,m,b,p,y,v,_,x;return tslib_1.__generator(this,function(E){switch(E.label){case 0:t=e.user;s=e.body,n=s.dataCube,a=s.instance,u=s.settingsVersion;if(e.licenseManager&&e.licenseManager.isExpired()){r.sendError({status:501,error:"evaluation expired"});return[2]}if(typeof n!=="string"){r.status(400).send({error:"must have a dataCube"});return[2]}o=false;c=null;E.label=1;case 1:E.trys.push([1,3,,4]);return[4,e.settingsVersionStore.get("x")];case 2:c=E.sent();return[3,4];case 3:i=E.sent();r.status(400).send({error:"can not get version store",message:i.message});return[2];case 4:if(c&&u!==c.getMs()){o=true}E.label=5;case 5:E.trys.push([5,7,,8]);return[4,e.dataCubeStore.get(n)];case 6:l=E.sent();return[3,8];case 7:d=E.sent();r.sendError({status:500,error:"could not get data cube",e:d});return[2];case 8:if(!l){r.sendError({status:404,error:"unknown data cube"});return[2]}if(!l.getReadAccess().hasAccess(t)){r.sendError({status:403,error:"no read access to data cube"});return[2]}if(typeof a!=="string"){a=l.getDefaultInstance()}g=null;if(!(l.clusterName!=="native"))return[3,13];E.label=9;case 9:E.trys.push([9,11,,12]);return[4,e.clusterStore.get(l.clusterName)];case 10:g=E.sent();return[3,12];case 11:h=E.sent();r.sendError({status:500,error:"could not get cluster",e:h});return[2];case 12:if(!g){r.status(400).send({error:"unknown cluster"});return[2]}E.label=13;case 13:f=l.getMaxTimeQuery();if(!f){m={result:null};if(o)m.action="update";r.json(m);return[2]}E.label=14;case 14:E.trys.push([14,16,,17]);return[4,e.dataCubeActions.executorFactory({logger:e.logger,dataCube:l,instance:a,cluster:g,clusterActions:e.clusterActions,authToken:e.dbAuthToken,pathResolver:e.pathResolver})];case 15:b=E.sent();return[3,17];case 16:p=E.sent();r.sendError({status:500,error:"could not get executor",e:p});return[2];case 17:E.trys.push([17,19,,20]);return[4,b(f)];case 18:y=E.sent();return[3,20];case 19:v=E.sent();r.sendError({status:500,error:"could not compute",e:v});return[2];case 20:_=new Date(y);if(isNaN(_)){x={result:null}}else{e.timekeeperCache.addTime(l.name,_);x={result:_}}if(o)x.action="update";r.json(x);return[2]}})})});router.post("/",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,a,u,o,c,i,l,d,g,h,f,m,b,p,y,v,_,x,E,w,C,k,A,z,S,T,M,q,N,R;return tslib_1.__generator(this,function(V){switch(V.label){case 0:t=e.user;s=e.body,n=s.dataCube,a=s.instance,u=s.expression,o=s.timezone,c=s.monitor,i=s.settingsVersion,l=s.skipCache;if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}d=false;g=null;V.label=1;case 1:V.trys.push([1,3,,4]);return[4,e.settingsVersionStore.get("x")];case 2:g=V.sent();return[3,4];case 3:h=V.sent();r.status(400).send({error:"can not get version store",message:h.message});return[2];case 4:if(g&&i!==g.getMs()){d=true}if(typeof n!=="string"){r.status(400).send({error:"must have a dataCube"});return[2]}f=null;if(typeof o==="string"){try{f=chronoshift_1.Timezone.fromJS(o)}catch(e){r.status(400).send({error:"bad timezone",message:e.message});return[2]}}m=null;try{m=plywood_1.Expression.fromJS(u)}catch(e){r.status(400).send({error:"bad expression",message:e.message});return[2]}V.label=5;case 5:V.trys.push([5,7,,8]);return[4,e.dataCubeStore.get(n)];case 6:b=V.sent();return[3,8];case 7:p=V.sent();r.sendError({status:500,error:"could not get data cube",e:p});return[2];case 8:if(!b){r.sendError({status:404,error:"unknown data cube"});return[2]}if(!b.getReadAccess().hasAccess(t)){r.sendError({status:403,error:"no read access to data cube"});return[2]}if(typeof a!=="string"){a=b.getDefaultInstance()}y=null;if(!(b.clusterName!=="native"))return[3,13];V.label=9;case 9:V.trys.push([9,11,,12]);return[4,e.clusterStore.get(b.clusterName)];case 10:y=V.sent();return[3,12];case 11:v=V.sent();r.sendError({status:500,error:"could not get cluster",e:v});return[2];case 12:if(!y){r.status(400).send({error:"unknown cluster"});return[2]}V.label=13;case 13:_=l?null:e.queryCache;x=_?{attributes:b.attributes,subsetFormula:b.subsetFormula,instances:b.instances,instance:a,expression:m,queryTimezone:f}:null;E=null;if(!_)return[3,17];V.label=14;case 14:V.trys.push([14,16,,17]);return[4,_.getValue(x)];case 15:E=V.sent();return[3,17];case 16:w=V.sent();e.logger.error("Error hitting cache: "+w.message+" [pretending it is a miss]");return[3,17];case 17:if(E){C={result:E,cache:"hit"};if(d)C.action="update";r.json(C);return[2]}V.label=18;case 18:V.trys.push([18,20,,21]);return[4,e.dataCubeActions.executorFactory({logger:e.logger,dataCube:b,instance:a,cluster:y,clusterActions:e.clusterActions,authToken:e.dbAuthToken,pathResolver:e.pathResolver})];case 19:k=V.sent();return[3,21];case 20:A=V.sent();r.sendError({status:500,error:"could not get executor",e:A});return[2];case 21:z=null;if(!c)return[3,26];S=void 0;V.label=22;case 22:V.trys.push([22,24,,25]);return[4,e.customizationStore.get("x")];case 23:S=V.sent()||customization_1.Customization.BLANK;return[3,25];case 24:T=V.sent();r.sendError({status:500,error:"could not get customization",e:T});return[2];case 25:z=S.getClientMonitor()==="allow"?[]:null;V.label=26;case 26:V.trys.push([26,28,,29]);return[4,k(m,{timezone:f,rawQueries:z})];case 27:M=V.sent();return[3,29];case 28:q=V.sent();r.sendError({status:500,error:"could not compute",e:q,extra:z?{rawQueries:z}:null});return[2];case 29:N=plywood_1.valueToJS(M);R={result:N};if(_){_.setValue(x,N).catch(function(r){e.logger.error("Error setting cache: "+r.message)});R.cache="miss"}if(z)R.rawQueries=z;if(d)R.action="update";r.json(R);return[2]}})})});module.exports=router;