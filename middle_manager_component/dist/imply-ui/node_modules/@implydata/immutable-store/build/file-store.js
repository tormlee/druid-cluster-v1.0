"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var fs=require("fs-extra");var base_store_1=require("./base-store");var FileStore=function(_super){tslib_1.__extends(FileStore,_super);function FileStore(options){var _this=_super.call(this,options)||this;_this.immutableClass=options.immutableClass;_this.filepath=options.filepath;_this.format=options.format||"ndjson";_this.initArray=options.initArray||[];return _this}FileStore.prototype.readRaw=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var keyFn,fileContents,e_1,data;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:keyFn=this.keyFn;_a.label=1;case 1:_a.trys.push([1,3,,4]);return[4,fs.readFile(this.filepath,"utf-8")];case 2:fileContents=_a.sent();return[3,4];case 3:e_1=_a.sent();if(e_1.code!=="ENOENT")throw e_1;return[2,this.initArray.map(function(x){return{key:keyFn(x),value:x.toJS()}})];case 4:data=JSON.parse(fileContents||"[]");if(!Array.isArray(data))throw new Error("invalid file content");return[2,data.filter(function(d){return typeof d.key==="string"&&d.value})]}})})};FileStore.prototype.writeRaw=function(data){this.ensureWritable();var fileContents=JSON.stringify(data,null,2);return fs.writeFile(this.filepath,fileContents)};FileStore.prototype.size=function(){return this.readRaw().then(function(data){return data.length})};FileStore.prototype.get=function(key){var _this=this;return this.readRaw().then(function(data){var row=data.find(function(d){return d.key===key});if(!row)return null;return _this.immutableClass.fromJS(row.value)})};FileStore.prototype.getAll=function(){var _this=this;return this.readRaw().then(function(data){var immutableClass=_this.immutableClass;return data.map(function(row){return immutableClass.fromJS(row.value)})})};FileStore.prototype.deleteByKey=function(key){var _this=this;this.ensureWritable();return this.readRaw().then(function(data){data=data.filter(function(d){return d.key!==key});return _this.writeRaw(data)})};FileStore.prototype.addOrUpdate=function(thing){var _this=this;this.ensureWritable();var keyFn=this.keyFn;var key=keyFn(thing);var value=thing.toJS();return this.readRaw().then(function(data){var added=false;data=data.map(function(d){if(d.key===key){added=true;return{key:key,value:value}}else{return d}});if(!added){data.push({key:key,value:value});if(_this.maxEntries){var toTrim=Math.max(0,data.length-_this.maxEntries);if(toTrim){data=data.slice(toTrim)}}}return _this.writeRaw(data)})};return FileStore}(base_store_1.ImmutableStore);exports.FileStore=FileStore;