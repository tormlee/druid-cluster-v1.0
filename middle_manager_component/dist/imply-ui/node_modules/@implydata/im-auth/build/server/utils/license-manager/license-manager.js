"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var crypto=require("crypto");var fs=require("fs-extra");var path=require("path");var PUB="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtUf5vzKS8x4Fi60m8ejD\nIkzGES3B1YEjqglIbpsa8k1CDsDcoEKzQFP+H5vAcMuWkDDvq+Cw0UiXTHg/RbVo\nvHtRUzm4ap7x0IO/b4ia+JxRIYokqxKKPpF/JPkHb2qkLh7gfnNmGoRyLe0zCpnZ\nvIMv51GZ9HV3HzIvcC7SBcBF4QB1BCSooW27Xbs5uKxCeKsNZH0fmTH4FShWkvX/\nHsE065tk0ptPVs2A0XED0iyFiTlrakRAp7uOHHGZI07nDDAc8TAj7aM0v3lFUh21\nF8l5c/yrEa58wuI7bXt3sunA+Apji/HTm/Vd2sfUl6sU8224UdNkU04xBaoxWf4J\nfQIDAQAB\n-----END PUBLIC KEY-----";var LicenseManager=function(){function LicenseManager(options){this.hasLicense=false;this.showWelcome=false;this.expired=false;this.checker=null;this.appName=options.appName;this.logger=options.logger;this.varDir=options.varDir;this.licenseFile=options.licenseFile;this.initialize()}LicenseManager.validate=function(license){if(typeof license!=="string")return null;var parts=license.trim().split("|");if(parts.length!==3)return null;var name=parts[0],date=parts[1],sig=parts[2];var realDate=new Date(date+"T00:00:00.000Z");if(isNaN(realDate))return null;var verify=crypto.createVerify("RSA-SHA256");verify.update(name+"|"+date);return verify.verify(PUB,sig,"base64")?name:null};LicenseManager.expiredDate=function(fr){return Date.now()-fr.valueOf()>LicenseManager.EVAL_INTERVAL};LicenseManager.prototype.initialize=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var validLicense,firstRunStats;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.hasValidLicense()];case 1:validLicense=_a.sent();if(validLicense){this.hasLicense=true;return[2]}this.checker=setInterval(this.doCheck.bind(this),LicenseManager.CHECK_INTERVAL);if(this.checker&&this.checker.unref)this.checker.unref();return[4,this.getOrSetFirstRunFile()];case 2:firstRunStats=_a.sent();if(firstRunStats.created){this.showWelcome=true}else if(LicenseManager.expiredDate(firstRunStats.firstRun)){this.logger.log("Pivot evaluation license expired");this.expired=true}return[2]}})})};LicenseManager.prototype.isExpired=function(){return this.expired};LicenseManager.prototype.isWelcomeNeeded=function(){return this.showWelcome};LicenseManager.prototype.isSubscription=function(){return this.hasLicense};LicenseManager.prototype.welcomeShown=function(){this.showWelcome=false};LicenseManager.prototype.hasValidLicense=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,licenseFile,logger,license,e_1,registeredName;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,licenseFile=_a.licenseFile,logger=_a.logger;_b.label=1;case 1:_b.trys.push([1,3,,4]);return[4,fs.readFile(licenseFile,{encoding:"utf-8"})];case 2:license=_b.sent();return[3,4];case 3:e_1=_b.sent();return[2,false];case 4:registeredName=LicenseManager.validate(license);if(registeredName){logger.log("License accepted. [user: "+registeredName+", file: "+licenseFile+"]")}else{logger.log("License rejected.")}return[2,Boolean(registeredName)]}})})};LicenseManager.prototype.getOrSetFirstRunFile=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var firstRunFile,firstRunStr,e_2,time,firstRun;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:firstRunFile=path.join(this.varDir,".imply-first-run");_a.label=1;case 1:_a.trys.push([1,3,,5]);return[4,fs.readFile(firstRunFile,{encoding:"utf-8"})];case 2:firstRunStr=_a.sent();return[3,5];case 3:e_2=_a.sent();time=new Date;return[4,fs.writeFile(firstRunFile,time.toISOString())];case 4:_a.sent();return[2,{created:true,firstRun:time}];case 5:firstRun=new Date(firstRunStr.trim());if(isNaN(firstRun))throw new Error("invalid date");return[2,{created:false,firstRun:firstRun}]}})})};LicenseManager.prototype.doCheck=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var appName,validLicense,firstRunStats;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:appName=this.appName;return[4,this.hasValidLicense()];case 1:validLicense=_a.sent();if(validLicense){this.hasLicense=true;clearInterval(this.checker);return[2]}return[4,this.getOrSetFirstRunFile()];case 2:firstRunStats=_a.sent();if(LicenseManager.expiredDate(firstRunStats.firstRun)){this.logger.log(appName+" evaluation license expired.");this.expired=true;clearInterval(this.checker)}return[2]}})})};LicenseManager.CHECK_INTERVAL=6e4;LicenseManager.EVAL_INTERVAL=2592e6;return LicenseManager}();exports.LicenseManager=LicenseManager;