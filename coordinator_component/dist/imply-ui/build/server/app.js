"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var models_1=require("@implydata/im-auth/build/server/models");var authorizer_1=require("@implydata/im-auth/build/server/authorizer");var utils_1=require("@implydata/im-auth/build/server/utils");var authApp=require("@implydata/im-auth/build/server/app");var bodyParser=require("body-parser");var path=require("path");var innerApp=require("@implydata/pivot/build/server/inner-app");var pivotSettingsRoutes=require("@implydata/pivot/build/server/wrapper-routes/settings/settings");var immutable_store_1=require("@implydata/immutable-store");var utils_2=require("@implydata/pivot/build/server/utils");var models_2=require("@implydata/pivot/build/common/models");var sqlApp=require("@implydata/im-sql/build/server/app");var launcherApp=require("@implydata/launcher/build/server/app");var Icons=require("@implydata/little-pictures");function getSideDrawerItems(e,t){return[{label:"",isSeparator:true},{value:"home",label:"Home",svgIcon:Icons.LAUNCHER,href:"/"},{value:"manager",label:"Manager",titleIcon:Icons.FUTURA_MANAGER,description:"Manage clusters, onboard new data and monitor performance (coming soon)",href:"/manager",svgIcon:Icons.MINI_MANAGER,disabled:true},{value:"pivot",label:"Pivot",titleIcon:Icons.FUTURA_PIVOT,description:"Explore data intuitively and share insights with your team",href:"/pivot",svgIcon:Icons.MINI_PIVOT},{value:"sql",label:"SQL",titleIcon:Icons.FUTURA_SQL,description:"Craft, run, save and share Druid SQL queries",href:"/sql",svgIcon:Icons.MINI_CLI},{value:"settings",label:"Settings",titleIcon:Icons.FUTURA_SETTINGS,description:"Manage users, company account and personal profile",href:"/settings",svgIcon:Icons.MINI_SETTINGS,disable:!t},{value:"support",label:"Support",titleIcon:Icons.FUTURA_SUPPORT,description:"Please contact us if you have any questions",href:e?"https://support.imply.io":"/#support",svgIcon:Icons.MINI_SUPPORT},{value:"docs",label:"Docs",titleIcon:Icons.FUTURA_DOCS,description:"Documentation on Imply and Druid, as well as other useful resources",href:"https://docs.imply.io",svgIcon:Icons.MINI_DOCS}]}function wrapperAppFactory(e){var t=this;var r=e.version,s=e.logger,a=e.tracker,o=e.serverConfig,i=e.knex,n=e.initialSettings,l=n===void 0?{}:n;var u=new nike_hercules_1.HerculesServer({});u.getApp().set("port",o.getPort());if(o.getTrustProxy()==="always"){u.getApp().set("trust proxy",1)}u.addCompress();u.getApp().use(nike_hercules_1.logAndTrack({morganFormat:o.getRequestLogFormat()}));u.decorateReqRes();u.getApp().use(bodyParser.json({limit:"1mb"}));if(o.getStrictTransportSecurity()==="always"){u.addHsts()}u.addStaticRoutes([path.join(__dirname,"../../assets")]);u.addHealth();u.addClientError();var m=o.getUserMode();var p=o.isStateful();var c=o.getResolvedVarDir();var d=o.getResolvedLicenseFile();nike_hercules_1.LOGGER.log("Looking for license file at: "+d);var g=new utils_1.LicenseManager({appName:"Imply UI",logger:s,varDir:c,licenseFile:d});var v=o.getStateStore().getTablePrefix();var _;var h=null;if(m==="native-users"||m==="ldap-authentication"||m==="header-user"){if(i){h=new immutable_store_1.KnexStore({immutableClass:im_auth_1.Role,readOnly:!p,knex:i,table:v+"roles",initArray:[im_auth_1.Role.SUPER_ADMIN,im_auth_1.Role.USER],logger:s})}else{h=new immutable_store_1.FileStore({immutableClass:im_auth_1.Role,readOnly:!p,filepath:path.resolve(c,"roles.json"),initArray:[im_auth_1.Role.SUPER_ADMIN,im_auth_1.Role.USER]})}var f=null;if(i){f=new immutable_store_1.KnexStore({immutableClass:im_auth_1.User,readOnly:!p,knex:i,table:v+"users",initArray:l.users,logger:s})}else{f=new immutable_store_1.FileStore({immutableClass:im_auth_1.User,readOnly:!p,filepath:path.resolve(c,"users.json"),initArray:l.users})}if(m==="native-users"){var b=null;if(i){b=new immutable_store_1.KnexStore({immutableClass:models_1.UserAuth,readOnly:!p,knex:i,table:v+"user-auths",initArray:l.userAuths,logger:s})}else{b=new immutable_store_1.FileStore({immutableClass:models_1.UserAuth,readOnly:!p,filepath:path.resolve(c,"user-auths.json"),initArray:l.userAuths})}_=new authorizer_1.StoreAuthorizer({authStore:b,userStore:f})}else if(m==="ldap-authentication"){var y=o.getLdapOptions();_=new authorizer_1.LDAPAuthorizer({userStore:f,ldapOptions:y,defaultRole:y.defaultRole,logger:s})}else if(m==="header-user"){_=new authorizer_1.StoreAuthorizer({userStore:f})}else{throw new Error("should never get here")}}var S;if(i){S=new immutable_store_1.KnexStore({immutableClass:models_1.InviteToken,readOnly:!p,knex:i,table:v+"invite-tokens",logger:s})}else{S=new immutable_store_1.FileStore({immutableClass:models_1.InviteToken,readOnly:!p,filepath:path.resolve(c,"inviteTokens.json")})}var A;if(i){A=new immutable_store_1.KnexStore({immutableClass:models_2.SettingsVersion,readOnly:!p,knex:i,keyFn:function(){return"x"},table:v+"settings-versions",logger:s})}else{A=new immutable_store_1.FileStore({immutableClass:models_2.Customization,readOnly:!p,keyFn:function(){return"x"},filepath:path.resolve(c,"settingsVersions.json")})}var I;if(i){I=new immutable_store_1.KnexStore({immutableClass:models_2.Customization,readOnly:!p,knex:i,keyFn:function(){return"x"},table:v+"customizations",initArray:l.customization?[l.customization]:[],logger:s})}else{I=new immutable_store_1.FileStore({immutableClass:models_2.Customization,readOnly:!p,keyFn:function(){return"x"},filepath:path.resolve(c,"customizations.json"),initArray:l.customization?[l.customization]:[]})}var w;if(i){w=new immutable_store_1.KnexStore({immutableClass:models_2.Cluster,readOnly:!p,knex:i,table:v+"clusters",initArray:l.clusters,logger:s})}else{w=new immutable_store_1.FileStore({immutableClass:models_2.Cluster,readOnly:!p,filepath:path.resolve(c,"clusters.json"),initArray:l.clusters})}var C;if(i){C=new immutable_store_1.KnexStore({immutableClass:models_2.DataCube,readOnly:!p,knex:i,table:v+"data-cubes",initArray:l.dataCubes,logger:s})}else{C=new immutable_store_1.FileStore({immutableClass:models_2.DataCube,readOnly:!p,filepath:path.resolve(c,"data-cubes.json"),initArray:l.dataCubes})}var k;if(i){k=new immutable_store_1.KnexStore({immutableClass:models_2.Collection,readOnly:!p,knex:i,table:v+"collections",initArray:l.collections,logger:s})}else{k=new immutable_store_1.FileStore({immutableClass:models_2.Collection,readOnly:!p,filepath:path.resolve(c,"collections.json"),initArray:l.collections})}var x;if(i){x=new immutable_store_1.KnexStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},knex:i,table:v+"urls",logger:s,maxEntries:o.getMaxUrlEntries()})}else{x=new immutable_store_1.FileStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},filepath:path.resolve(c,"urls.json"),maxEntries:o.getMaxUrlEntries()})}var R=new utils_2.Decorators({logger:s,decorators:o.getResolvedDecorators()});var U=new utils_2.ClusterActions({verbose:o.verbose,logger:s,decorators:R});var F=o.needsLogin()?"/logout":null;u.getApp().use(function(e,t,s){e.user=null;e.version=r;e.stateful=p;e.logoutHref=F;e.authorizer=_;e.inviteTokenStore=S;e.licenseManager=g;e.rolesStore=h;e.hasUsersConcept=m==="native-users";s()});u.getApp().use(function(e,t,r){var s=e.body.version;if(s&&s!==e.version){t.status(412).send({error:"incorrect version",action:"reload"});return}r()});if(o.needsLogin()){u.addRoutes("/",authApp.makeAuthApp({version:r,title:"Login to "+o.getAppName(),appName:o.getAppName(),userNameLabel:o.getUserNameLabel(),sessionStore:o.getSessionStore(),authorizer:_}))}else if(m==="all-admin"){u.getApp().use(function(e,t,r){e.user=im_auth_1.User.DEFAULT_ADMIN;r()})}else if(m==="all-users"){u.getApp().use(function(e,t,r){e.user=im_auth_1.User.fromJS({name:"user",email:"user@user.com",firstName:"Default",lastName:"User",status:"ok"});r()})}else if(m==="header-user"){u.getApp().use(function(e,r,s){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,a,o,i,n;return tslib_1.__generator(this,function(l){switch(l.label){case 0:t=e.header("x-im-user");try{o=JSON.parse(new Buffer(t,"base64").toString("utf-8"));a=im_auth_1.User.fromJS(o)}catch(e){r.status(403).send({error:"bad user"});return[2]}l.label=1;case 1:l.trys.push([1,3,,4]);return[4,_.updateWithTrustedUser(a)];case 2:i=l.sent();return[3,4];case 3:n=l.sent();r.status(500).send({error:"simple auth fail"});return[2];case 4:e.user=i;s();return[2]}})})})}else{throw new Error("unexpected userMode "+m)}if(o.getIframe()==="deny"){u.getApp().use(function(e,t,r){t.setHeader("X-Frame-Options","DENY");t.setHeader("Content-Security-Policy","frame-ancestors 'none'");r()})}if(o.purePivot&&p){u.getApp().use("/settings",function(e,t,r){var s=e.user;if(!s.canAccessSettings()){t.status(403).send({error:"no settings access"});return}e.settingsVersionStore=A;e.customizationStore=I;e.clusterStore=w;e.dataCubeStore=C;e.collectionStore=k;r()},pivotSettingsRoutes)}var q=o.getQueryCache();var O;switch(q.type){case"none":O=null;break;case"local":O=new utils_2.LocalQueryCache({config:q,logger:s});break;case"memcached":O=new utils_2.MemcachedQueryCache({config:q,logger:s});break;default:throw new Error("unknown query cache type: '"+q.type+"'")}var T=m==="header-user";var N=o.purePivot?"":"pivot";var P=o.purePivot&&!T?null:"/";var E=p?"/settings":null;u.getApp().use("/"+N,function(e,t,r){e.mountPoint=(T?e.header("x-mount-point"):null)||N;e.settingsHref=E;e.launcherHref=P;e.settingsVersionStore=A;e.customizationStore=I;e.clusterStore=w;e.dataCubeStore=C;e.collectionStore=k;e.queryCache=O;e.clusterActions=U;e.urlStore=x;r()},innerApp.getApp());if(!o.purePivot){var D=function(e){return{clusterId:e.name,name:e.title,queryHosts:[e.host],state:"RUNNING",socksHost:e.socksHost,getTimeout:function(){return e.getTimeout()}}};u.getApp().use("/sql",function(e,r,s){e.sideDrawerItems=getSideDrawerItems(g.isSubscription(),p);e.simplePivot=true;e.decorators=R;e.clusterActions={getAllClusters:function(){return tslib_1.__awaiter(t,void 0,void 0,function(){var e;return tslib_1.__generator(this,function(t){switch(t.label){case 0:return[4,w.getAll()];case 1:e=t.sent();return[2,e.map(D)]}})})}};s()},sqlApp.makeServer({logoutHref:"/logout",homeHref:"/"}).getApp())}u.getApp().use("/",function(e,t,r){e.clusterStore=w;e.clusterActions={getAllClusters:function(){return Promise.resolve([])}};e.customizationStore=I;e.showRolesTab=false;e.sideDrawerItems=getSideDrawerItems(g.isSubscription(),p);r()},launcherApp.makeLauncherServer({appTitle:"Imply Platform",logoutHref:"/logout",homeHref:"/",version:r,serverConfig:o,simplePivot:true,hasSubscription:false}).getApp());u.getApp().use(function(e,t,r){if(e.path!=="/"){t.redirect("/")}else{r()}});if(u.getApp().get("env")==="development"){u.getApp().use(function(e,t,s,a){t.logger.error("Server Error: "+e.message);t.logger.error(e.stack);s.status(e.status||500);s.send({version:r,error:e.message,err:e})})}u.getApp().use(function(e,t,s,a){t.logger.error("Server Error: "+e.message);t.logger.error(e.stack);s.status(e.status||500);s.send({version:r,error:e.message})});return u.getApp()}exports.wrapperAppFactory=wrapperAppFactory;