"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var React=require("react");var _route_1=require("./_route");var RouterCore=function(t){tslib_1.__extends(r,t);function r(){var r=t.call(this)||this;r.state={};return r}r.areSameCrumbs=function(t,r){if(!t&&r&&r.length===0)return true;if(!r&&t&&t.length===0)return true;if(!t||!r)return false;return t.length===r.length&&t.every(function(t,e){return r[e]===t})};r.prototype.hasExtraFragments=function(t){var e=t.fragment.split(r.FRAGMENTS_SEPARATOR);if(this.isGreedyFragment(e[e.length-1])){return false}return t.crumbs.length>t.fragment.split(r.FRAGMENTS_SEPARATOR).length};r.prototype.stripUnnecessaryFragments=function(t,e){var i=t.fragment.split(r.FRAGMENTS_SEPARATOR);var n=e.join(r.FRAGMENTS_JOINER).replace(t.crumbs.join(r.FRAGMENTS_JOINER),"").replace(/\/$/,"");var o=t.crumbs.slice(0,t.fragment.split(r.FRAGMENTS_SEPARATOR).length);var s=[n,o.join(r.FRAGMENTS_JOINER)].filter(Boolean);this.props.onChange(s)};r.prototype.initFromProps=function(t){var r=t.crumbs;if(!r)r=[];var e=this.props.children;if(r.length===0){var i=this.getDefaultFragment(e);if(i){this.props.onChange([i]);return}}var n=this.getQualifiedPath(e,r);if(n.wasDefaultChoice){this.props.onChange(n.crumbs.filter(Boolean));return}if(this.hasExtraFragments(n)){this.stripUnnecessaryFragments(n,r);return}if(this.canDefaultDeeper(n.fragment,n.crumbs)){r=r.concat(this.getDefaultDeeperCrumbs(n.fragment,n.crumbs));this.props.onChange(r.filter(Boolean))}this.setState({crumbs:r})};r.prototype.componentDidMount=function(){this.initFromProps(this.props)};r.prototype.componentWillReceiveProps=function(t){this.initFromProps(t)};r.prototype.getDefaultDeeperCrumbs=function(t,e){var i=t.split(r.FRAGMENTS_SEPARATOR);i.splice(0,e.length);return i.map(function(t){return t.match(/^:[^=]+=(\w+)$/)[1]})};r.prototype.canDefaultDeeper=function(t,e){var i=t.split(r.FRAGMENTS_SEPARATOR);if(i.length===e.length)return false;i.splice(0,e.length);return i.every(function(t){return/^:[^=]+=\w+$/.test(t)})};r.prototype.getDefaultFragment=function(t){if(Array.isArray(t)){for(var r=0;r<t.length;r++){var e=t[r];if(this.isRoute(e)){return e.props.fragment}}}else{var e=t;if(this.isRoute(e)){return e.props.fragment}}return undefined};r.prototype.isDisabled=function(t){return t&&t.props.disabled===true};r.prototype.getQualifiedPath=function(t,e,i,n,o){if(i===void 0){i={}}if(n===void 0){n=[]}if(o===void 0){o=[]}if(this.isRoute(t)){t=[t]}for(var s=0;s<t.length;s++){var a=t[s];if(!a)continue;if(this.isAComment(a))continue;if(this.isRoute(a)&&this.isDisabled(a))continue;var u=a.props.fragment;if(!u)continue;i=Object.assign(i,this.getPropertiesFromCrumbs(e,u));if(e[0]===u||u.charAt(0)===":"){var p=a.props.children;var f=o.concat([a]);var l=!Array.isArray(p)||e.length===u.split(r.FRAGMENTS_SEPARATOR).length||u.split(r.FRAGMENTS_SEPARATOR).some(this.isGreedyFragment);if(!this.isRoute(p)&&l){return{fragment:u,route:a,crumbs:e,properties:i,orphans:n,parentRoutes:f}}else{if(a.props.alwaysShowOrphans===true){n=n.concat(p.filter(this.isSimpleChild,this))}return this.getQualifiedPath(p,e.slice(1),i,n,f)}}}var h=t.filter(this.isRoute)[0];var c=h.props.fragment;return{fragment:c,route:h,crumbs:o.map(function(t){return t.props.fragment}).concat([c]),wasDefaultChoice:true,properties:Object.assign(i,this.getPropertiesFromCrumbs(e,c)),orphans:n,parentRoutes:o}};r.prototype.hasSingleChild=function(t){if(!t)return false;return!Array.isArray(t.props.children)};r.prototype.isRoute=function(t){if(!t)return false;return t.type===_route_1.Route};r.prototype.isAComment=function(t){if(!t)return false;return t.type===undefined};r.prototype.isSimpleChild=function(t){if(!t)return false;return!this.isAComment(t)&&!this.isRoute(t)};r.prototype.getSimpleChildren=function(t){if(!t)return null;return t.props.children.filter(this.isSimpleChild,this)};r.prototype.isGreedyFragment=function(t){return/^:\$/.test(t)};r.prototype.getPropertiesFromCrumbs=function(t,e,i){if(i===void 0){i={}}var n=function(t){return t.replace(/^:\$?/,"").replace(/=.*$/,"")};var o=t.concat();var s=e.split(r.FRAGMENTS_SEPARATOR);for(var a=0;a<s.length-1;a++){var u=s[a];if(u.charAt(0)!==":")return;i[n(u)]=o.shift()}var p=s[s.length-1];if(this.isGreedyFragment(p)){i[n(p)]=o.join(r.FRAGMENTS_JOINER)}else if(p.charAt(0)===":"){i[n(p)]=o.shift()}return i};r.prototype.inflate=function(t,r){if(!t)return r;var e={};for(var i in r){var n=t(i,r[i]);if(!n)continue;var o=n.key,s=n.value;e[o]=s}return e};r.prototype.fillProperties=function(t,r,e){if(e===void 0){e=0}if(!(t.type instanceof Function))return t;var i=this.getPropertiesFromCrumbs(r.crumbs,r.route.props.fragment);r.parentRoutes.forEach(function(t){if(t.props.transmit){t.props.transmit.forEach(function(t){return i[t]=r.properties[t]})}});i=this.inflate(r.route.props.inflate,i);return React.cloneElement(t,Object.assign({key:e},i))};r.prototype.getQualifiedChildren=function(t,r){var e=this;var i;var n=this.getQualifiedPath(t,r);if(n.route.props.onActivate)n.route.props.onActivate(n.properties);if(this.hasSingleChild(n.route)){i=n.orphans.map(function(t,r){return e.fillProperties(t,n,r)}).concat([this.fillProperties(n.route.props.children,n,n.orphans.length)])}else{var o=this.getSimpleChildren(n.route);if(o.length===0)return null;i=o.map(function(t,r){return e.fillProperties(t,n,r)}).concat(n.orphans.map(function(t,r){return e.fillProperties(t,n,o.length+r)}))}if(!i)return null;return i};r.prototype.render=function(){var t=this.props.children;var r=this.state.crumbs;if(!r||!r.length)return null;var e=this.getQualifiedChildren(t,r);if(e&&e.length===1)return e[0];return React.createElement("div",{className:"route-wrapper",style:{width:"100%",height:"100%"}},e)};r.FRAGMENTS_SEPARATOR=/\/+/;r.FRAGMENTS_JOINER="/";return r}(React.Component);exports.RouterCore=RouterCore;