"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var Scroller=function(t){tslib_1.__extends(e,t);function e(){var e=t.call(this)||this;e.state={scrollTop:0,scrollLeft:0,viewportHeight:0,viewportWidth:0,bodyPadding:{top:0,right:0,bottom:0,left:0}};e.globalResizeListener=e.globalResizeListener.bind(e);return e}e.prototype.initFromProps=function(t){var e=t.layout;if(e&&e.bodyPadding){this.setState({bodyPadding:{top:e.bodyPadding.top||0,right:e.bodyPadding.right||0,bottom:e.bodyPadding.bottom||0,left:e.bodyPadding.left||0}})}};e.prototype.componentWillReceiveProps=function(t){this.initFromProps(t)};e.prototype.globalResizeListener=function(){this.updateViewport()};e.prototype.getGutterStyle=function(t){var e=this.props.layout;var o=this.state,r=o.scrollLeft,i=o.scrollTop,n=o.bodyPadding;switch(t){case"top":return{height:e.top,left:e.left-r+n.left,minWidth:e.bodyWidth+e.left};case"right":return{width:e.right,right:0,top:e.top-i+n.top,bottom:e.bottom};case"bottom":return{height:e.bottom,left:e.left-r+n.left,minWidth:e.bodyWidth+e.left,bottom:0};case"left":return{width:e.left,left:0,top:e.top-i+n.top,bottom:e.bottom};default:throw new Error("Unknown side for gutter. This shouldn't happen.")}};e.prototype.getShadowStyle=function(t){var e=this.props.layout;var o=this.state,r=o.scrollLeft,i=o.scrollTop,n=o.bodyPadding;switch(t){case"top":return{top:0,height:e.top,left:n.left-r,minWidth:e.bodyWidth+e.left+e.right};case"right":return{width:e.right,right:0,top:0,bottom:0};case"bottom":return{height:e.bottom,bottom:0,left:n.left-r,minWidth:e.bodyWidth+e.left+e.right};case"left":return{width:e.left,left:0,top:0,bottom:0};default:throw new Error("Unknown side for shadow. This shouldn't happen.")}};e.prototype.getCornerStyle=function(t,e){var o=this.props.layout;var r={};if(e==="left"){r.left=0;r.width=o.left}else{r.right=0;r.width=o.right}if(t==="top"){r.top=0;r.height=o.top}else{r.height=o.bottom;r.bottom=0}return r};e.prototype.getBodyStyle=function(){var t=this.props.layout;var e=this.state,o=e.scrollTop,r=e.scrollLeft,i=e.bodyPadding;return{top:t.top-o+i.top,right:t.right,bottom:t.bottom,left:t.left-r+i.left}};e.prototype.getTargetStyle=function(){var t=this.props.layout;var e=this.state.bodyPadding;return{width:t.bodyWidth+t.left+t.right+e.left+e.right,height:t.bodyHeight+t.top+t.bottom+e.top+e.bottom}};e.prototype.getDOMElement=function(t){return ReactDOM.findDOMNode(this.refs[t])};e.prototype.onScroll=function(t){var o=this;var r=this.props,i=r.onLimitReached,n=r.onScroll,l=r.layout;var s=l.bodyWidth,a=l.bodyHeight;var h=this.state,p=h.viewportWidth,d=h.viewportHeight,u=h.bodyPadding;var f=t.target;var c=beltful_1.NumberUtils.clamp(f.scrollLeft,0,Math.max(s+u.left+u.right-p,0));var v=beltful_1.NumberUtils.clamp(f.scrollTop,0,Math.max(a+u.top+u.bottom-d,0));var g=a-v-d+u.top+u.bottom===0;var b=s-c-p+u.left+u.right===0;this.setState({scrollTop:v,scrollLeft:c},function(){if(n)o.props.onScroll(v,c);if(i&&g)i(e.BOTTOM_LIMIT);if(i&&b)i(e.RIGHT_LIMIT)})};e.prototype.getRelativeMouseCoordinates=function(t){var o=this.props.layout,r=o.top,i=o.left,n=o.bodyWidth,l=o.bodyHeight;var s=this.state.bodyPadding;var a=this.getDOMElement("eventContainer");var h=this.state,p=h.scrollLeft,d=h.scrollTop,u=h.viewportHeight,f=h.viewportWidth;var c=a.getBoundingClientRect();var v=0;var g=0;var b=beltful_1.EventUtils.getXFromEvent(t)-c.left;var y=beltful_1.EventUtils.getYFromEvent(t)-c.top;var m=b;var T=y;if(b>i&&b<=i+f){g=1;m+=p}else if(b>i+f){g=2;m+=n-f}if(y>r&&y<=r+u){v=1;T+=d}else if(y>r+u){v=2;T+=l-u}var R=e.PARTS[v][g];if(R===e.BODY){if(y<=r+s.top){R=e.TOP_PADDING}else if(y+d>r+l+s.top){R=e.BOTTOM_PADDING}if(b<=i+s.left){R=e.LEFT_PADDING}else if(b+p>i+n+s.left){R=e.RIGHT_PADDING}}return{x:m,y:T,part:R}};e.prototype.onClick=function(t){if(this.props.onClick===undefined)return;var e=this.getRelativeMouseCoordinates(t),o=e.x,r=e.y,i=e.part;if(r<0||o<0)return;this.props.onClick(o,r,i,t)};e.prototype.onMouseMove=function(t){if(this.props.onMouseMove===undefined)return;var e=this.getRelativeMouseCoordinates(t),o=e.x,r=e.y,i=e.part;if(r<0||o<0)return;var n=this.props.onMouseMove(o,r,i);if(n===true){this.setState({unclickable:false})}else if(n===false){this.setState({unclickable:true})}};e.prototype.renderGutter=function(t){var e=this.props[t+"Gutter"];if(!e)return null;return React.createElement("div",{className:t+"-gutter",style:this.getGutterStyle(t)},e)};e.prototype.shouldHaveShadow=function(t){var e=this.props.layout;var o=this.state,r=o.scrollLeft,i=o.scrollTop,n=o.viewportHeight,l=o.viewportWidth;if(t==="top")return i>0;if(t==="left")return r>0;if(t==="bottom")return e.bodyHeight-i>n;if(t==="right")return e.bodyWidth-r>l;throw new Error("Unknown side for shadow : "+t)};e.prototype.renderShadow=function(t){if(!this.props.layout[t])return null;if(!this.shouldHaveShadow(t))return null;return React.createElement("div",{className:t+"-shadow",style:this.getShadowStyle(t)})};e.prototype.renderCorner=function(t,e){var o=this.getCornerStyle(t,e);var r=this.props[t+beltful_1.StringUtils.firstUp(e)+"Corner"];if(!r)return null;return React.createElement("div",{className:[t,e,"corner"].join("-"),style:o},r)};e.prototype.componentDidMount=function(){this.initFromProps(this.props);window.addEventListener("resize",this.globalResizeListener);this.updateViewport()};e.prototype.componentWillUnmount=function(){window.removeEventListener("resize",this.globalResizeListener)};e.prototype.componentDidUpdate=function(){this.updateViewport()};e.prototype.updateViewport=function(){var t=this.getDOMElement("Scroller");if(!t)return;var e=t.getBoundingClientRect();var o=this.props.layout,r=o.top,i=o.right,n=o.bottom,l=o.left;var s=e.height-r-n;var a=e.width-l-i;if(this.state.viewportHeight!==s||this.state.viewportWidth!==a){this.setState({viewportHeight:s,viewportWidth:a})}};e.prototype.render=function(){var t=this.state,e=t.viewportWidth,o=t.viewportHeight,r=t.unclickable;var i=this.props,n=i.body,l=i.overlay,s=i.onMouseLeave,a=i.layout;if(!a)return null;var h=classNames("event-container",{"no-x-scroll":a.bodyWidth<=e,"no-y-scroll":a.bodyHeight<=o});var p=classNames("scroller",{"has-top-shadow":this.shouldHaveShadow("top"),unclickable:r});return React.createElement("div",{className:p,ref:"Scroller"},React.createElement("div",{className:"body",style:this.getBodyStyle()},n),this.renderGutter("top"),this.renderGutter("right"),this.renderGutter("bottom"),this.renderGutter("left"),this.renderCorner("top","left"),this.renderCorner("top","right"),this.renderCorner("bottom","left"),this.renderCorner("bottom","right"),this.renderShadow("top"),this.renderShadow("right"),this.renderShadow("bottom"),this.renderShadow("left"),l?React.createElement("div",{className:"overlay"},l):null,React.createElement("div",{className:h,ref:"eventContainer",onScroll:this.onScroll.bind(this),onClick:this.onClick.bind(this),onMouseMove:this.onMouseMove.bind(this),onMouseLeave:s||null},React.createElement("div",{className:"event-target",style:this.getTargetStyle()})))};e.TOP_LEFT_CORNER="top-left-corner";e.TOP_GUTTER="top-gutter";e.TOP_RIGHT_CORNER="top-right-corner";e.LEFT_GUTTER="left-gutter";e.BODY="body";e.RIGHT_GUTTER="right-gutter";e.BOTTOM_LEFT_CORNER="bottom-left-corner";e.BOTTOM_GUTTER="bottom-gutter";e.BOTTOM_RIGHT_CORNER="bottom-right-corner";e.TOP_PADDING="top-padding";e.RIGHT_PADDING="right-padding";e.BOTTOM_PADDING="bottom-padding";e.LEFT_PADDING="left-padding";e.PARTS=[[e.TOP_LEFT_CORNER,e.TOP_GUTTER,e.TOP_RIGHT_CORNER],[e.LEFT_GUTTER,e.BODY,e.RIGHT_GUTTER],[e.BOTTOM_LEFT_CORNER,e.BOTTOM_GUTTER,e.BOTTOM_RIGHT_CORNER]];e.BOTTOM_LIMIT="bottom";e.RIGHT_LIMIT="right";return e}(React.Component);exports.Scroller=Scroller;