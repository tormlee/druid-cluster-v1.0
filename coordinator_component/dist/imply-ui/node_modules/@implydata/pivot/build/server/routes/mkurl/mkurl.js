"use strict";var _this=this;var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var nike_hercules_1=require("@implydata/nike-hercules");var models_1=require("../../../common/models");var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/register",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,a;return tslib_1.__generator(this,function(n){switch(n.label){case 0:t=e.body.essence;if(e.licenseManager&&e.licenseManager.isExpired()){r.sendError({status:501,error:"evaluation expired"});return[2]}if(typeof t!=="object"){r.sendError({status:400,error:"essence must be an object"});return[2]}try{s=models_1.AnyEssence.fromJS(t)}catch(e){r.sendError({status:400,error:"invalid essence",e:e});return[2]}n.label=1;case 1:n.trys.push([1,3,,4]);return[4,e.urlStore.addOrUpdate(s)];case 2:n.sent();return[3,4];case 3:a=n.sent();r.sendError({status:500,error:"can not store essence",e:a});return[2];case 4:r.json({status:"ok"});return[2]}})})});router.post("/",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,a,n,u,o,i,c,l,d;return tslib_1.__generator(this,function(b){switch(b.label){case 0:t=e.body,s=t.domain,a=t.essence,n=t.dataCube,u=t.dataSource;if(a&&!a.dataCube){a.dataCube=n||u}if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}if(typeof a!=="object"){r.status(400).send({error:"essence must be an object"});return[2]}o=a.dataCube;if(typeof o!=="string"){r.status(400).send({error:"essence must have a dataCube"});return[2]}b.label=1;case 1:b.trys.push([1,3,,4]);return[4,e.dataCubeStore.get(o)];case 2:i=b.sent();return[3,4];case 3:c=b.sent();r.sendError({status:500,error:"could not get data cube",e:c});return[3,4];case 4:if(!i){r.status(400).send({error:"unknown data cube"});return[2,null]}try{l=models_1.Essence.fromJS(a,{actualDataCube:i,visualizations:models_1.MANIFESTS})}catch(e){r.status(400).send({error:"invalid essence",message:e.message});return[2]}b.label=5;case 5:b.trys.push([5,7,,8]);return[4,e.urlStore.addOrUpdate(l)];case 6:b.sent();return[3,8];case 7:d=b.sent();r.sendError({status:500,error:"can not store essence",e:d});return[2];case 8:r.json({url:[s,"d",l.getHash(),beltful_1.StringUtils.makeUrlSafeTitle(a.actualDataCube.title)].join("/")});return[2]}})})});module.exports=router;