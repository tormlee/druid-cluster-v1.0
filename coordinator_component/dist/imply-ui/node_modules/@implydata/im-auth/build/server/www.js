"use strict";Object.defineProperty(exports,"__esModule",{value:true});var es7Shim=require("es7-shim");es7Shim.shim();var path=require("path");var debugModule=require("debug");var http=require("http");var nike_hercules_1=require("@implydata/nike-hercules");var user_1=require("../common/models/user/user");var models_1=require("../server/models");var app_1=require("./app");var immutable_store_1=require("@implydata/immutable-store");var store_authorizer_1=require("./authorizer/store-authorizer/store-authorizer");var PORT=9094;var debug=debugModule("manager:www");var server=new nike_hercules_1.HerculesServer;server.decorateReqRes();var userStore=new immutable_store_1.FileStore({immutableClass:user_1.User,filepath:path.resolve("users.json"),initArray:[]});var authorizer=new store_authorizer_1.StoreAuthorizer({authStore:new immutable_store_1.FileStore({immutableClass:models_1.UserAuth,filepath:path.resolve("user-auths.json"),initArray:[]}),userStore:userStore});var authApp=app_1.makeAuthApp({version:"1",title:"Login to Standalone Auth",appName:"Standalone Auth",showTerms:true,authorizer:authorizer});server.getApp().use(function(req,res,next){req.authorizer=authorizer;req.logger=nike_hercules_1.LOGGER;req.tracker=nike_hercules_1.TRACKER;next()});server.getApp().use(nike_hercules_1.logAndTrack({morganFormat:':remote-addr - :remote-user [:date[clf]] ":method :url HTTP/:http-version" :status :res[content-length]'}));server.getApp().use(authApp);server.getApp().use("/",function(req,res,next){var user=req.user;res.send("Welcome "+user.getDisplayName())});var httpServer=http.createServer(server.getApp());httpServer.on("error",function(error){if(error.syscall!=="listen"){throw error}switch(error.code){case"EACCES":console.error("Port "+PORT+" requires elevated privileges");process.exit(1);break;case"EADDRINUSE":console.error("Port "+PORT+" is already in use");process.exit(1);break;default:throw error}});httpServer.on("listening",function(){var address=httpServer.address();console.log("Im auth is listening on address "+address.address+" port "+address.port);debug("Im auth is listening on address "+address.address+" port "+address.port)});httpServer.listen(PORT);