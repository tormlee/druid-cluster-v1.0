"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var toArray=require("stream-to-array");var requester_1=require("./requester");var nike_hercules_1=require("@implydata/nike-hercules");var plywood_druid_requester_1=require("plywood-druid-requester");var DruidRequester=function(e){tslib_1.__extends(r,e);function r(r,t){var o=e.call(this,r)||this;o.druidAuth=null;var u=r.cluster,s=r.logger,a=r.decorators;if(r.druidAuth){o.druidAuth=r.druidAuth}o.ca=r.ca;o.protocol=r.protocol;var n=null;if(u.decorator){var i=a.getDecoratorModule(u.decorator);n=i.druidRequestDecoratorFactory(s,{options:u.decoratorOptions||{},cluster:u})}o.requester=plywood_druid_requester_1.druidRequesterFactory({host:u.queryHosts[0],timeout:u.getTimeout(),protocol:u.protocol,ca:u.ca,requestDecorator:n,authToken:t,socksHost:u.socksHost,socksUsername:u.socksUsername,socksPassword:u.socksPassword});return o}r.prototype.populateDataSourceColumns=function(e){var r=e.name;return toArray(this.getSegmentMetadata(r)).then(function(r){if(!r||!r.length)return e;var t=r[0].columns;var o=Object.keys(t).map(function(e){return{key:e,value:t[e]}});return e.changeColumnsFromSegmentMetadata(o)}).catch(function(r){nike_hercules_1.LOGGER.warn("Error getting "+e.name+" segment metadata: "+r.message);return e})};r.prototype.getSegmentMetadata=function(e){return this.requester({query:{queryType:"segmentMetadata",dataSource:e,analysisTypes:[],merge:true,lenientAggregatorMerge:true}})};r.prototype.getDataSources=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var e;return tslib_1.__generator(this,function(r){switch(r.label){case 0:return[4,toArray(this.requester({query:{queryType:"sourceList"}}))];case 1:e=r.sent();return[2,[].concat.apply([],e)]}})})};return r}(requester_1.Requester);exports.DruidRequester=DruidRequester;