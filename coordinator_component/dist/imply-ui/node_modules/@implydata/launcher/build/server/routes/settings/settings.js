"use strict";var _this=this;var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var immutable_class_1=require("immutable-class");var views_1=require("../../views");var im_auth_1=require("@implydata/im-auth");var models_1=require("@implydata/pivot/build/common/models");var middleware_1=require("../../utils/middleware/middleware");var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/set-role",middleware_1.makeGuardForUserManagement(),function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,t,n,a;return tslib_1.__generator(this,function(o){switch(o.label){case 0:s=e.rolesStore;t=e.body.role;o.label=1;case 1:o.trys.push([1,3,,4]);return[4,s.addOrUpdate(im_auth_1.Role.fromJS(t))];case 2:o.sent();return[3,4];case 3:n=o.sent();r.status(400).send({error:"Settings update error:",message:n.message});return[2];case 4:return[4,s.getAll()];case 5:a=o.sent();r.send({status:"ok",newRoles:a});return[2]}})})});router.post("/remove-role",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,t,n,a,o,u,i,l,c,d,m;return tslib_1.__generator(this,function(_){switch(_.label){case 0:s=e.rolesStore,t=e.authorizer;n=e.body.role;_.label=1;case 1:_.trys.push([1,3,,4]);return[4,s.deleteByKey(n)];case 2:_.sent();return[3,4];case 3:a=_.sent();r.status(400).send({error:"Settings update error:",message:a.message});return[2];case 4:_.trys.push([4,10,,11]);return[4,t.getAllUsers()];case 5:o=_.sent();u=o.filter(function(e){return e.getRoles().includes(n)});i=0;_.label=6;case 6:if(!(i<u.length))return[3,9];l=u[i];c=l.getRoles();l=l.changeRoles(c.filter(function(e){return e!==n}));return[4,t.addOrUpdateUser(l)];case 7:_.sent();_.label=8;case 8:i++;return[3,6];case 9:return[3,11];case 10:d=_.sent();r.status(400).send({error:"d update error:",message:d.message});return[2];case 11:return[4,s.getAll()];case 12:m=_.sent();r.send({status:"ok",newRoles:m});return[2]}})})});router.post("/set-customization",middleware_1.makeGuardForUserManagement(),function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,t,n,a,o;return tslib_1.__generator(this,function(u){switch(u.label){case 0:s=e.body.customization;try{t=models_1.Customization.fromJS(s)}catch(e){r.status(400).send({error:"bad customization",message:e.message});return[2]}u.label=1;case 1:u.trys.push([1,3,,4]);return[4,e.customizationStore.addOrUpdate(t)];case 2:u.sent();return[3,4];case 3:n=u.sent();r.status(501).send({error:"could not update",message:n.message});return[2];case 4:u.trys.push([4,6,,7]);return[4,e.customizationStore.get("x")];case 5:a=u.sent();return[3,7];case 6:o=u.sent();r.status(501).send({error:"could not get new version",message:o.message});return[2];case 7:r.send({customization:a});return[2]}})})});router.post("/set-clusters",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,t,n,a,o,u,i,l,c,d;return tslib_1.__generator(this,function(m){switch(m.label){case 0:s=e.body.clusterDiffs;try{t=immutable_class_1.Diff.inflateFromJSs(models_1.Cluster,s)}catch(e){r.status(400).send({error:"bad clusterDiffs",message:e.message});return[2]}m.label=1;case 1:m.trys.push([1,6,,7]);n=0,a=t;m.label=2;case 2:if(!(n<a.length))return[3,5];o=a[n];return[4,e.clusterStore.applyDiff(o)];case 3:u=m.sent();if(!u){if(o.before){i=e.clusterStore.get(o.before.name);console.error("Diff not accepted:");if(i){console.error("Existing: "+JSON.stringify(i));console.error("Diff Before: "+JSON.stringify(o.before))}else{console.error("Before does not exist ("+o.before.name+")")}}throw new Error("can not apply collection diff "+o.getName())}m.label=4;case 4:n++;return[3,2];case 5:return[3,7];case 6:l=m.sent();r.status(501).send({error:"could not update",message:l.message});return[2];case 7:m.trys.push([7,9,,10]);return[4,e.clusterStore.getAll()];case 8:c=m.sent();return[3,10];case 9:d=m.sent();r.status(501).send({error:"could get new version",message:d.message});return[2];case 10:r.send({clusters:c});return[2]}})})});router.post("/cluster-connection",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,t;return tslib_1.__generator(this,function(n){s=e.body.cluster;if(typeof s==="undefined"){r.status(400).send({error:"must have a cluster"});return[2]}try{t=models_1.Cluster.fromJS(s)}catch(e){r.status(400).send({error:"invalid cluster",message:e.message});return[2]}r.send({cluster:t});return[2]})})});router.get("/?*",function(e,r,s){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,t,n,a,o,u,i,l,c,d,m,_,g;return tslib_1.__generator(this,function(f){switch(f.label){case 0:s=e.user,t=e.sideDrawerItems,n=e.cloudSettingsActions,a=e.rolesStore,o=e.hasUsersConcept,u=e.clusterStore,i=e.showRolesTab;if(!a)return[3,4];f.label=1;case 1:f.trys.push([1,3,,4]);return[4,a.getAll()];case 2:l=f.sent();return[3,4];case 3:m=f.sent();r.status(500).send({error:"could not load settings",message:m.message});return[2];case 4:if(!n)return[3,8];f.label=5;case 5:f.trys.push([5,7,,8]);return[4,n.getAccount(s.accountId)];case 6:c=f.sent();return[3,8];case 7:_=f.sent();r.status(500).send({error:"could not load account",message:_.message});return[2];case 8:if(!(u&&!n))return[3,12];f.label=9;case 9:f.trys.push([9,11,,12]);return[4,u.getAll()];case 10:d=f.sent();return[3,12];case 11:g=f.sent();r.status(500).send({error:"could not load clusters",message:g.message});return[2];case 12:r.send(views_1.settingsLayout({version:e.version,title:"Imply Settings",roles:l,account:c,clusters:d,user:s,sideDrawerItems:t,hasUsersConcept:o,showRolesTab:i}));return[2]}})})});module.exports=router;