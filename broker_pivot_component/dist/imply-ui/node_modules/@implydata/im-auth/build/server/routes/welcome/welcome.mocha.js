"use strict";var _this=this;Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var supertest=require("supertest");var chai_1=require("chai");var bodyParser=require("body-parser");var nike_hercules_1=require("@implydata/nike-hercules");var immutable_store_1=require("@implydata/immutable-store");var user_1=require("../../../common/models/user/user");var user_auth_1=require("../../models/user-auth/user-auth");var authorizer_1=require("../../authorizer");var welcomeRoutes=require("./welcome");var views_1=require("../../views");function extractConfig(text){var a="<script>window.__CONFIG__ = {";var b="};<\/script>";var ai=text.indexOf(a);var bi=text.indexOf(b);if(ai<0||bi<0)return null;return JSON.parse(text.substring(ai+a.length-1,bi+1))}var name=Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10);function makeServer(){var server=new nike_hercules_1.HerculesServer;server.addSession("so much boilerplate",false,null);server.decorateReqRes();server.getApp().use(bodyParser.json());server.getApp().use("/",welcomeRoutes);return server}var middleWare=function(req,res,next){return tslib_1.__awaiter(_this,void 0,void 0,function(){var authorizer,userSize,authSize;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:authorizer=req.authorizer;return[4,authorizer.userSize()];case 1:userSize=_a.sent();return[4,authorizer.userAuthSize()];case 2:authSize=_a.sent();if(!userSize||!authSize){res.send(views_1.loginLayout({version:req.version,title:req.title,appName:"ImAuth",userNameLabel:"Email",showTerms:false,isWelcome:true}))}else{res.send("skipping this")}return[2]}})})};describe("welcome",function(){var _this=this;this.timeout(4e3);describe("serves page when no userAuths but users",function(){var server=makeServer();before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userStore,authStore,authorizer;return tslib_1.__generator(this,function(_a){userStore=new immutable_store_1.ArrayStore({initArray:[{name:name}].map(user_1.User.fromJS)});authStore=new immutable_store_1.ArrayStore({initArray:[]});authorizer=new authorizer_1.StoreAuthorizer({userStore:userStore,authStore:authStore});server.getApp().use(function(req,res,next){req.authorizer=authorizer;next()});server.getApp().use(middleWare);return[2]})})});it("gets triggered",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app,resp;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server.getApp())];case 1:app=_a.sent();return[4,app.get("/").expect(200)];case 2:resp=_a.sent();chai_1.expect(extractConfig(resp.text).isWelcome).to.equal(true);return[2]}})})})});describe("serves page when no users but userAuths",function(){var server=makeServer();before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userStore,authStore,authorizer;return tslib_1.__generator(this,function(_a){userStore=new immutable_store_1.ArrayStore({initArray:[]});authStore=new immutable_store_1.ArrayStore({initArray:[{name:"hello",pass:"hello "}].map(user_auth_1.UserAuth.fromJS)});authorizer=new authorizer_1.StoreAuthorizer({userStore:userStore,authStore:authStore});server.getApp().use(function(req,res,next){req.authorizer=authorizer;next()});server.getApp().use(middleWare);return[2]})})});it("gets triggered ",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app,resp;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server.getApp())];case 1:app=_a.sent();return[4,app.get("/").expect(200)];case 2:resp=_a.sent();chai_1.expect(extractConfig(resp.text).isWelcome).to.equal(true);return[2]}})})})});describe("serves page when non user auths or users",function(){var server=makeServer();before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userStore,authStore,authorizer;return tslib_1.__generator(this,function(_a){userStore=new immutable_store_1.ArrayStore({initArray:[]});authStore=new immutable_store_1.ArrayStore({initArray:[]});authorizer=new authorizer_1.StoreAuthorizer({userStore:userStore,authStore:authStore});server.getApp().use(function(req,res,next){req.authorizer=authorizer;next()});server.getApp().use(middleWare);return[2]})})});it("gets triggered",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app,resp;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server.getApp())];case 1:app=_a.sent();return[4,app.get("/").expect(200)];case 2:resp=_a.sent();chai_1.expect(extractConfig(resp.text).isWelcome).to.equal(true);return[2]}})})})});describe("does not serve page when both user auths and users",function(){var server=makeServer();before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userStore,authStore,authorizer;return tslib_1.__generator(this,function(_a){userStore=new immutable_store_1.ArrayStore({initArray:[{name:name}].map(user_1.User.fromJS)});authStore=new immutable_store_1.ArrayStore({initArray:[{name:"hello",pass:"hello "}].map(user_auth_1.UserAuth.fromJS)});authorizer=new authorizer_1.StoreAuthorizer({userStore:userStore,authStore:authStore});server.getApp().use(function(req,res,next){req.authorizer=authorizer;next()});server.getApp().use(middleWare);return[2]})})});it("gets triggered",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app,resp;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server.getApp())];case 1:app=_a.sent();return[4,app.get("/").expect(200)];case 2:resp=_a.sent();chai_1.expect(resp.text).to.equal("skipping this");return[2]}})})})});describe("create",function(){var server=makeServer();before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userStore,authStore,authorizer;return tslib_1.__generator(this,function(_a){userStore=new immutable_store_1.ArrayStore({initArray:[]});authStore=new immutable_store_1.ArrayStore({initArray:[]});authorizer=new authorizer_1.StoreAuthorizer({userStore:userStore,authStore:authStore});server.getApp().use(function(req,res,next){req.authorizer=authorizer;next()});server.getApp().use("/",welcomeRoutes);return[2]})})});it.skip("works with reasonable",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server.getApp())];case 1:app=_a.sent();return[2,app.post("/create").set("Content-Type","application/json").send({name:name,pass:"hey!"}).expect(200)]}})})});it("fails with incorrect info",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server.getApp())];case 1:app=_a.sent();return[2,app.post("/create").set("Content-Type","application/json").send({name:name}).expect(400)]}})})})})});