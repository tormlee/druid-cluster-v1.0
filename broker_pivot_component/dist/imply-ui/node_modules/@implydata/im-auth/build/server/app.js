"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var bodyParser=require("body-parser");var nike_hercules_1=require("@implydata/nike-hercules");var models_1=require("../common/models");var views_1=require("./views");var path=require("path");var invite_user_1=require("./routes/invite-user/invite-user");var passResetRoutes=require("./routes/pass-reset/pass-reset");var mklinkRoutes=require("./routes/mklink/mklink");var welcomeRoutes=require("./routes/welcome/welcome");var login_1=require("./routes/login/login");function makeAuthApp(options){var _this=this;var appName=options.appName,userNameLabel=options.userNameLabel,showTerms=options.showTerms,sessionSecret=options.sessionSecret,secureCookie=options.secureCookie,title=options.title,sessionStore=options.sessionStore,version=options.version,authorizer=options.authorizer;var server=new nike_hercules_1.HerculesServer;server.addSession(sessionSecret||"this-is-secret",secureCookie,sessionStore);server.addStaticRoutes([path.join(__dirname,"../../build/public"),path.join(__dirname,"../../assets")]);server.getApp().use(function(req,res,next){req.user=null;req.title=title;req.version=version;next()});server.getApp().use(bodyParser.json({}));server.addRoutes("/login",login_1.tryLogin);server.getApp().use("/logout",function(req,res,next){req.session.loggedIn=false;res.redirect("/")});if(authorizer.isManagingUsers()){server.addRoutes("/welcome",welcomeRoutes);server.addRoutes("/invite-user",invite_user_1.inviteUserRouterFactory({appName:appName,userNameLabel:userNameLabel,showTerms:showTerms}))}if(authorizer.isManagingUsers()){server.getApp().use(function(req,res,next){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userSize,authSize;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,authorizer.userSize()];case 1:userSize=_a.sent();return[4,authorizer.userAuthSize()];case 2:authSize=_a.sent();if(!userSize||!authSize){res.send(views_1.loginLayout({version:req.version,title:req.title,appName:appName,userNameLabel:userNameLabel,showTerms:showTerms,isWelcome:true}))}else{next()}return[2]}})})})}server.getApp().use(function(req,res,next){return tslib_1.__awaiter(_this,void 0,void 0,function(){var userName,user,e_1;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!req.session.loggedIn)return[3,5];userName=req.session.userName||(req.session.user?req.session.user.name:null);user=void 0;_a.label=1;case 1:_a.trys.push([1,3,,4]);return[4,authorizer.getUser(userName)];case 2:user=_a.sent();return[3,4];case 3:e_1=_a.sent();res.status(500).json({status:"User can not be loaded"});return[2];case 4:if(!user){res.status(403).json({status:"No user found"});return[2]}if(authorizer.hasAccounts()&&!user.accountId){res.status(500).json({status:"User must have account id"});return[2]}req.user=user;next();return[3,6];case 5:if(req.path!=="/"){res.redirect("/");req.tracker.track({type:"serve-login-page",metric:"serve-login-page/count",value:1,user:null,attr:{subtype:"redirect"}})}else{req.tracker.track({type:"serve-login-page",metric:"serve-login-page/count",value:1,user:null,attr:{subtype:"redirect"}});res.send(views_1.loginLayout({version:version,title:title,appName:appName,userNameLabel:userNameLabel,showTerms:showTerms}))}_a.label=6;case 6:return[2]}})})});if(authorizer.isManagingUsers()){server.addRoutes("/pass-reset",passResetRoutes);server.addRoutes("/mklink",mklinkRoutes);server.getApp().use(function(req,res,next){var title=options.title,version=options.version,appName=options.appName;var user=req.user;if(user.status===models_1.User.STATUS_NEEDS_TO_SET_PASS){res.send(views_1.loginLayout({appName:appName,userNameLabel:userNameLabel,showTerms:showTerms,version:version,title:title,userName:user.name,accountId:user.accountId,isForceSetPass:true}));return}next()})}return server.getApp()}exports.makeAuthApp=makeAuthApp;