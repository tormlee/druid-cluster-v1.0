"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("./login-view.css");var React=require("react");var immutable_class_1=require("immutable-class");var immutable_ui_1=require("@implydata/immutable-ui");var caladan_1=require("@implydata/caladan");var ajax_1=require("@implydata/ajax");var immutable_ui_2=require("@implydata/immutable-ui");var strings_1=require("../../common/strings");var pass_strength_1=require("../../common/utils/pass-strength/pass-strength");var MAX_USER_ID=200;var MAX_PASS=200;var LABELS={pass:{label:"Password",description:"Enter new password"},repeatPass:{label:"Repeat Password",description:"Enter password again"}};var Credentials=function(_super){tslib_1.__extends(Credentials,_super);function Credentials(params){if(params===void 0){params={}}return _super.call(this,params)||this}Credentials.fromJS=function(params){return new Credentials(immutable_class_1.BaseImmutable.jsToValue(Credentials.PROPERTIES,params))};Credentials.PROPERTIES=[{name:"name",defaultValue:null},{name:"pass",defaultValue:null},{name:"repeatPass",defaultValue:null},{name:"firstName",defaultValue:null},{name:"lastName",defaultValue:null}];return Credentials}(immutable_class_1.BaseImmutable);exports.Credentials=Credentials;immutable_class_1.BaseImmutable.finalize(Credentials);var LoginView=function(_super){tslib_1.__extends(LoginView,_super);function LoginView(){var _this=_super.call(this)||this;_this.state={loading:false,newInstance:new Credentials};_this.delegate=new immutable_ui_2.ImmutableFormDelegate(_this);return _this}LoginView.prototype.componentWillMount=function(){var hash=window.location.hash;if(hash)window.location.hash=""};LoginView.prototype.componentDidMount=function(){this.initFromProps(this.props)};LoginView.prototype.initFromProps=function(props){var userName=props.userName;if(!userName)return;this.setState({newInstance:new Credentials({name:userName})})};LoginView.prototype.shouldDisableSubmit=function(){var _a=this.props,inviteToken=_a.inviteToken,isForceSetPass=_a.isForceSetPass;var _b=this.state,newInstance=_b.newInstance,errors=_b.errors;if(errors.pass||errors.repeatPass)return true;var name=newInstance.name,pass=newInstance.pass;if(!inviteToken&&!name||!pass||(inviteToken||isForceSetPass)&&!newInstance.repeatPass)return true;return false};LoginView.prototype.onSubmit=function(event){var _this=this;event.preventDefault();var _a=this.props,userName=_a.userName,inviteToken=_a.inviteToken,accountId=_a.accountId,isForceSetPass=_a.isForceSetPass,isWelcome=_a.isWelcome;var _b=this.state,rememberMe=_b.rememberMe,_c=_b.newInstance,name=_c.name,pass=_c.pass,firstName=_c.firstName,lastName=_c.lastName;if(this.shouldDisableSubmit())return;this.setState({loading:true});var query=null;if(inviteToken){query={url:"/invite-user/accept",data:{name:userName,pass:pass,token:inviteToken,accountId:accountId}}}else if(isForceSetPass){query={url:"/pass-reset",data:{name:userName,pass:pass}}}else if(isWelcome){query={url:"/welcome/create",data:{name:name,pass:pass,firstName:firstName,lastName:lastName}}}else{query={url:"/login",data:{name:name,pass:pass,rememberMe:rememberMe}}}ajax_1.Ajax.query(query).then(function(data){if(inviteToken||isForceSetPass){window.history.replaceState(undefined,undefined,"/")}switch(data.status){case"BAD_AUTH":_this.setState({authFail:"Invalid credentials",loading:false});break;case"OK":window.location.reload();break;default:window.location.reload();break}},function(e){_this.setState({authFail:"Backend request failed",loading:false})})};LoginView.prototype.toggleRememberMe=function(){var rememberMe=this.state.rememberMe;this.setState({rememberMe:!rememberMe})};LoginView.prototype.renderCheckboxes=function(){var rememberMe=this.state.rememberMe;var showForgotPassword=false;return React.createElement("div",{className:"check-item"},React.createElement(caladan_1.Checkbox,{selected:rememberMe,onClick:this.toggleRememberMe.bind(this)}),React.createElement("span",{onClick:this.toggleRememberMe.bind(this)}," Remember me"),showForgotPassword?React.createElement("span",{className:"right-link"},"Forgot password?"):null)};LoginView.prototype.renderTermsAndConditions=function(){var showTerms=this.props.showTerms;if(!showTerms)return null;var year=(new Date).getFullYear();return React.createElement("div",{className:"terms"},React.createElement("a",{href:"https://imply.io/imply-software-license-terms",target:"_blank"},strings_1.STRINGS.termsOfUse),",",React.createElement("a",{href:"https://imply.io/privacy.html",target:"_blank"}," ",strings_1.STRINGS.privacyPolicy," "),"Â© ",year," Imply Data, Inc.")};LoginView.prototype.render=function(){var _a=this.props,userName=_a.userName,inviteToken=_a.inviteToken,isForceSetPass=_a.isForceSetPass,userNameLabel=_a.userNameLabel,appName=_a.appName,passStrengthOpts=_a.passStrengthOpts,isWelcome=_a.isWelcome;var _b=this.state,loading=_b.loading,authFail=_b.authFail,newInstance=_b.newInstance,errors=_b.errors;var passStrength=new pass_strength_1.PassStrenth(passStrengthOpts);var titleText;if(inviteToken){titleText="Welcome "+userName}else if(isWelcome){titleText="Welcome to "+appName}else{titleText="Login to "+appName}var isSettingPass=inviteToken||isForceSetPass;var userIdChecker=function(n){if(n&&n.length>MAX_USER_ID){throw new Error("This is too long")}return true};var passChecker=function(p){if(p&&p.length>MAX_PASS){throw new Error("This is too long")}if(isSettingPass){var error=passStrength.getIssuesWithPass(p);if(error){throw new Error(error)}}return true};var repeatPassChecker=function(rp){if(rp!==newInstance.pass)throw new Error("Passwords must match");return true};var makeLabel=caladan_1.FormLabel.simpleGenerator(LABELS,errors);var makeTextInput=immutable_ui_1.ImmutableTextInput.simpleGenerator(newInstance,this.delegate.onChange,LABELS,errors);var nameFieldGroup=React.createElement("div",{className:"input-group"},caladan_1.FormLabel.dumbLabel(userNameLabel||"Email"),makeTextInput("name",userIdChecker,true,null,null));var passFieldGroup=React.createElement("div",{className:"input-group"},isSettingPass?makeLabel("pass","pass",React.createElement(caladan_1.InfoSpot,{bubbly:true,sourceIds:["pass"]})):caladan_1.FormLabel.dumbLabel(LABELS["pass"].label),makeTextInput("pass",passChecker,false,null,null,"password"));var firstNameFieldGroup=React.createElement("div",{className:"input-group"},caladan_1.FormLabel.dumbLabel("First name"),makeTextInput("firstName"));var lastNameFieldGroup=React.createElement("div",{className:"input-group"},caladan_1.FormLabel.dumbLabel("Last name"),makeTextInput("lastName"));var inviteContent=React.createElement("div",{className:"invite-user"},React.createElement("p",{className:"description"},"Please select a password so that you can start using ",appName," securely. The password must be at least ",passStrength.getPassRuleOptions().minLength," characters long."),passFieldGroup,React.createElement("div",{className:"input-group"},makeLabel("repeatPass","repeatPass",React.createElement(caladan_1.InfoSpot,{bubbly:true,sourceIds:["repeatPass"]})),makeTextInput("repeatPass",repeatPassChecker,false,null,null,"password")));var loginContent=React.createElement("div",{className:"login-user"},nameFieldGroup,passFieldGroup,this.renderCheckboxes());var welcomeContent=React.createElement("div",{className:"welcome-user"},React.createElement("p",{className:"description"},"Please create an account so you can start using ",appName," securely. Your email will serve as your user id. The password must be at least ",passStrength.getPassRuleOptions().minLength," characters long."),React.createElement("div",{className:"first-last"},firstNameFieldGroup,lastNameFieldGroup),nameFieldGroup,passFieldGroup,React.createElement("div",{className:"input-group"},makeLabel("repeatPass","repeatPass",React.createElement(caladan_1.InfoSpot,{bubbly:true,sourceIds:["repeatPass"]})),makeTextInput("repeatPass",repeatPassChecker,false,null,null,"password")));var content;if(isSettingPass){content=inviteContent}else if(isWelcome){content=welcomeContent}else{content=loginContent}return React.createElement("div",{className:"login-view"},React.createElement(caladan_1.GlobalEventListener,{enter:this.onSubmit.bind(this)}),React.createElement("form",{className:"login-form"},React.createElement("div",{className:"title-bar"},titleText),content,authFail?React.createElement("div",{className:"bad-auth"},"Bad Auth"):null,React.createElement("div",{className:"button-bar"},loading?React.createElement(caladan_1.LoadingBar,{label:strings_1.STRINGS.loggingIn}):React.createElement(caladan_1.Button,{type:"primary",title:isSettingPass?strings_1.STRINGS.ok:strings_1.STRINGS.login,disabled:this.shouldDisableSubmit(),onClick:this.onSubmit.bind(this)}))),this.renderTermsAndConditions())};return LoginView}(React.Component);exports.LoginView=LoginView;