"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var _scroller_layout_1=require("./_scroller-layout");tslib_1.__exportStar(require("./_scroller-layout"),exports);var CURSORS={"top-left-corner":"auto","top-gutter":"ns-resize","top-right-corner":"auto","left-gutter":"ew-resize",body:"auto","right-gutter":"ew-resize","bottom-left-corner":"auto","bottom-gutter":"ns-resize","bottom-right-corner":"auto","top-padding":"auto","right-padding":"auto","bottom-padding":"auto","left-padding":"auto"};var RESIZE_TOLERANCE=5;var Scroller=function(t){tslib_1.__extends(e,t);function e(){var e=t.call(this)||this;e.hasResized=false;e.state={scrollTop:0,scrollLeft:0,viewportSize:{width:0,height:0}};return e}e.prototype.globalResizeListener=function(){this.updateViewport()};e.prototype.getDOMElement=function(t){return ReactDOM.findDOMNode(this.refs[t])};e.prototype.onScroll=function(t){var r=this;var o=this.props,i=o.onLimitReached,a=o.onScroll,s=o.layout;var n=s.bodyWidth,l=s.bodyHeight;var u=this.state.viewportSize;var h=t.target;var p=beltful_1.NumberUtils.clamp(h.scrollLeft,0,Math.max(n+s.getPaddingLeft()+s.getPaddingRight()-u.width,0));var c=beltful_1.NumberUtils.clamp(h.scrollTop,0,Math.max(l+s.getPaddingTop()+s.getPaddingBottom()-u.height,0));var d=l-c-u.height+s.getPaddingTop()+s.getPaddingBottom()===0;var v=n-p-u.width+s.getPaddingLeft()+s.getPaddingRight()===0;this.setState({scrollTop:c,scrollLeft:p},function(){if(a)r.props.onScroll(c,p);if(i&&d)i(e.BOTTOM_LIMIT);if(i&&v)i(e.RIGHT_LIMIT)})};e.prototype.getApparentMouseCoordinates=function(t){var e=this.getDOMElement("eventContainer");var r=e.getBoundingClientRect();var o=beltful_1.EventUtils.getXFromEvent(t.nativeEvent)-r.left;var i=beltful_1.EventUtils.getYFromEvent(t.nativeEvent)-r.top;return{x:o,y:i}};e.prototype.getVirtualMouseCoordinates=function(t){var e=this.props.layout;var r=e.top,o=e.left,i=e.bodyWidth,a=e.bodyHeight;var s=this.state,n=s.scrollLeft,l=s.scrollTop,u=s.viewportSize;var h=this.getApparentMouseCoordinates(t),p=h.x,c=h.y;var d=p;var v=c;var f=0;var g=0;if(p>o&&p<=o+u.width){g=1;d+=n}else if(p>o+u.width){g=2;d+=i-u.width}if(c>r&&c<=r+u.height){f=1;v+=l}else if(c>r+u.height){f=2;v+=a-u.height}var y=_scroller_layout_1.ScrollerLayout.PARTS[f][g];if(y===_scroller_layout_1.ScrollerLayout.BODY){if(c<=r+e.getPaddingTop()){y=_scroller_layout_1.ScrollerLayout.TOP_PADDING}else if(c+l>r+a+e.getPaddingTop()){y=_scroller_layout_1.ScrollerLayout.BOTTOM_PADDING}if(p<=o+e.getPaddingLeft()){y=_scroller_layout_1.ScrollerLayout.LEFT_PADDING}else if(p+n>o+i+e.getPaddingLeft()){y=_scroller_layout_1.ScrollerLayout.RIGHT_PADDING}}return{x:d,y:v,part:y}};e.prototype.onClick=function(t){if(this.hasResized)return;if(this.props.onClick===undefined)return;var e=this.getVirtualMouseCoordinates(t),r=e.x,o=e.y,i=e.part;if(o<0||r<0)return;this.props.onClick(r,o,i,t.nativeEvent)};e.prototype.getPartToResize=function(t){var e=this.getApparentMouseCoordinates(t),r=e.x,o=e.y;var i=this.props.layout;var a=this.state.viewportSize;var s=i.left,n=i.top,l=i.right,u=i.bottom;if(r>s-RESIZE_TOLERANCE&&r<s+RESIZE_TOLERANCE){return _scroller_layout_1.ScrollerLayout.LEFT_GUTTER}else if(r>s+a.width-RESIZE_TOLERANCE&&r<s+a.width+RESIZE_TOLERANCE){return _scroller_layout_1.ScrollerLayout.RIGHT_GUTTER}else if(o>n-RESIZE_TOLERANCE&&o<n+RESIZE_TOLERANCE){return _scroller_layout_1.ScrollerLayout.TOP_GUTTER}else if(o>n+a.height-RESIZE_TOLERANCE&&o<n+a.height+RESIZE_TOLERANCE){return _scroller_layout_1.ScrollerLayout.BOTTOM_GUTTER}return null};e.prototype.getResizedLayout=function(t,e){var r=this.props.layout;var o=this.state.viewportSize;var i=this.getApparentMouseCoordinates(t),a=i.x,s=i.y;return r.resize(a,s,e,o)};e.prototype.onMouseDown=function(t){this.setState({resizedPart:this.getPartToResize(t)})};e.prototype.updateCursor=function(t){var e=this.props,r=e.isClickable,o=e.layout;var i=this.state,a=i.cursor,s=i.resizedPart;var n=s||this.getPartToResize(t);var l=this.getVirtualMouseCoordinates(t),u=l.x,h=l.y,p=l.part;var c="auto";if(r&&r(u,h,p))c="pointer";if(n&&o.canResize(n))c=CURSORS[n];if(c!==a){this.setState({cursor:c})}};e.prototype.onMouseMove=function(t){var e=this.props,r=e.onMouseMove,o=e.onResize,i=e.layout;var a=this.state.resizedPart;this.updateCursor(t);if(o&&a){var s=this.getResizedLayout(t,a);if(!s.equals(i))this.hasResized=true;o(s)}if(r){var n=this.getVirtualMouseCoordinates(t),l=n.x,u=n.y,h=n.part;r(l,u,h)}};e.prototype.onMouseLeave=function(t){var e=this.props.onMouseLeave;this.setState({cursor:undefined});if(e)e()};e.prototype.onMouseUp=function(){var t=this;window.setTimeout(function(){return t.hasResized=false},1);this.setState({resizedPart:undefined})};e.prototype.renderGutter=function(t){var e=this.props.layout;var r=this.state,o=r.scrollLeft,i=r.scrollTop;var a=this.props[t+"Gutter"];if(!a)return null;return React.createElement("div",{className:t+"-gutter",style:e.getGutterStyle(t,o,i)},a)};e.prototype.shouldHaveShadow=function(t){var e=this.props.layout;var r=this.state,o=r.scrollLeft,i=r.scrollTop,a=r.viewportSize;if(t==="top")return i>0;if(t==="left")return o>0;if(t==="bottom")return e.getBodyHeight()-i>a.height;if(t==="right")return e.getBodyWidth()-o>a.width;throw new Error("Unknown side for shadow : "+t)};e.prototype.renderShadow=function(t){var e=this.props.layout;var r=this.state,o=r.scrollLeft,i=r.scrollTop;if(!e.hasGutter(t))return null;if(!this.shouldHaveShadow(t))return null;return React.createElement("div",{className:t+"-shadow",style:e.getShadowStyle(t,o,i)})};e.prototype.renderCorner=function(t,e){var r=this.props.layout;var o=r.getCornerStyle(t,e);var i=this.props[t+beltful_1.StringUtils.firstUp(e)+"Corner"];if(!i)return null;return React.createElement("div",{className:[t,e,"corner"].join("-"),style:o},i)};e.prototype.componentDidMount=function(){this.updateViewport()};e.prototype.componentDidUpdate=function(){this.updateViewport()};e.prototype.updateViewport=function(){var t=this.state.viewportSize;var e=this.getDOMElement("Scroller");if(!e)return;var r=e.getBoundingClientRect();var o=this.props.layout,i=o.top,a=o.right,s=o.bottom,n=o.left;var l=r.height-i-s;var u=r.width-n-a;if(t.height!==l||t.width!==u){this.setState({viewportSize:{height:l,width:u}})}};e.prototype.render=function(){var t=this;var e=this.props,r=e.body,o=e.overlay,i=e.layout;var a=this.state,s=a.viewportSize,n=a.cursor,l=a.scrollLeft,u=a.scrollTop;if(!i)return null;var h=classNames("event-container",{"no-x-scroll":i.getBodyWidth()<=s.width,"no-y-scroll":i.getBodyHeight()<=s.height});var p=classNames("scroller",{"has-top-shadow":this.shouldHaveShadow("top")});return React.createElement("div",{className:p,ref:"Scroller",style:{cursor:n}},React.createElement(global_event_listener_1.GlobalEventListener,{mouseUp:function(){return t.onMouseUp()},resize:function(){return t.globalResizeListener()}}),React.createElement("div",{className:"body",style:i.getBodyStyle(l,u)},r),this.renderGutter("top"),this.renderGutter("right"),this.renderGutter("bottom"),this.renderGutter("left"),this.renderCorner("top","left"),this.renderCorner("top","right"),this.renderCorner("bottom","left"),this.renderCorner("bottom","right"),this.renderShadow("top"),this.renderShadow("right"),this.renderShadow("bottom"),this.renderShadow("left"),o?React.createElement("div",{className:"overlay"},o):null,React.createElement("div",{className:h,ref:"eventContainer",onScroll:function(e){return t.onScroll(e)},onClick:function(e){return t.onClick(e)},onMouseMove:function(e){return t.onMouseMove(e)},onMouseLeave:function(e){return t.onMouseLeave(e)},onMouseDown:function(e){return t.onMouseDown(e)}},React.createElement("div",{className:"event-target",style:i.getEventTargetStyle()})))};e.BOTTOM_LIMIT="bottom";e.RIGHT_LIMIT="right";return e}(React.Component);exports.Scroller=Scroller;