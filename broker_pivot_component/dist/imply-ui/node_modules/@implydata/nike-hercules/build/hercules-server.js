"use strict";Object.defineProperty(exports,"__esModule",{value:true});var uuid=require("uuid");var hasOwnProp=require("has-own-prop");var bodyParser=require("body-parser");var compress=require("compression");var express=require("express");var session=require("express-session");var hsts=require("hsts");var logger_1=require("./logger");var tracker_1=require("./tracker");var store_factory_1=require("./store-factory");var HerculesServer=function(){function HerculesServer(options){if(options===void 0){options={}}this.options=options;this.app=express();this.app.disable("x-powered-by");var serverRoot=this.options.serverRoot;if(serverRoot&&serverRoot[0]==="/")throw new Error("serverRoot must not have leading /")}HerculesServer.makeRouter=function(){return express.Router()};HerculesServer.prototype.getAttachPoint=function(attach){var serverRoot=this.options.serverRoot;return serverRoot?"/"+serverRoot+attach:attach};HerculesServer.prototype.decorateReqRes=function(){this.app.use(function(req,res,next){req.requestId=uuid.v4();req.logger=logger_1.LOGGER;req.tracker=tracker_1.TRACKER.addRequestId(req.requestId);res.sendError=function(params){var status=params.status,error=params.error,e=params.e,extra=params.extra;if(e&&500<=status){logger_1.LOGGER.error("error: "+error+" // "+e.message);if(hasOwnProp(e,"stack")){logger_1.LOGGER.error(e.stack)}}var json={error:error};if(e)json.message=e.message;if(extra)Object.assign(json,extra);res.status(status).send(json)};next()})};HerculesServer.prototype.addRoutes=function(attach,router){this.app.use(this.getAttachPoint(attach),router)};HerculesServer.prototype.addStaticRoutes=function(staticRoutes){for(var _i=0,staticRoutes_1=staticRoutes;_i<staticRoutes_1.length;_i++){var staticRoute=staticRoutes_1[_i];this.addRoutes("/",express.static(staticRoute))}};HerculesServer.prototype.getApp=function(){return this.app};HerculesServer.prototype.addCompress=function(){this.app.use(compress())};HerculesServer.prototype.addHealth=function(attach){if(attach===void 0){attach="/health"}this.app.get(this.getAttachPoint(attach),function(req,res){req.tracker.track({type:"health",metric:"count",value:1,user:req.user});res.send("I am healthy @ "+(new Date).toISOString())})};HerculesServer.prototype.addClientError=function(attach){if(attach===void 0){attach="/error"}this.app.post(this.getAttachPoint(attach),bodyParser.json(),function(req,res){var _a=req.body,message=_a.message,file=_a.file,line=_a.line,column=_a.column,stack=_a.stack;if(!message||typeof message!=="string"){message="No message"}req.logger.log("Client Error: "+JSON.stringify(req.body,null,2)+" "+req.user);req.tracker.track({type:"client-error",metric:"client-error/count",value:1,user:req.user,attr:{message:String(message),file:file,line:String(line),column:String(column),stack:stack}});res.send({message:"Error logged @ "+(new Date).toISOString()})})};HerculesServer.prototype.addHsts=function(){this.app.use(hsts({maxAge:10886400,includeSubDomains:true,preload:true}))};HerculesServer.prototype.addSession=function(sessionSecret,secureCookie,storeOptions){if(!sessionSecret)throw new Error("must have session secret");var store=null;if(storeOptions){store=store_factory_1.keyValueStoreFactory(storeOptions);logger_1.LOGGER.log("using "+storeOptions.storageType+" for session storage")}var cookie={};if(secureCookie){logger_1.LOGGER.log("Using secure cookie");cookie={secure:true}}var options={resave:false,saveUninitialized:false,secret:sessionSecret,store:store||null,cookie:cookie};this.app.use(session(options))};return HerculesServer}();exports.HerculesServer=HerculesServer;