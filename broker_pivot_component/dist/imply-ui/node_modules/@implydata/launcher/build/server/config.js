"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var path=require("path");var nopt=require("nopt");var fs=require("fs-extra");var nike_hercules_1=require("@implydata/nike-hercules");var beltful_1=require("@implydata/beltful");var server_config_1=require("./models/server-config/server-config");var index_1=require("./utils/index");function exitWithErrorCode(e,r){if(e===0){console.log(r)}else{console.error(r)}process.exit(e)}exports.exitWithErrorCode=exitWithErrorCode;function parseArgs(){return nopt({help:Boolean,version:Boolean,verbose:Boolean,port:Number,"server-host":String,"server-root":String,config:String,clarity:String,"manager-host":String},{v:["--verbose"],p:["--port"],c:["--config"],f:["--file"]},process.argv)}function getConfig(){return tslib_1.__awaiter(this,void 0,void 0,function(){var e,r,o,i,t,n,s,l,a,c;return tslib_1.__generator(this,function(f){switch(f.label){case 0:e=parseArgs();r=path.join(__dirname,"../../package.json");f.label=1;case 1:f.trys.push([1,3,,4]);return[4,fs.readFile(r,"utf-8")];case 2:o=f.sent();return[3,4];case 3:i=f.sent();console.log("Could not find package file at "+r);return[2,null];case 4:try{t=JSON.parse(o)}catch(e){console.log("Could not parse package file at "+r);return[2,null]}if(typeof t.version!=="string"){console.log("Invalid package file at "+r);return[2,null]}n=t.version;if(e["version"]){exitWithErrorCode(0,n)}if(e["example"]){delete e["example"];e["examples"]=true}nike_hercules_1.LOGGER.init();s=e["config"];if(s){l=path.dirname(s);try{a=beltful_1.StringUtils.inlineVars(index_1.loadFileSync(s,"yaml"),process.env);nike_hercules_1.LOGGER.log("Using config "+s)}catch(e){exitWithErrorCode(1,"Could not load config from '"+s+"': "+e.message)}}else{l=process.cwd();a={}}if(e["port"]){a.port=e["port"]}if(e["server-host"]){a.serverHost=e["server-host"]}if(e["server-root"]){a.serverRoot=e["server-root"]}if(e["clarity"]){a.clarityConfig=e["clarity"]}c=server_config_1.ServerConfig.fromJS(a);return[2,{verbose:Boolean(e["verbose"]||a.verbose),serverConfig:c,version:n}]}})})}exports.getConfig=getConfig;