"use strict";Object.defineProperty(exports,"__esModule",{value:true});var mysql=require("mysql");var MysqlStateStore=function(){function e(e,t){this.logger=e;this.settingsLocation=t;this.table=t.getTable();this.latestKnownVersion=0;this.resetConnection();this.setUpConnection()}e.prototype.setUpConnection=function(){var t=this;if(this.connected)return;var n=mysql.createConnection(this.settingsLocation.getUri());n.on("error",function(e){if(e.code==="PROTOCOL_CONNECTION_LOST"){t.logger.error("MySQL connection lost");t.resetConnection();return}throw e});n.connect(function(o){if(o){t.logger.error("Could not connect to MySQL store because "+o.code);t.connection.reject(o);t.resetConnection();return}n.query(e.SCHEMA,[t.table],function(e,o,r){if(e){t.logger.error("Could not init schema [table: "+t.table+"] because "+e.code);t.connection.reject(e);t.resetConnection();return}t.logger.log("Connected to MySQL state store [table: "+t.table+"]");t.onConnected(n)})})};e.prototype.onConnected=function(e){this.connected=true;this.connection.resolve(e)};e.prototype.resetConnection=function(){if(this.pollingTimer){clearInterval(this.pollingTimer);this.pollingTimer=null}var e=null;var t=null;var n=new Promise(function(n,o){e=n;t=o});this.connection={resolve:e,reject:t,promise:n};this.connected=false};e.prototype.resetIfFatal=function(e){if(!e.fatal)return;this.resetConnection()};e.prototype.readState=function(){var e=this;return this.connection.promise.then(function(t){return new Promise(function(n,o){t.query("SELECT version, state FROM ?? ORDER BY version DESC LIMIT 1;",[e.table],function(t,r){if(t){e.resetIfFatal(t);o(t);return}if(r.length>1){o(new Error("bad number of rows"));return}if(r.length===0){var i=e.settingsLocation.getInitialSettings()||"";var s=typeof i==="string"?i:JSON.stringify(i);n(s);return}e.latestKnownVersion=Number(r[0].version);n(String(r[0].state))})})})};e.SCHEMA="CREATE TABLE IF NOT EXISTS ?? (\n  version INT NOT NULL PRIMARY KEY,\n  created_on TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  state LONGBLOB NOT NULL\n  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;";return e}();exports.MysqlStateStore=MysqlStateStore;