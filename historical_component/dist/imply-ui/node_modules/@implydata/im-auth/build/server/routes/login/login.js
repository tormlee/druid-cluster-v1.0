"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");function tryLogin(req,res){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,name,pass,rememberMe,logger,authorizer,user,e_1;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=req.body,name=_a.name,pass=_a.pass,rememberMe=_a.rememberMe;logger=req.logger,authorizer=req.authorizer;_b.label=1;case 1:_b.trys.push([1,3,,4]);return[4,authorizer.checkUser(name,pass)];case 2:user=_b.sent();return[3,4];case 3:e_1=_b.sent();res.status(401).json({status:"BAD_AUTH"});return[2];case 4:if(!user){req.tracker.track({type:"login-attempt",metric:"login-attempt/count",value:1,user:null,attr:{success:"false",user_email:name,status_text:"BAD_AUTH",payload:pass}});res.status(401).json({status:"BAD_AUTH"});return[2]}if(!user){res.status(500).json({status:"UNEXPECTED_ERROR"});req.tracker.track({type:"login-attempt",metric:"login-attempt/count",value:1,user:null,attr:{success:"false",user_email:name,status_text:"COULD_NOT_FIND_USER"}});return[2]}if(authorizer.hasAccounts()&&!user.accountId){res.status(500).json({status:"User must have account id"});return[2]}req.tracker.track({type:"login-attempt",metric:"login-attempt/count",value:1,user:null,attr:{success:"true",user_email:name,status_text:"OK"}});req.session.loggedIn=true;req.session.userName=user.name;if(rememberMe){req.session.cookie.maxAge=2592e6}res.status(200).json({status:"OK"});return[2]}})})}exports.tryLogin=tryLogin;