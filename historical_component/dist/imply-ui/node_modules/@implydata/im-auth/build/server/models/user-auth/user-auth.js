"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var hash_1=require("../../utils/hash/hash");var DEFAULT_ADMIN_NAME="admin@admin.com";var DEFAULT_ADMIN_PROPERTIES={name:DEFAULT_ADMIN_NAME,hashStrategy:"none"};var UserAuth=function(_super){tslib_1.__extends(UserAuth,_super);function UserAuth(){return _super!==null&&_super.apply(this,arguments)||this}UserAuth.getBcryptUserAuth=function(name,pass){return tslib_1.__awaiter(this,void 0,void 0,function(){var hash;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,hash_1.bcryptHash(pass)];case 1:hash=_a.sent();return[2,new UserAuth({name:name,pass:hash,hashStrategy:"bcrypt"})]}})})};UserAuth.getValidUser=function(users,name,pass,shaSalt){var user=immutable_class_1.NamedArray.findByName(users,name);if(user)return user.passEquals(pass,shaSalt).then(function(equals){return equals?user:null});return Promise.resolve(null)};UserAuth.getDefaultAdmin=function(pass){var props=Object.assign({},DEFAULT_ADMIN_PROPERTIES,{pass:pass,hashStrategy:"none"});return new UserAuth(props)};UserAuth.fromJS=function(parameters){return new UserAuth(immutable_class_1.BaseImmutable.jsToValue(UserAuth.PROPERTIES,parameters))};UserAuth.prototype.getHashStrategy=function(){var hashStrategy=this.hashStrategy;return hashStrategy||UserAuth.DEFAULT_HASH_STRATEGY};UserAuth.prototype.passEquals=function(otherPass,shaSalt){if(!otherPass)return Promise.resolve(false);var strategy=this.getHashStrategy();var myPass=this.pass;switch(strategy){case"none":return Promise.resolve(this.pass===otherPass);case"sha2":return Promise.resolve(shaSalt?hash_1.sha2(shaSalt+otherPass)===myPass:hash_1.saltedSha2(otherPass)===myPass);case"bcrypt":return hash_1.bcryptCompare(otherPass,myPass);default:throw new Error("unrecognized strategy "+strategy)}};UserAuth.prototype.updatePass=function(pass){var _this=this;if(this.name===DEFAULT_ADMIN_PROPERTIES.name){throw new Error("Cannot change password for default admin")}var strategy=this.getHashStrategy();if(strategy==="sha2"){return Promise.resolve(this.changePass(hash_1.saltedSha2(pass)))}else if(strategy==="bcrypt"){return hash_1.bcryptHash(pass).then(function(h){return _this.changePass(h)})}else{return Promise.resolve(this.changePass(pass))}};UserAuth.prototype.toJS=function(){var _a=this,name=_a.name,hashStrategy=_a.hashStrategy;if(name===DEFAULT_ADMIN_PROPERTIES.name&&hashStrategy===DEFAULT_ADMIN_PROPERTIES.hashStrategy){return DEFAULT_ADMIN_PROPERTIES}return _super.prototype.toJS.call(this)};UserAuth.DEFAULT_HASH_STRATEGY="bcrypt";UserAuth.PROPERTIES=[{name:"name"},{name:"pass",defaultValue:null},{name:"hashStrategy",defaultValue:UserAuth.DEFAULT_HASH_STRATEGY}];return UserAuth}(immutable_class_1.BaseImmutable);exports.UserAuth=UserAuth;immutable_class_1.BaseImmutable.finalize(UserAuth);