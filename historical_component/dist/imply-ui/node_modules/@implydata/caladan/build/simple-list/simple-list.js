"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var Icons=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var button_1=require("../button/button");var svg_icon_1=require("../svg-icon/svg-icon");var bubble_button_1=require("../bubble-button/bubble-button");var single_value_modal_1=require("../single-value-modal/single-value-modal");function isGroup(e){return e&&hasOwnProperty(e,"children")}function isInGroup(e){return e&&e.group!==undefined}function isSimple(e){return e&&!hasOwnProperty(e,"children")}function getActualIndex(e,t){return e.slice(0,t).filter(isSimple).length}exports.getActualIndex=getActualIndex;function getReorderedArray(e,t,r,i,n){var o=e.map(function(e,t){var r={index:t};if(e.group)r.group=e.group;return r});if(isGroup(r)){var a=i!=="very_end"&&isGroup(i);var s=i!=="very_end"&&!isGroup(i)&&i.group;if(s||a&&n)return o;var l=i!=="very_end"?t.indexOf(i):t.length;var u=t.indexOf(r);var d=getActualIndex(t,t.indexOf(r.children[0]));var c=o.splice(d,r.children.length);l=getActualIndex(t,l);if(u<l)l-=r.children.length;if(n)l++;o.splice.apply(o,[l,0].concat(c))}else{var l=void 0;var p=void 0;var u=e.indexOf(r);var f=o[u];if(i!=="very_end"){l=t.indexOf(i);p=getActualIndex(t,l);if(isGroup(i)){f.group=n?i.title:undefined}else{p+=n?1:0;if(i.group){f.group=i.group}else{delete f.group}}}else{p=e.length;delete f.group}o=immutable_class_1.SimpleArray.moveIndex(o,u,p)}return o}exports.getReorderedArray=getReorderedArray;function itemsFromRows(e){var t=[];var r;e.forEach(function(e,i){if(e.group){if(r&&r.title===e.group){r.children.push(e)}else{r={title:e.group,children:[e]};t.push(r)}}else{r=undefined}t.push(e)});return t}exports.itemsFromRows=itemsFromRows;var ITEM_HEIGHT=55;var SimpleList=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.state={};return t}t.prototype.initFromProps=function(e){if(!e||!e.rows)return;this.setState({items:itemsFromRows(e.rows)})};t.prototype.componentWillMount=function(){this.initFromProps(this.props)};t.prototype.componentWillReceiveProps=function(e){this.initFromProps(e)};t.prototype.componentDidMount=function(){this.setState({visibleIndices:this.getVisibleIndices()})};t.prototype.isInTopHalf=function(e){var t=e.currentTarget.getBoundingClientRect();return beltful_1.EventUtils.getYFromEvent(e)-t.top<=t.height/2};t.prototype.dragStart=function(e,t){this.setState({draggedItem:e});var r=t.dataTransfer;r.effectAllowed="move";r.setData("text/html",e.title);beltful_1.DOMUtils.setDragGhost(r,e.title)};t.prototype.areEquals=function(e,t){if(!e&&!!t)return false;if(!!e&&!t)return false;if(t==="very_end")return false;if(e.title!==t.title)return false;if(e.group!==t.group)return false;return true};t.prototype.dragOver=function(e,t){t.preventDefault();var r=this.state,i=r.draggedItem,n=r.dropTarget,o=r.dropAfter;var a=!this.isInTopHalf(t);var s=!this.areEquals(e,n)||o!==a;var l=!isGroup(i)||!isInGroup(e);if(s&&l){this.setState({dropTarget:e,dropAfter:a})}};t.prototype.dragOverEnd=function(e){e.preventDefault();var t=this.state.items;var r=t.length;this.setState({dropTarget:"very_end"})};t.prototype.dragEnd=function(e){var t=this.props,r=t.rows,i=t.onReorder;var n=this.state,o=n.draggedItem,a=n.dropTarget,s=n.dropAfter,l=n.items;if(a){var u=getReorderedArray(r,l,o,a,s);i(u)}this.setState({draggedItem:undefined,dropTarget:undefined,dropAfter:false})};t.prototype.deleteItem=function(e){var t=this.props,r=t.rows,i=t.actions;if(!i||!i.remove)return;i.remove.callback((isSimple(e)?[e]:e.children).map(r.indexOf,r))};t.prototype.editItem=function(e){var t=this.props,r=t.rows,i=t.actions;if(isSimple(e)){if(i&&i.edit){i.edit.callback([r.indexOf(e)])}}else{this.setState({editedGroup:e})}};t.prototype.cancelGroupEdition=function(){this.setState({editedGroup:undefined})};t.prototype.saveGroupEdition=function(e){var t=this.props,r=t.onGroupRename,i=t.rows;var n=this.state.editedGroup;var o=n.children.map(i.indexOf,i);this.setState({editedGroup:undefined},function(){r(n.title,e,o)})};t.prototype.renderItemActions=function(e){var t=this;var r=this.props,i=r.actions,n=r.onGroupRename;if(!i)return null;var o=[];if((isSimple(e)||n)&&i.edit){var a=void 0;if(typeof i.edit.getIcon==="string"){a=i.edit.getIcon}else if(typeof i.edit.getIcon==="function"){a=i.edit.getIcon(e)}else{a=Icons.FULL_EDIT}var s=void 0;if(typeof i.edit.isDisabled==="boolean"){s=i.edit.isDisabled}else if(typeof i.edit.isDisabled==="function"){s=i.edit.isDisabled(e)}o.push(React.createElement(button_1.Button,{key:"edit",className:classNames({disabled:s}),type:"light",disabled:s,onClick:function(){return t.editItem(e)},svg:a}))}if(i.remove){var l=void 0;if(typeof i.remove.getIcon==="string"){l=i.remove.getIcon}else if(typeof i.remove.getIcon==="function"){l=i.remove.getIcon(e)}else{l=Icons.FULL_DELETE}var u=void 0;if(typeof i.remove.isDisabled==="boolean"){u=i.remove.isDisabled}else if(typeof i.remove.isDisabled==="function"){u=i.remove.isDisabled(e)}o.push(React.createElement(button_1.Button,{key:"remove",className:classNames({disabled:u}),type:"light",onClick:function(){return t.deleteItem(e)},svg:l,disabled:u}))}if(isSimple(e)&&n){var d=[{className:!!e.group?"read-only":"",label:"Add to a new group",onClick:function(){return t.addToANewGroup(e)}}];o.push(React.createElement(bubble_button_1.BubbleButton,{key:"more",stage:beltful_1.Stage.fromSize(200,200),type:"light",svg:Icons.FULL_MORE,items:d}))}return React.createElement("div",{className:"actions"},o)};t.prototype.renderVeryEnd=function(){var e=this;var t=this.state.dropTarget;return React.createElement("div",{className:classNames("item add-to-the-end",{"drop-before":t==="very_end"}),key:"add-to-the-end",onDragOver:function(t){return e.dragOverEnd(t)}})};t.prototype.addToANewGroup=function(e){this.setState({newGroupTarget:e})};t.prototype.renderNewGroupModal=function(){var e=this;var t=this.props,r=t.onGroupRename,i=t.rows;var n=this.state.newGroupTarget;var o=function(t){e.setState({newGroupTarget:undefined},function(){return r(null,t,[i.indexOf(n)])})};var a=function(){e.setState({newGroupTarget:undefined})};return React.createElement(single_value_modal_1.SingleValueModal,{className:"simple-list-modal",title:"New group",label:"Name",value:"New group",cancel:a,ok:o})};t.prototype.getVisibleIndices=function(){var e=this._list?Math.floor(this._list.scrollTop/ITEM_HEIGHT):0;var t=e+(this._list?Math.ceil(this._list.getBoundingClientRect().height/ITEM_HEIGHT):0);return{start:e,end:t}};t.prototype.updateVisibleIndices=function(){var e=this.state.visibleIndices;var t=this.getVisibleIndices(),r=t.start,i=t.end;if(!e||r!==e.start||i!==e.end){this.setState({visibleIndices:{start:r,end:i}})}};t.prototype.renderItems=function(){var e=this.props;var t=this.state,r=t.items,i=t.visibleIndices;if(!i)return[React.createElement("div",{key:"placeholder",style:{height:1e4}})];var n=i.start,o=i.end;var a=[React.createElement("div",{className:"buffer",key:"top-buffer",style:{height:ITEM_HEIGHT*n}})];for(var s=n;s<o;s++){a.push(this.renderItem(r[s],s))}a.push(React.createElement("div",{className:"buffer",key:"bottom-buffer",style:{height:ITEM_HEIGHT*(r.length-o)}}));return a};t.prototype.renderItem=function(e,t){var r=this;if(!e)return null;var i=this.props,n=i.onReorder,o=i.onGroupRename;var a=this.state,s=a.draggedItem,l=a.dropTarget,u=a.dropAfter;var d=classNames("item",{row:isSimple(e),group:isGroup(e),"pad-actions-icons":!!o,"in-group":isSimple(e)&&e.group!==undefined,sortable:!!n,"drop-before":l===e&&!u,"drop-after":l===e&&u,dragged:s===e});return React.createElement("div",{className:d,style:{height:ITEM_HEIGHT},key:"item-"+t,onDragOver:function(t){return r.dragOver(e,t)},draggable:!!n,onDragStart:function(t){return r.dragStart(e,t)}},n?React.createElement("div",{className:"drag-handle"},React.createElement(svg_icon_1.SvgIcon,{svg:Icons.DRAGGER})):null,isSimple(e)?e.icon?React.createElement(svg_icon_1.SvgIcon,{svg:e.icon}):null:React.createElement(svg_icon_1.SvgIcon,{svg:Icons.FOLDER}),React.createElement("div",{className:"text"},React.createElement("div",{className:"title"},e.title),isSimple(e)?React.createElement("div",{className:"description"},e.description):null),this.renderItemActions(e))};t.prototype.render=function(){var e=this;var t=this.state,r=t.items,i=t.editedGroup,n=t.newGroupTarget;return React.createElement("div",{className:"simple-list",ref:function(t){return e._list=t},onScroll:function(){return e.updateVisibleIndices()},onDragEnd:function(t){return e.dragEnd(t)}},this.renderItems(),this.renderVeryEnd(),i?React.createElement(single_value_modal_1.SingleValueModal,{className:"simple-list-modal",title:"Edit group",label:"Name",value:i.title,cancel:function(){return e.cancelGroupEdition()},ok:function(t){return e.saveGroupEdition(t)}}):null,n!==undefined?this.renderNewGroupModal():null)};return t}(React.Component);exports.SimpleList=SimpleList;