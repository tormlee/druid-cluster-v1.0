"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Qajax=require("qajax");Qajax.defaults.timeout=0;var reloadRequested=false;function reload(){if(reloadRequested)return;reloadRequested=true;window.location.reload(true)}function parseOrNull(e){try{return JSON.parse(e)}catch(e){return null}}function userAborted(e){return!e.getAllResponseHeaders()}var Ajax=function(){function e(){}e.addUpdateHandler=function(r){e.updateHandlers.push(r)};e.removeUpdateHandler=function(r){var t=e.updateHandlers.indexOf(r);if(t===-1)return;e.updateHandlers.splice(t,1)};e.triggerUpdate=function(){for(var r=0,t=e.updateHandlers;r<t.length;r++){var n=t[r];n()}};e.query=function(r){var t=r.method||"POST";var n=r.data||(t==="POST"?{}:null);if(n){if(e.version)n.version=e.version;if(e.settingsVersionGetter)n.settingsVersion=e.settingsVersionGetter()}return Promise.resolve(Qajax({url:r.url.replace("$mount",e.mountPoint),method:t,data:n}).timeout(6e4).then(Qajax.filterSuccess).then(Qajax.toJSON).then(function(r){if(r&&r.action==="update"){e.triggerUpdate()}return r}).catch(function(r){if(!r)return null;if(r instanceof Error){throw new Error("client timeout")}else{if(userAborted(r))return;var t=parseOrNull(r.responseText);if(t){if(t.action==="reload"){reload()}else if(t.action==="update"){e.triggerUpdate()}var n=new Error(t.message||t.error);n.jsonError=t;throw n}else{throw new Error(r.responseText||"connection fail")}}}))};e.addErrorMonitor=function(r){if(r===void 0){r="$mount/error"}var t=window.onerror;window.onerror=function(n,o,a,i,u){i=i||window.event&&window.event.errorCharacter;var s=u?u.stack:null;var l={message:n,file:o,line:a,column:i,stack:s};if(typeof console!=="undefined"){console.log("An error has occurred. Please include the below information in the issue:");console.log(JSON.stringify(l))}e.query({url:r,data:l});window.onerror=t;return false}};return e}();Ajax.updateHandlers=[];exports.Ajax=Ajax;