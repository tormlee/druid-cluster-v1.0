"use strict";var _this=this;var tslib_1=require("tslib");var toArray=require("stream-to-array");var nike_hercules_1=require("@implydata/nike-hercules");var plywood_druid_requester_1=require("plywood-druid-requester");var query_1=require("../../../common/models/query/query");var query_context_1=require("../../../common/models/query-context/query-context");var sql_cluster_1=require("../../../common/models/sql-cluster/sql-cluster");var LIMIT=500;var EXTENDED_LIMIT=5e3;var queryPromise;var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,o,u,a,c,n,i,l,q,m,y,d,_,v,k,p,f,h,w,x,D,I;return tslib_1.__generator(this,function(T){t=e,s=t.body,o=t.user,u=t.requestId,a=t.tracker,c=t.logger,n=t.decorators;i=s.query,l=s.cluster,q=s.queryContext,m=s.queryLimit,y=s.removeWrapper;i=query_1.Query.fromJS(i);d=l.queryHosts[0];_=null;if(l.decorator){if(!n)return[2,Promise.reject(new Error("must have decorators"))];v=n.getDecoratorModule(l.decorator);_=v.druidRequestDecoratorFactory(c,{options:l.decoratorOptions||{},cluster:l})}k={host:d,timeout:sql_cluster_1.SqlCluster.DEFAULT_TIMEOUT,protocol:l.protocol,ca:l.ca,requestDecorator:_,authToken:e.dbAuthToken,socksHost:l.socksHost,socksUsername:l.socksUsername,socksPassword:l.socksPassword};if(l.socksHost)k.socksHost=l.socksHost;p=m==="extended"?EXTENDED_LIMIT:LIMIT;f=i.value.trim().replace(/;+$/,"");if(!y&&!new RegExp(/^\s*explain\s+plan\s+for\s+/).test(f.toLowerCase())){h="select * from (\n"+f+"\n) limit "+p}else{h=f}w=query_context_1.QueryContext.fromJS(q).toDruidContext();x=plywood_druid_requester_1.druidRequesterFactory(k);queryPromise=toArray(x({query:{query:h,context:w}}));D={type:"sql-query",metric:"query/time",user:o?{name:o.name,email:o.email}:null,attr:{all_query_hosts:l.queryHosts,host:d,raw_query_string:i.value,query_string:h}};I=Date.now();queryPromise.then(function(e){D.attr.success="true";D.attr.requestId=u;D.value=Date.now()-I;a.track(D);r.send(e)}).catch(function(e){c.log("SQL query error: "+e.message);D.attr.success="false";D.attr.requestId=u;D.value=Date.now()-I;a.track(D);r.status(400).json({error:e.message})});return[2]})})});router.post("/cancel",function(e,r,t){var s=e,o=s.user,u=s.tracker;var a={type:"sql-query",metric:"cancel/count",user:o?{name:o.name,email:o.email}:null,value:1,attr:{}};a.attr.success="true";u.track(a);r.json({status:"OK"})});module.exports=router;