"use strict";var _this=this;var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var druid_requester_1=require("../../requester/druid-requester");var sql_data_source_1=require("../../../common/models/sql-data-source/sql-data-source");var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/load",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t=this;var s,u,a,n,o,i,l,c,_,d;return tslib_1.__generator(this,function(h){switch(h.label){case 0:s=e.requestId,u=e.sideDrawerItems,a=e.simplePivot,n=e.clusterActions,o=e.user,i=e.logger;return[4,n.getAllClusters()];case 1:l=h.sent();c=l.map(function(r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t=this;var s,u,a,n,o;return tslib_1.__generator(this,function(l){switch(l.label){case 0:s=r.queryHosts;if(!s||!s.length)return[2,null];u=new druid_requester_1.DruidRequester({cluster:r,logger:i,decorators:e.decorators},e.dbAuthToken);l.label=1;case 1:l.trys.push([1,3,,4]);return[4,u.getDataSources()];case 2:a=l.sent();return[3,4];case 3:n=l.sent();i.error("Error getting data sources: "+n);return[2,null];case 4:return[4,Promise.all((a||[]).map(function(e){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,s;return tslib_1.__generator(this,function(a){switch(a.label){case 0:a.trys.push([0,2,,3]);return[4,u.populateDataSourceColumns(new sql_data_source_1.SqlDataSource({name:e,clusterId:r.clusterId}))];case 1:t=a.sent();return[3,3];case 2:s=a.sent();i.error("Error populating data source: "+s);return[2,null];case 3:return[2,t]}})})}))];case 5:o=l.sent();r.dataSources=o.filter(Boolean);return[2,r]}})})});h.label=2;case 2:h.trys.push([2,4,,5]);return[4,Promise.all(c)];case 3:_=h.sent();return[3,5];case 4:d=h.sent();r.status(400).json({error:d.message});return[2];case 5:r.json([].concat.apply([],_.filter(Boolean)));return[2]}})})});module.exports=router;