"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var knex_store_1=require("./knex-store");var KnexSuperStore=function(_super){tslib_1.__extends(KnexSuperStore,_super);function KnexSuperStore(options){var _this=this;if(options.initArray&&options.wrappedInitArray){throw new Error("Cannot supply both init array and wrappedInitArray")}_this=_super.call(this,options)||this;_this.wrappedInitArray=options.wrappedInitArray;_this.accountId=options.accountId;_this.skipInitialization=options.skipInitialization;return _this}KnexSuperStore.prototype.initIfNeeded=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _this=this;var _a,keyFn,knex,table,initArray,logger,accountId,wrappedInitArray,skipInitialization;return tslib_1.__generator(this,function(_b){_a=this,keyFn=_a.keyFn,knex=_a.knex,table=_a.table,initArray=_a.initArray,logger=_a.logger,accountId=_a.accountId,wrappedInitArray=_a.wrappedInitArray,skipInitialization=_a.skipInitialization;if(skipInitialization)return[2,Promise.resolve()];if(this._initializedPromise)return[2,this._initializedPromise];this._initializedPromise=knex.schema.createTable(this.table,function(table){if(knex.client.config.client==="mysql"){table.charset("utf8mb4");table.collate("utf8mb4_bin")}table.string("key",120);table.string("accountId",120);table.bigInteger("created_at");table.bigInteger("updated_at");table.text("payload","longtext");table.primary(["key","accountId"])}).then(function(){if(!initArray.length&&(!wrappedInitArray||!wrappedInitArray.length))return null;var initRows=[];var now=Date.now();if(wrappedInitArray){initRows=wrappedInitArray.map(function(wrapped){var thing=wrapped.thing;return{key:keyFn(thing),accountId:wrapped.accountId,created_at:now,updated_at:now,payload:JSON.stringify(thing)}})}else{initRows=initArray.map(function(thing){var now=Date.now();return{key:keyFn(thing),accountId:accountId,created_at:now,updated_at:now,payload:JSON.stringify(thing)}})}logger.log("Inserting initial "+initRows.length+" row(s) into table "+table);return knex.batchInsert(table,initRows,500).then(function(){logger.log("Initial insert successful");return null},function(e){logger.error("Initial insert failed: "+e.message);throw e})},function(e){var friendlyError=knex_store_1.KnexStore.isFriendlyError(knex,e);if(friendlyError)return null;logger.error("Table creation failed: "+e.message);_this._initializedPromise=null});return[2,this._initializedPromise]})})};KnexSuperStore.prototype.trimOldestToMaxEntries=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,table,maxEntries,accountId,currentSize,trimBefore;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,knex=_a.knex,table=_a.table,maxEntries=_a.maxEntries,accountId=_a.accountId;if(!maxEntries)throw new Error("no max entries");return[4,this.size()];case 1:currentSize=_b.sent();if(currentSize<=maxEntries)return[2];return[4,knex.select("updated_at").from(table).where({accountId:accountId}).orderBy("updated_at","desc").offset(maxEntries-1).limit(1).then(function(rows){if(rows.length!==1)throw new Error("unexpected results");return rows[0]["updated_at"]})];case 2:trimBefore=_b.sent();return[2,knex(table).where({accountId:accountId}).whereRaw("updated_at < ?",[trimBefore]).del().then(function(n){return n})]}})})};KnexSuperStore.prototype.size=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,table,accountId;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,knex=_a.knex,table=_a.table,accountId=_a.accountId;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex(table).count("* as cnt").where({accountId:accountId}).then(function(rows){if(rows.length!==1)throw new Error("unexpected results");return Number(rows[0].cnt)})]}})})};KnexSuperStore.prototype.get=function(key){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,immutableClass,knex,table,accountId;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,immutableClass=_a.immutableClass,knex=_a.knex,table=_a.table,accountId=_a.accountId;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex.select("payload").from(table).where({key:key,accountId:accountId}).then(function(rows){if(!rows.length)return null;return immutableClass.fromJS(JSON.parse(rows[0].payload))})]}})})};KnexSuperStore.prototype.getFromAll=function(key){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,immutableClass,knex,table;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,immutableClass=_a.immutableClass,knex=_a.knex,table=_a.table;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex.select("payload").from(table).where({key:key}).then(function(rows){if(!rows.length)return null;return immutableClass.fromJS(JSON.parse(rows[0].payload))})]}})})};KnexSuperStore.prototype.getAll=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,immutableClass,knex,table,accountId;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,immutableClass=_a.immutableClass,knex=_a.knex,table=_a.table,accountId=_a.accountId;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex.select("payload").from(table).where({accountId:accountId}).orderBy("created_at","asc").then(function(rows){return rows.map(function(row){return immutableClass.fromJS(JSON.parse(row.payload))})})]}})})};KnexSuperStore.prototype.deleteByKey=function(key){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,table,accountId;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:this.ensureWritable();_a=this,knex=_a.knex,table=_a.table,accountId=_a.accountId;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex(table).where({key:key,accountId:accountId}).del().then(function(){return null})]}})})};KnexSuperStore.prototype.addOrUpdate=function(thing){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,keyFn,table,accountId,key,payload,inserted;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:this.ensureWritable();_a=this,knex=_a.knex,keyFn=_a.keyFn,table=_a.table,accountId=_a.accountId;return[4,this.initIfNeeded()];case 1:_b.sent();key=keyFn(thing);payload=JSON.stringify(thing);inserted=false;return[4,knex.transaction(function(trx){return trx.select("key").from(table).where({key:key,accountId:accountId}).then(function(rows){var now=Date.now();if(rows.length){return trx(table).where({key:key,accountId:accountId}).update({updated_at:now,payload:payload})}else{inserted=true;return trx(table).insert({key:key,accountId:accountId,created_at:now,updated_at:now,payload:payload})}})})];case 2:_b.sent();if(!(inserted&&this.maxEntries))return[3,4];return[4,this.trimOldestToMaxEntries()];case 3:_b.sent();_b.label=4;case 4:return[2]}})})};return KnexSuperStore}(knex_store_1.KnexStore);exports.KnexSuperStore=KnexSuperStore;