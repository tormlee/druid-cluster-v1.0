"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var Icons=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var button_1=require("../button/button");var svg_icon_1=require("../svg-icon/svg-icon");var bubble_menu_1=require("../bubble-menu/bubble-menu");var single_value_modal_1=require("../single-value-modal/single-value-modal");function isGroup(e){return e&&hasOwnProperty(e,"children")}function isInGroup(e){return e&&e.group!==undefined}function isSimple(e){return e&&!hasOwnProperty(e,"children")}function getActualIndex(e,t){return e.slice(0,t).filter(isSimple).length}exports.getActualIndex=getActualIndex;function getReorderedArray(e,t,r,n,i){var o=e.map(function(e,t){return{group:e.group,index:t}});var a=n==="very_end";var s=n!=="very_end"&&isGroup(n);var l=n!=="very_end"&&!isGroup(n)&&n.group;if(isGroup(r)){if(l||s&&i)return o;var u=n!=="very_end"?t.indexOf(n):t.length;var d=t.indexOf(r);var p=getActualIndex(t,t.indexOf(r.children[0]));if(d<u)u-=r.children.length+(i?0:1);var c=o.splice(p,r.children.length);o.splice.apply(o,[u,0].concat(c))}else{var u=void 0;var m=void 0;var d=e.indexOf(r);var f=o[d];if(n!=="very_end"){u=t.indexOf(n);m=getActualIndex(t,u);if(isGroup(n)){f.group=i?n.title:undefined}else{m+=i?1:0;f.group=n.group}}else{m=e.length;f.group=undefined}o=immutable_class_1.SimpleArray.moveIndex(o,d,m)}return o}exports.getReorderedArray=getReorderedArray;function itemsFromRows(e){var t=[];var r;e.forEach(function(e,n){if(e.group){if(r&&r.title===e.group){r.children.push(e)}else{r={title:e.group,children:[e]};t.push(r)}}else{r=undefined}t.push(e)});return t}exports.itemsFromRows=itemsFromRows;var SimpleList=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.state={};return t}t.prototype.initFromProps=function(e){if(!e||!e.rows)return;this.setState({items:itemsFromRows(e.rows)})};t.prototype.componentWillMount=function(){this.initFromProps(this.props)};t.prototype.componentWillReceiveProps=function(e){this.initFromProps(e)};t.prototype.isInTopHalf=function(e){var t=e.currentTarget.getBoundingClientRect();return beltful_1.EventUtils.getYFromEvent(e)-t.top<=t.height/2};t.prototype.dragStart=function(e,t){this.setState({draggedItem:e});var r=t.dataTransfer;r.effectAllowed="move";r.setData("text/html",e.title);beltful_1.DOMUtils.setDragGhost(r,e.title)};t.prototype.areEquals=function(e,t){if(!e&&!!t)return false;if(!!e&&!t)return false;if(t==="very_end")return false;if(e.title!==t.title)return false;if(e.group!==t.group)return false;return true};t.prototype.dragOver=function(e,t){t.preventDefault();var r=this.state,n=r.draggedItem,i=r.dropTarget,o=r.dropAfter;var a=!this.isInTopHalf(t);var s=!this.areEquals(e,i)||o!==a;var l=!isGroup(n)||!isInGroup(e);if(s&&l){this.setState({dropTarget:e,dropAfter:a})}};t.prototype.dragOverEnd=function(e){e.preventDefault();var t=this.state.items;var r=t.length;this.setState({dropTarget:"very_end"})};t.prototype.dragEnd=function(e){var t=this.props,r=t.rows,n=t.onReorder;var i=this.state,o=i.draggedItem,a=i.dropTarget,s=i.dropAfter,l=i.items;if(a){var u=getReorderedArray(r,l,o,a,s);n(u)}this.setState({draggedItem:undefined,dropTarget:undefined,dropAfter:false})};t.prototype.deleteItem=function(e){var t=this.props,r=t.rows,n=t.actions;if(!n||!n.remove)return;n.remove.callback((isSimple(e)?[e]:e.children).map(r.indexOf,r))};t.prototype.editItem=function(e){var t=this.props,r=t.rows,n=t.actions;if(isSimple(e)){if(n&&n.edit){n.edit.callback([r.indexOf(e)])}}else{this.setState({editedGroup:e})}};t.prototype.cancelGroupEdition=function(){this.setState({editedGroup:undefined})};t.prototype.saveGroupEdition=function(e){var t=this.props,r=t.onGroupRename,n=t.rows;var i=this.state.editedGroup;var o=i.children.map(n.indexOf,n);this.setState({editedGroup:undefined},function(){r(i.title,e,o)})};t.prototype.toggleMenu=function(e,t){var r=this.state.moreMenuOpenOn;var n=r&&r.item===e;this.setState({moreMenuOpenOn:n?undefined:{item:e,target:t.target}})};t.prototype.renderItemActions=function(e){var t=this;var r=this.props,n=r.actions,i=r.onGroupRename;if(!n)return null;var o=[];if((isSimple(e)||i)&&n.edit){var a=void 0;if(typeof n.edit.getIcon==="string"){a=n.edit.getIcon}else if(typeof n.edit.getIcon==="function"){a=n.edit.getIcon(e)}else{a=Icons.FULL_EDIT}var s=void 0;if(typeof n.edit.isDisabled==="boolean"){s=n.edit.isDisabled}else if(typeof n.edit.isDisabled==="function"){s=n.edit.isDisabled(e)}o.push(React.createElement(button_1.Button,{key:"edit",className:classNames({disabled:s}),type:"light",disabled:s,onClick:function(){return t.editItem(e)},svg:a}))}if(n.remove){var l=void 0;if(typeof n.remove.getIcon==="string"){l=n.remove.getIcon}else if(typeof n.remove.getIcon==="function"){l=n.remove.getIcon(e)}else{l=Icons.FULL_DELETE}var u=void 0;if(typeof n.remove.isDisabled==="boolean"){u=n.remove.isDisabled}else if(typeof n.remove.isDisabled==="function"){u=n.remove.isDisabled(e)}o.push(React.createElement(button_1.Button,{key:"remove",className:classNames({disabled:u}),type:"light",onClick:function(){return t.deleteItem(e)},svg:l,disabled:u}))}if(isSimple(e)&&i){o.push(React.createElement(button_1.Button,{key:"more",type:"light",onClick:function(r){return t.toggleMenu(e,r)},svg:Icons.FULL_MORE}))}return React.createElement("div",{className:"actions"},o)};t.prototype.renderItem=function(e,t){var r=this;var n=this.props,i=n.onReorder,o=n.onGroupRename;var a=this.state,s=a.draggedItem,l=a.dropTarget,u=a.dropAfter;var d=classNames("item",{row:isSimple(e),group:isGroup(e),"pad-actions-icons":!!o,"in-group":isSimple(e)&&e.group!==undefined,sortable:!!i,"drop-before":l===e&&!u,"drop-after":l===e&&u,dragged:s===e});return React.createElement("div",{className:d,key:"item-"+t,onDragOver:function(t){return r.dragOver(e,t)},draggable:!!i,onDragStart:function(t){return r.dragStart(e,t)}},i?React.createElement("div",{className:"drag-handle"},React.createElement(svg_icon_1.SvgIcon,{svg:Icons.DRAGGER})):null,isSimple(e)?e.icon?React.createElement(svg_icon_1.SvgIcon,{svg:e.icon}):null:React.createElement(svg_icon_1.SvgIcon,{svg:Icons.FOLDER}),React.createElement("div",{className:"text"},React.createElement("div",{className:"title"},e.title),isSimple(e)?React.createElement("div",{className:"description"},e.description):null),this.renderItemActions(e))};t.prototype.renderVeryEnd=function(){var e=this;var t=this.state.dropTarget;return React.createElement("div",{className:classNames("item add-to-the-end",{"drop-before":t==="very_end"}),key:"add-to-the-end",onDragOver:function(t){return e.dragOverEnd(t)}})};t.prototype.addToANewGroup=function(e){this.setState({moreMenuOpenOn:undefined,newGroupTarget:e})};t.prototype.renderMoreMenu=function(){var e=this;var t=this.state.moreMenuOpenOn;if(!t)return null;var r=function(){return e.setState({moreMenuOpenOn:undefined})};return React.createElement(bubble_menu_1.BubbleMenu,{direction:"down",className:"simple-list-menu",stage:beltful_1.Stage.fromSize(200,200),openOn:t.target,onClose:r},React.createElement("ul",{className:"bubble-list"},React.createElement("li",{className:!!t.item.group?"disabled":"",onClick:function(){return e.addToANewGroup(t.item)}},"Add to a new group")))};t.prototype.renderNewGroupModal=function(){var e=this;var t=this.props,r=t.onGroupRename,n=t.rows;var i=this.state.newGroupTarget;var o=function(t){e.setState({newGroupTarget:undefined},function(){return r(null,t,[n.indexOf(i)])})};var a=function(){e.setState({newGroupTarget:undefined})};return React.createElement(single_value_modal_1.SingleValueModal,{className:"simple-list-modal",title:"New group",label:"Name",value:"New group",cancel:a,ok:o})};t.prototype.render=function(){var e=this;var t=this.state,r=t.items,n=t.editedGroup,i=t.newGroupTarget;if(!r||!r.length)return null;return React.createElement("div",{className:"simple-list",ref:"list",onDragEnd:function(t){return e.dragEnd(t)}},r.map(this.renderItem,this),this.renderVeryEnd(),this.renderMoreMenu(),n?React.createElement(single_value_modal_1.SingleValueModal,{className:"simple-list-modal",title:"Edit group",label:"Name",value:n.title,cancel:function(){return e.cancelGroupEdition()},ok:function(t){return e.saveGroupEdition(t)}}):null,i!==undefined?this.renderNewGroupModal():null)};return t}(React.Component);exports.SimpleList=SimpleList;