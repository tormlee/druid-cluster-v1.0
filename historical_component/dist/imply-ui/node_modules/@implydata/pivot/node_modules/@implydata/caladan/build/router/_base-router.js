"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var React=require("react");var _router_core_1=require("./_router-core");var BaseRouter=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t._mounted=false;t._deferredCoreChange=false;t._loops=0;t.events=[];t.state={};t.globalHashChangeListener=t.globalHashChangeListener.bind(t);window.setInterval(function(){return t._loops=0},1e4);return t}t.prototype.componentDidMount=function(){var e=this;this._mounted=true;this.events.forEach(function(t){return window.addEventListener(t,e.globalHashChangeListener)});this.onPathChange(this.getCurrentPath())};t.prototype.componentWillUnmount=function(){var e=this;this._mounted=false;this.events.forEach(function(t){return window.removeEventListener(t,e.globalHashChangeListener)})};t.prototype.globalHashChangeListener=function(){var e=this.props.rootFragment;var t=this.getCurrentPath();if(e&&this.removeRootFragment(t)===t)return;this.onPathChange(t)};t.prototype.parsePath=function(e){if(!e)return[];var t=this.removeRootFragment(e).split(_router_core_1.RouterCore.FRAGMENTS_SEPARATOR);return t.filter(Boolean)};t.prototype.componentWillReceiveProps=function(e){this.globalHashChangeListener()};t.prototype.onCoreChange=function(e){var t=this.props.rootFragment;var r=[t].concat(e).filter(Boolean);if(_router_core_1.RouterCore.areSameCrumbs(r,this.state.fragments))return;if(!this._mounted){this._deferredCoreChange=true;return}this.replacePath([t].concat(e).filter(Boolean).join(_router_core_1.RouterCore.FRAGMENTS_JOINER))};t.prototype.onPathChange=function(e){var t=this.props.onURLChange;if(this._loops++>100)throw new Error("Too many redirections");var r=this.sanitizePath(e);if(e!==r){this.replacePath(r);return}var o=this.parsePath(e);if(this._deferredCoreChange||!_router_core_1.RouterCore.areSameCrumbs(this.state.fragments,o)){this._deferredCoreChange=false;this.setState({fragments:o},function(){return t&&t(o)})}};t.prototype.render=function(){var e=this.props;var t=this.state.fragments;return React.createElement(_router_core_1.RouterCore,{onChange:this.onCoreChange.bind(this),crumbs:t},this.props.children)};return t}(React.Component);exports.BaseRouter=BaseRouter;