"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var timekeeper_1=require("../timekeeper/timekeeper");var SplitCombine=function(e){tslib_1.__extends(t,e);function t(t){var i=e.call(this,t)||this;i.dimension=t.dimension;if(!i.dimension)throw new Error("must have dimension name");return i}t.isSplitCombine=function(e){return e instanceof t};t.fromDimensionAndFilterAndMeasure=function(e,i,n){return new t({dimension:e.name,bucketAction:e.canAutoBucket()?t.calculateBucketGivenFilter(i,e).expression:null,sortAction:t.calculateSortOn(e,n),limitAction:null})};t.fromJS=function(e){if(typeof e==="string"){return new t({dimension:e,bucketAction:null,sortAction:null,limitAction:null})}if(!e.dimension&&e.expression){var i=e.expression;if(i.op==="ref"){e.dimension=i.name}else{throw new Error("can not figure out complex split: "+JSON.stringify(i))}}var n=immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e);var o=e.dimension;n.dimension=o;if(e.bucketAction)n.bucketAction=plywood_1.Expression.fromJS(e.bucketAction);if(e.sortAction)n.sortAction=plywood_1.SortExpression.fromJS(e.sortAction);if(e.limitAction)n.limitAction=plywood_1.LimitExpression.fromJS(e.limitAction);return new t(n)};t.calculateBucketGivenFilter=function(e,t){var i=e.getSpecificFilter(timekeeper_1.Timekeeper.globalNow(),timekeeper_1.Timekeeper.globalNow(),chronoshift_1.Timezone.UTC);if(!t||!t.isBucketable())return null;var n=t.granularities;var o=t.getKind();var r=i.getLiteralSet(t.name);var s=r?r.extent():null;if(s){return t.getBucketedBy().getRecommendationForRange(s,5,n)}else{return t.getBucketedBy().getDefaultGranularity(o,n)}};t.calculateSortOn=function(e,t){if(e.isContinuous()){return plywood_1.Expression._.sort(plywood_1.$(e.name),plywood_1.SortExpression.ASCENDING)}else if(e.getKind()==="boolean"){return plywood_1.Expression._.sort(plywood_1.$(e.name),plywood_1.SortExpression.DESCENDING)}else{return plywood_1.Expression._.sort(plywood_1.$(t),plywood_1.SortExpression.DESCENDING)}};t.prototype.sameOnDimension=function(e){var i=this.dimension;return t.isSplitCombine(e)&&i===e.dimension};t.prototype.isSortOnSelfAscending=function(){var e=this.sortAction;return this.isSortOnSelf()&&e.direction===plywood_1.SortExpression.ASCENDING};t.prototype.toSplitExpression=function(e){var t=this,i=t.dimension,n=t.bucketAction;var o=immutable_class_1.NamedArray.findByName(e,i);if(!o)throw new Error("split on unknown dimension '"+i+"'");var r=o.expression;return n?r.performAction(n):r};t.prototype.toKey=function(){return this.dimension};t.prototype.isSortOnSelf=function(){var e=this,t=e.dimension,i=e.sortAction;if(!i)return false;return i.refName()===t};t.prototype.getSortAction=function(){var e=this,t=e.dimension,i=e.sortAction;if(i)return i;return plywood_1.Expression._.sort(plywood_1.$(t),plywood_1.SortExpression.ASCENDING)};t.prototype.getNormalizedSortAction=function(){var e=this.sortAction;if(this.isSortOnSelf()){return e.changeExpression(plywood_1.$(t.SORT_ON_DIMENSION_PLACEHOLDER))}return e};t.prototype.changeSortActionFromNormalized=function(e){if(e.refName()===t.SORT_ON_DIMENSION_PLACEHOLDER){var i=this.dimension;e=e.changeExpression(plywood_1.$(i))}return this.changeSortAction(e)};t.prototype.changeLimit=function(e){var t=e===null?null:plywood_1.Expression._.limit(e);return this.changeLimitAction(t)};t.prototype.timezoneDependant=function(){var e=this.bucketAction;if(!e)return false;return e.needsEnvironment()};t.prototype.getDimension=function(e){return immutable_class_1.NamedArray.findByName(e,this.dimension)};t.prototype.getTitle=function(e){var t=this.getDimension(e);return(t?t.title:"?")+this.getBucketTitle()};t.prototype.getBucketTitle=function(){var e=this.bucketAction;if(e instanceof plywood_1.TimeBucketExpression){return" ("+e.duration.getDescription(true)+")"}else if(e instanceof plywood_1.NumberBucketExpression){return" (by "+e.size+")"}return""};t.prototype.isBucketed=function(){return this.bucketAction!=null};t.prototype.isBucketable=function(e){return this.getDimension(e).isBucketable()};t.prototype.addBucketGivenFilter=function(e,i){var n=this.getDimension(i);var o=t.calculateBucketGivenFilter(e,n).expression;return this.changeBucketAction(o)};t.SORT_ON_DIMENSION_PLACEHOLDER="__PIVOT_SORT_ON_DIMENSIONS__";t.EFFECTIVE_NO_LIMIT=plywood_1.Expression._.limit(1e4);t.PROPERTIES=[{name:"dimension"},{name:"sortAction",immutableClass:plywood_1.SortExpression,defaultValue:null},{name:"bucketAction",immutableClass:plywood_1.Expression,defaultValue:null},{name:"limitAction",immutableClass:plywood_1.LimitExpression,defaultValue:null}];return t}(immutable_class_1.BaseImmutable);exports.SplitCombine=SplitCombine;immutable_class_1.BaseImmutable.finalize(SplitCombine);