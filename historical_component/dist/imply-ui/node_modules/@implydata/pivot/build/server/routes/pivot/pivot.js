"use strict";var _this=this;var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var nike_hercules_1=require("@implydata/nike-hercules");var views_1=require("../../views");var models_1=require("../../../common/models");var router=nike_hercules_1.HerculesServer.makeRouter();function getUsers(e){if(e.authorizer){return e.authorizer.getAllUsers()}else{return Promise.resolve([])}}function getAppSettings(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,t,s,n,o,a,i,u;return tslib_1.__generator(this,function(c){switch(c.label){case 0:r=e.user;return[4,Promise.all([e.settingsVersionStore.get("x"),e.customizationStore.get("x"),e.clusterStore.size(),e.dataCubeStore.getAll(),e.collectionStore.getAll(),getUsers(e)])];case 1:t=c.sent(),s=t[0],n=t[1],o=t[2],a=t[3],i=t[4],u=t[5];return[2,new models_1.AppSettings({version:s,customization:n||models_1.Customization.BLANK,numClusters:o,dataCubes:a,collections:i,users:u}).constrainToUser(r)]}})})}router.post("/cluster-sources",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,o;return tslib_1.__generator(this,function(a){switch(a.label){case 0:a.trys.push([0,2,,3]);return[4,e.clusterStore.getAll()];case 1:t=a.sent();return[3,3];case 2:s=a.sent();r.sendError({status:500,error:"could not get clusters",e:s});return[2];case 3:a.trys.push([3,5,,6]);return[4,e.clusterActions.getAllClusterSources(t,e.dbAuthToken)];case 4:n=a.sent();return[3,6];case 5:o=a.sent();r.sendError({status:500,error:"could not get cluster sources",e:o});return[2];case 6:r.send({clusterSources:n});return[2]}})})});router.post("/attributes",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,o,a,i,u,c;return tslib_1.__generator(this,function(l){switch(l.label){case 0:t=e.body,s=t.source,n=t.cluster,o=t.clusterName;if(typeof s!=="string"){r.status(400).send({error:"must have a source"});return[2]}a=null;if(!(typeof o!=="string"))return[3,1];if(typeof n==="undefined"){r.status(400).send({error:"must have a clusterName or cluster"});return[2]}try{a=models_1.Cluster.fromJS(n)}catch(e){r.status(400).send({error:"invalid cluster",message:e.message});return[2]}return[3,7];case 1:if(!(o!=="native"))return[3,6];l.label=2;case 2:l.trys.push([2,4,,5]);return[4,e.clusterStore.get(o)];case 3:a=l.sent();return[3,5];case 4:i=l.sent();r.status(501).send({error:"issue getting cluster",message:i.message});return[2];case 5:if(!a){r.status(404).send({error:"cluster not found"});return[2]}return[3,7];case 6:r.status(501).send({error:"can not handle native (file) cluster for now"});return[2];case 7:l.trys.push([7,9,,10]);return[4,e.clusterActions.getAllAttributes(a,s,e.dbAuthToken)];case 8:u=l.sent();return[3,10];case 9:c=l.sent();r.sendError({status:500,error:"could not get attributes",e:c});return[2];case 10:r.send({attributes:u});return[2]}})})});router.post("/set-favorites",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,o,a;return tslib_1.__generator(this,function(i){switch(i.label){case 0:t=e.user,s=e.authorizer;n=e.body.favorites;if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}if(!t){r.status(403).send({error:"no user"});return[2]}if(!s){r.status(403).send({error:"no authorizer"});return[2]}if(!Array.isArray(n)||!n.every(function(e){return typeof e==="string"})){r.status(400).send({error:"bad favorites"});return[2]}o=t.changeFavorites(n);i.label=1;case 1:i.trys.push([1,3,,4]);return[4,s.addOrUpdateUser(o)];case 2:i.sent();return[3,4];case 3:a=i.sent();r.sendError({status:500,error:"could not save",e:a});return[2];case 4:e.user=o;e.session.user=o.toJS();r.send({favorites:o.getFavorites()});return[2]}})})});router.post("/load",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s;return tslib_1.__generator(this,function(n){switch(n.label){case 0:if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}t=null;n.label=1;case 1:n.trys.push([1,3,,4]);return[4,getAppSettings(e)];case 2:t=n.sent();return[3,4];case 3:s=n.sent();r.sendError({status:500,error:"could not get settings",e:s});return[2];case 4:r.send({clientSettings:t});return[2]}})})});router.post("/change",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,o,a,i,u,c,l,f,d,g,b,h,l,_,p,m,v,y,g,_,p,S,w,A,C,D;return tslib_1.__generator(this,function(E){switch(E.label){case 0:t=e.user;s=e.body,n=s.dataCubeDiffs,o=s.collectionDiffs;try{a=immutable_class_1.Diff.inflateFromJSs(models_1.DataCube,n)}catch(e){r.status(400).send({error:"bad dataCubeDiffs",message:"dataCubeDiffs not an array"});return[2]}try{i=immutable_class_1.Diff.inflateFromJSs(models_1.Collection,o)}catch(e){r.status(400).send({error:"bad collectionDiffs",message:"collectionDiffs not an array"});return[2]}if(!t.isSuperAdmin()){for(u=0,c=a;u<c.length;u++){l=c[u];if(!l.before)continue;if(!l.before.getModifyAccess().hasAccess(t)){r.status(403).send({error:"no access to data cube"});return[2]}}for(f=0,d=i;f<d.length;f++){g=d[f];if(!g.before)continue;if(!g.before.getModifyAccess().hasAccess(t)){r.status(403).send({error:"no access to collection"});return[2]}}}E.label=1;case 1:E.trys.push([1,16,,17]);b=0,h=a;E.label=2;case 2:if(!(b<h.length))return[3,8];l=h[b];return[4,e.dataCubeStore.applyDiff(l)];case 3:_=E.sent();if(!_)return[3,4];if(l.after){p=l.before?"updating":"creating";e.logger.log(p+" dataCube: "+JSON.stringify(l.after))}return[3,7];case 4:if(!l.before)return[3,6];return[4,e.dataCubeStore.get(l.before.name)];case 5:m=E.sent();console.error("Diff not accepted:");if(m){console.error("Existing: "+JSON.stringify(m));console.error("DfBefore: "+JSON.stringify(l.before))}else{console.error("Before does not exist ("+l.before.name+")")}E.label=6;case 6:throw new Error("can not apply data cube diff "+l.getName());case 7:b++;return[3,2];case 8:v=0,y=i;E.label=9;case 9:if(!(v<y.length))return[3,15];g=y[v];return[4,e.collectionStore.applyDiff(g)];case 10:_=E.sent();if(!_)return[3,11];if(g.after){p=g.before?"updating":"creating";e.logger.log(p+" collection: "+JSON.stringify(g.after))}return[3,14];case 11:if(!g.before)return[3,13];return[4,e.collectionStore.get(g.before.name)];case 12:S=E.sent();console.error("Diff not accepted:");if(S){console.error("Existing: "+JSON.stringify(S));console.error("DfBefore: "+JSON.stringify(g.before))}else{console.error("Before does not exist ("+g.before.name+")")}E.label=13;case 13:throw new Error("can not apply collection diff "+g.getName());case 14:v++;return[3,9];case 15:return[3,17];case 16:w=E.sent();r.status(409).send({error:"conflict",message:w.message,action:"update"});return[2];case 17:E.trys.push([17,19,,20]);return[4,e.settingsVersionStore.addOrUpdate(models_1.SettingsVersion.current())];case 18:E.sent();return[3,20];case 19:A=E.sent();return[3,20];case 20:C=null;E.label=21;case 21:E.trys.push([21,23,,24]);return[4,getAppSettings(e)];case 22:C=E.sent();return[3,24];case 23:D=E.sent();r.sendError({status:500,error:"could not get settings",e:D});return[2];case 24:r.send({clientSettings:C});return[2]}})})});router.get("/?*",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,o,a,i,u;return tslib_1.__generator(this,function(c){switch(c.label){case 0:c.trys.push([0,2,,3]);return[4,getAppSettings(e)];case 1:t=c.sent();return[3,3];case 2:s=c.sent();r.sendError({status:500,error:"could not get settings",e:s});return[2];case 3:n=null;if(e.licenseManager){if(e.licenseManager.isExpired()){n="expired"}else if(e.licenseManager.isWelcomeNeeded()){n="welcome";e.licenseManager.welcomeShown()}}o=null;if(!(a=e.path.match(/\/[dc]\/([0-9a-f]{18,18})(?:\/|$)/)))return[3,7];i=a[1];c.label=4;case 4:c.trys.push([4,6,,7]);return[4,e.urlStore.get(i)];case 5:o=c.sent();if(!o){e.logger.log("Could not look up URL hash: '"+i+"'")}return[3,7];case 6:u=c.sent();e.logger.error("Failed to look up URL: "+u.message);return[3,7];case 7:r.send(views_1.pivotLayout({version:e.version,mountPoint:e.mountPoint,title:t.customization.getTitleWithVersion(e.version),user:e.user,appSettings:t,urlEssence:o,timekeeper:e.timekeeperCache.getTimekeeper(),stateful:e.stateful,specialRun:n,hasQueryCache:Boolean(e.queryCache),logoutHref:e.logoutHref,launcherHref:e.launcherHref,settingsHref:e.settingsHref}));return[2]}})})});module.exports=router;