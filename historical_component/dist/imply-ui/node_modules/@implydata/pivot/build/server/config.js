"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var fs=require("fs-extra");var hasOwnProp=require("has-own-prop");var nopt=require("nopt");var path=require("path");var yaml=require("js-yaml");var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var models_1=require("@implydata/im-auth/build/server/models");var general_1=require("../common/utils/general/general");var models_2=require("./models");var usage_1=require("./usage");var models_3=require("../common/models");var settings_location_1=require("./models/settings-location/settings-location");var mysql_state_store_1=require("./utils/mysql-state-store/mysql-state-store");var state_store_options_1=require("./models/state-store-options/state-store-options");function zeroOne(e){return Number(Boolean(e))}function appSettingsJSHasOnLoad(e){if(e.sourceReintrospectOnLoad||e.sourceListRefreshOnLoad)return true;if(Array.isArray(e.clusters)){return e.clusters.some(function(e){return e.sourceReintrospectOnLoad||e.sourceListRefreshOnLoad})}return false}function readOldSchoolSettings(e,r){return fs.readFile(e,"utf-8").catch(function(e){if(e.code!=="ENOENT")throw e;return""}).then(function(e){switch(r){case"json-pretty":case"json":return JSON.parse(e||"{}");case"yaml":return yaml.safeLoad(e);default:throw new Error("unsupported format '"+r+"'")}})}function fromJSSettings(e){var r={};if(Array.isArray(e.userAuths)||Array.isArray(e.usersAuth)){r.userAuths=(e.userAuths||e.usersAuth).map(function(e){return models_1.UserAuth.fromJS(e)})}if(Array.isArray(e.users)){r.users=e.users.map(function(e){return im_auth_1.User.fromJS(e)})}if(e.customization){r.customization=models_3.Customization.fromJS(e.customization)}if(Array.isArray(e.clusters)){r.clusters=e.clusters.map(function(e){return models_3.Cluster.fromJS(e)})}else if(hasOwnProp(e,"druidHost")||hasOwnProp(e,"brokerHost")){var t=JSON.parse(JSON.stringify(e));t.name="druid";t.type="druid";t.host=t.druidHost||t.brokerHost;r.clusters=[models_3.Cluster.fromJS(t)]}if(Array.isArray(e.dataCubes||e.dataSources)){r.dataCubes=(e.dataCubes||e.dataSources).map(function(e){return models_3.DataCube.fromJS(e)})}if(Array.isArray(e.collections)){r.collections=e.collections.map(function(e){return models_3.Collection.fromJS(e)})}return r}function parseArgs(e){return nopt({help:Boolean,version:Boolean,verbose:Boolean,port:Number,"server-host":String,"server-root":String,"settings-location":String,examples:Boolean,config:String,auth:String,file:String,druid:String,postgres:String,mysql:String,user:String,password:String,database:String,"socks-host":String,"socks-username":String,"socks-password":String,"user-mode":String,license:String},{v:["--verbose"],p:["--port"],c:["--config"],f:["--file"],d:["--druid"],u:["--user-mode"],l:["--license"]},e)}function getConfig(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,t,s,o,i,a,n,u,l,c,f,m,g,d,p,h,S,_,v,y,b,C,q,O,k,w,A,J,x,L;return tslib_1.__generator(this,function(j){switch(j.label){case 0:r=parseArgs(e);if(r["help"]){return[2,{exitCode:0,message:usage_1.USAGE}]}t=path.join(__dirname,"../../package.json");j.label=1;case 1:j.trys.push([1,3,,4]);return[4,fs.readFile(t,"utf-8")];case 2:s=j.sent();return[3,4];case 3:o=j.sent();return[2,{exitCode:1,message:"Could not find package file at "+t}];case 4:try{i=JSON.parse(s)}catch(e){return[2,{exitCode:1,message:"Could not parse package file at "+t}]}if(typeof i.version!=="string"){return[2,{exitCode:1,message:"Invalid package file at "+t+" (version must be a string)"}]}a=i.version;if(r["version"]){return[2,{exitCode:0,message:a}]}n=["config","examples","file","druid","postgres","mysql"];u=general_1.arraySum(n.map(function(e){return zeroOne(r[e])}));if(u===0){r["settings-location"]="./pivot-settings.json"}if(u>1){l=["only one of --"+n.join(", --")+" can be given on the command line"];if(r["druid"]&&r["config"]){l.push("Looks like you are using --config and --druid in conjunction with each other");l.push("This usage is no longer supported. If you are migrating from Pivot < 0.9.x");l.push("Please visit: (http://pivot.imply.io/pivot-0.9.x-migration)")}return[2,{exitCode:1,message:l.join("\n")}]}c=r["config"];if(r["examples"]){c=path.join(__dirname,"../../config-examples.yaml")}if(!c)return[3,9];j.label=5;case 5:j.trys.push([5,7,,8]);return[4,fs.readFile(c,"utf-8")];case 6:m=j.sent();f=yaml.safeLoad(m);f=general_1.inlineVars(f,process.env);nike_hercules_1.LOGGER.log("Using config "+c);return[3,8];case 7:g=j.sent();return[2,{exitCode:1,message:"Could not load config from '"+c+"': "+g.message}];case 8:return[3,10];case 9:f={};j.label=10;case 10:if(r["verbose"])f.verbose=r["verbose"];if(r["port"])f.port=r["port"];if(r["server-host"])f.serverHost=r["server-host"];if(r["server-root"])f.serverRoot=r["server-root"];if(r["cookie-max-age"])f.cookieMaxAge=r["cookie-max-age"];if(r["user-mode"])f.userMode=r["user-mode"];if(r["license"])f.licenseFile=r["license"];d=models_2.ServerConfig.fromJS(f,{serverConfigFilePath:c});p={};h=["druid","postgres","mysql"];S=f.settingsLocation;if(S&&S.location==="file"&&!S.uri){S.uri=d.resolvePath("$var/pivot-settings.json")}if(r["settings-location"]){S={location:"file",format:"json-pretty",uri:r["settings-location"]}}if(!S)return[3,17];_=settings_location_1.SettingsLocation.fromJS(S);v=_.getLocation();switch(v){case"file":return[3,11];case"mysql":return[3,13]}return[3,15];case 11:y=d.resolvePath(_.uri);b=fromJSSettings;return[4,readOldSchoolSettings(y,_.getFormat())];case 12:p=b.apply(void 0,[j.sent()]);if(!d.stateStore){nike_hercules_1.LOGGER.log("Rewriting file settingsLocation to sqlite stateStore");d=d.changeStateStore(state_store_options_1.StateStoreOptions.fromJS({type:"sqlite",connection:_.getUri().replace(/\.(?:yaml|json)$/,"")+".sqlite"}))}return[3,16];case 13:C=new mysql_state_store_1.MysqlStateStore(nike_hercules_1.LOGGER,_);return[4,C.readState()];case 14:q=j.sent();O=null;try{O=JSON.parse(q)}catch(e){O={};nike_hercules_1.LOGGER.log("Could not parse existing state object, starting from scratch")}p=fromJSSettings(O);if(!d.stateStore){nike_hercules_1.LOGGER.log("Rewriting mysql settingsLocation to mysql stateStore");d=d.changeStateStore(state_store_options_1.StateStoreOptions.fromJS({type:"mysql",connection:_.getUri()}))}return[3,16];case 15:return[2,{exitCode:1,message:"unknown location '"+_.location+"'"}];case 16:return[3,18];case 17:if(hasOwnProp(f,"settings")||hasOwnProp(f,"dataCubes")||hasOwnProp(f,"dataSources")||hasOwnProp(f,"clusters")){try{p=fromJSSettings(f.settings||f)}catch(e){throw new Error("Could not read setting from config file: "+e.message)}}else{k=r["file"];if(k){w=path.basename(k,path.extname(k));if(!p.dataCubes)p.dataCubes=[];p.dataCubes.push(models_3.DataCube.fromJS({name:w,title:w,clusterName:"native",source:k}))}for(A=0,J=h;A<J.length;A++){x=J[A];L=r[x];if(L){if(!p.clusters)p.clusters=[];p.clusters.push(models_3.Cluster.fromJS({name:x,type:x,host:L,user:r["user"],password:r["password"],database:r["database"],socksHost:r["socks-host"],socksUsername:r["socks-username"],socksPassword:r["socks-password"]}))}}}j.label=18;case 18:return[2,{version:a,serverConfig:d,initialSettings:p}]}})})}exports.getConfig=getConfig;