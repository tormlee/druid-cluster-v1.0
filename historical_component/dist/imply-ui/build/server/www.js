"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("es6-shim/es6-shim");var es7Shim=require("es7-shim");es7Shim.shim();var hasOwnProp=require("has-own-prop");var fs=require("fs-extra");var path=require("path");var debugModule=require("debug");var http=require("http");var Knex=require("knex");var nike_hercules_1=require("@implydata/nike-hercules");var immutable_store_1=require("@implydata/immutable-store");var config_1=require("./config");var app_1=require("./app");process.on("uncaughtException",function(e){console.error("!!! There was an unhandled exception: !!!");console.error(e);console.error("!!! !!! !!! !!! !!! !!! !!! !!! !!!")});var debug=debugModule("imply-ui:www");nike_hercules_1.LOGGER.init();function ensureWritableDir(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,t,i,n;return tslib_1.__generator(this,function(s){switch(s.label){case 0:r=String(Math.random()).substring(2);s.label=1;case 1:s.trys.push([1,5,,6]);t=path.join(e,".pivot-test-file-"+r);return[4,fs.writeFile(t,r,{encoding:"utf-8"})];case 2:s.sent();return[4,fs.readFile(t,{encoding:"utf-8"})];case 3:i=s.sent();if(i!==r){console.log("wow",i,r);return[2,false]}return[4,fs.unlink(t)];case 4:s.sent();return[3,6];case 5:n=s.sent();console.log("e",n);return[2,false];case 6:return[2,true]}})})}function exitWithErrorCode(e,r){if(e===0){console.log(r)}else{console.error(r)}process.exit(e)}config_1.getConfig(process.argv).then(function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,t,i,n,s,o,a,u,l,c,g;return tslib_1.__generator(this,function(h){switch(h.label){case 0:if(hasOwnProp(e,"exitCode")){exitWithErrorCode(e.exitCode,e.message);return[2]}r=e,t=r.version,i=r.serverConfig,n=r.initialSettings;nike_hercules_1.LOGGER.log("Starting Imply UI v"+t+" [node "+process.version+"]");s=i.getResolvedVarDir();h.label=1;case 1:h.trys.push([1,3,,4]);return[4,fs.mkdir(s)];case 2:h.sent();return[3,4];case 3:o=h.sent();if(o.code!=="EEXIST"){exitWithErrorCode(1,"Could not find varDir "+s);return[2]}return[3,4];case 4:return[4,ensureWritableDir(s)];case 5:a=h.sent();if(!a){exitWithErrorCode(1,"Could not write to varDir "+s);return[2]}u=null;l=i.getStateStore();if(!l){exitWithErrorCode(1,"You must provide a state store in the config")}try{nike_hercules_1.LOGGER.log("Initializing state store...");u=Knex(l.toKnexOptions())}catch(e){exitWithErrorCode(1,"Could not init the state store: "+e.message)}h.label=6;case 6:h.trys.push([6,8,,9]);nike_hercules_1.LOGGER.log("Verifying state store connectivity...");return[4,immutable_store_1.KnexStore.verifyConnectivity(u)];case 7:h.sent();nike_hercules_1.LOGGER.log("State store connected");return[3,9];case 8:c=h.sent();exitWithErrorCode(1,"Could not connect to the state store: "+c.message);return[3,9];case 9:if(i.hasTracking()){nike_hercules_1.LOGGER.log("Stetting up tracking to "+i.getTrackingUrl());nike_hercules_1.TRACKER.init({version:t,url:i.getTrackingUrl(),context:i.getTrackingContext()})}nike_hercules_1.TRACKER.track({type:"imply-ui_init",metric:"init",value:1});nike_hercules_1.LOGGER.log("Creating HTTP server");g=http.createServer(app_1.wrapperAppFactory({version:t,logger:nike_hercules_1.LOGGER,tracker:nike_hercules_1.TRACKER,serverConfig:i,knex:u,initialSettings:l.getInitialSettings()||n}));if(typeof i.keepAliveTimeout==="number"){g.keepAliveTimeout=i.keepAliveTimeout}g.on("error",function(e){if(e.syscall!=="listen"){throw e}switch(e.code){case"EACCES":console.error("Port "+i.getPort()+" requires elevated privileges");process.exit(1);break;case"EADDRINUSE":console.error("Port "+i.getPort()+" is already in use");process.exit(1);break;default:throw e}});g.on("listening",function(){var e=g.address();nike_hercules_1.LOGGER.log("Imply UI is listening on address "+e.address+" port "+e.port);debug("Imply UI is listening on address "+e.address+" port "+e.port)});g.listen(i.getPort(),i.getServerHost());return[2]}})})}).catch(function(e){exitWithErrorCode(1,e.message)});