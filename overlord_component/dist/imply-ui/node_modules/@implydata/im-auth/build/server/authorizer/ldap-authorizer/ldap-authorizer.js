"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var LdapAuth=require("ldapauth-fork");var models_1=require("../../../common/models");var authorizer_1=require("../authorizer/authorizer");var LDAPAuthorizer=function(_super){tslib_1.__extends(LDAPAuthorizer,_super);function LDAPAuthorizer(options){var _this=_super.call(this)||this;_this.rejects=[];_this.userStore=options.userStore;_this.ldapOptions=options.ldapOptions;if(options.defaultRole){_this.defaultRole=options.defaultRole;if(typeof _this.defaultRole!=="string")throw new Error("defaultRole must be a string")}else{_this.defaultRole="super-admin"}_this.logger=options.logger;return _this}LDAPAuthorizer.prototype.bindLdapIfNeeded=function(){var _this=this;if(this.ldapAuth)return;this.ldapAuth=new LdapAuth(this.ldapOptions);this.ldapAuth.on("error",function(e){_this.handleError(e)})};LDAPAuthorizer.prototype.handleError=function(e){if(!this.ldapAuth)return;if(e&&this.logger)this.logger.error("LDAP Error: "+e.message+" ");this.ldapAuth.close();this.ldapAuth=null;this.rejects.forEach(function(reject){return reject(new Error("LDAP error"))});this.rejects=[]};LDAPAuthorizer.prototype.checkUser=function(userName,password){return tslib_1.__awaiter(this,void 0,void 0,function(){var _this=this;var _a,userStore,defaultRole,ldapUserPromise,ldapUser;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,userStore=_a.userStore,defaultRole=_a.defaultRole;this.bindLdapIfNeeded();ldapUserPromise=new Promise(function(resolve,reject){_this.rejects.push(reject);var timeout=setTimeout(function(){_this.handleError(new Error("op timeout"))},3e3);_this.ldapAuth.authenticate(userName,password,function(err,matched){clearTimeout(timeout);_this.rejects=_this.rejects.filter(function(r){return r!==reject});if(err){if([48,49,50,66].includes(err.code)){resolve(null)}else{reject(err)}return}resolve(new models_1.User({name:userName,firstName:matched["cn"]||null,lastName:matched["sn"]||null,status:"ok",roles:[defaultRole]}))})});return[4,ldapUserPromise];case 1:ldapUser=_b.sent();if(!ldapUser)return[2,null];return[2,authorizer_1.Authorizer.updateUserStoreFromSourceOfTruth(userStore,ldapUser)]}})})};LDAPAuthorizer.prototype.getUser=function(name){return this.userStore.get(name)};LDAPAuthorizer.prototype.getAllUsers=function(){return this.userStore.getAll()};LDAPAuthorizer.prototype.addOrUpdateUser=function(user){return tslib_1.__awaiter(this,void 0,void 0,function(){var currentUser,newUser;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.userStore.get(user.name)];case 1:currentUser=_a.sent();if(!currentUser)throw new Error("Unknown user");newUser=currentUser.changeFavorites(user.favorites);return[2,this.userStore.addOrUpdate(newUser)]}})})};LDAPAuthorizer.prototype.userSize=function(){return this.userStore.size()};return LDAPAuthorizer}(authorizer_1.Authorizer);exports.LDAPAuthorizer=LDAPAuthorizer;