"use strict";var _this=this;var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var NodeCache=require("node-cache");var httpProxy=require("http-proxy");var cluster_host_info_1=require("../../../common/models/cluster-host-info/cluster-host-info");var CACHE_LIFE=3e3;var cache=new NodeCache({stdTTL:CACHE_LIFE});var proxy=httpProxy.createProxyServer();proxy.on("error",function(e){nike_hercules_1.LOGGER.log("Proxy error: "+e.message)});proxy.on("proxyReq",function(e,r,t,s){var o=r.user;var i=r.originalUrl.match(/\/(pivot\/[^/]+)/);if(i){e.setHeader("x-mount-point",i[1])}e.setHeader("x-im-user",new Buffer(JSON.stringify(o),"utf-8").toString("base64"));if(r.method==="POST"&&r.body){var n=JSON.stringify(r.body);e.setHeader("Content-Type","application/json");e.setHeader("Content-Length",String(Buffer.byteLength(n)));e.write(n)}});var router=nike_hercules_1.HerculesServer.makeRouter();router.use("/default",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,o,i,n,u;return tslib_1.__generator(this,function(a){switch(a.label){case 0:t=e.requestId,s=e.user,o=e.clusterActions;a.label=1;case 1:a.trys.push([1,3,,4]);return[4,o.getAllClusters()];case 2:i=a.sent();return[3,4];case 3:n=a.sent();r.status(500).json({error:"Error getting clusters: "+n.message});return[3,4];case 4:u=i.find(function(e){return cluster_host_info_1.ClusterHostInfo.wrappedFromClusterWithInfo(e).hasPivots()});if(!u){r.status(500).json({error:"No available pivot"});return[2]}nike_hercules_1.LOGGER.log("Directing to pivot for "+u.clusterId);r.redirect("/pivot/"+u.clusterId+"/");return[2]}})})});router.use("/:clusterId",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,o,i,n,u,a,c,l,h,_,d,v,f,g;return tslib_1.__generator(this,function(p){switch(p.label){case 0:t=e.serverConfig,s=e.requestId,o=e.clusterActions;delete e.headers["host"];i=e.user;n=e.params.clusterId;u=Date.now();c=cache.get(n+i.accountId);l={type:"pivot",metric:"get-host/time",value:Date.now()-u,user:i,attr:{requestId:s}};if(!t.overridePivotProxyTarget)return[3,1];a=t.overridePivotProxyTarget;return[3,7];case 1:if(!c)return[3,2];a=c;return[3,7];case 2:h=void 0;p.label=3;case 3:p.trys.push([3,5,,6]);return[4,o.getCluster(n)];case 4:h=p.sent();return[3,6];case 5:_=p.sent();nike_hercules_1.LOGGER.error("Error describing cluster "+n+": "+_.message);l.value=Date.now()-u;l.attr["success"]="false";nike_hercules_1.TRACKER.track(l);r.redirect("/");return[2];case 6:try{d=cluster_host_info_1.ClusterHostInfo.wrappedFromClusterWithInfo(h).getPivotHosts()[0];cache.set(n,d);a=d}catch(e){nike_hercules_1.LOGGER.error("Error constructing cluster with info "+n+": "+e.message);l.value=Date.now()-u;l.attr["success"]="false";nike_hercules_1.TRACKER.track(l);r.redirect("/");return[2]}p.label=7;case 7:l.attr["success"]="true";l.value=Date.now()-u;nike_hercules_1.TRACKER.track(l);a=a.match(/^https?\:\/\//i)?a:"http://"+a;v=e.path==="/";f=v?a:a+e.path;g={target:f,autoRewrite:true};if(v){g.ignorePath=true}nike_hercules_1.LOGGER.log("Proxying to "+g.target);proxy.web(e,r,g);return[2]}})})});module.exports=router;