"use strict";Object.defineProperty(exports,"__esModule",{value:true});var os=require("os");var request=require("request");var logger_1=require("./logger");function makePostFlush(url,timeout){if(timeout===void 0){timeout=3e4}if(!url)throw new Error("tracker url is expected");return function(events){return new Promise(function(resolve,reject){request({method:"POST",url:url,json:events,timeout:timeout},function(err,response,body){if(err){reject(err);return}var statusCode=response.statusCode;if(statusCode<200||statusCode>=300){reject(new Error("Bad status code ("+statusCode+")"));return}resolve(null)})})}}function flattenUser(user){if(!user)return null;return{user_id:user.name,user_email:user.email}}function trackerFactory(trackerFactoryOptions){var bufferSize=trackerFactoryOptions.bufferSize||1024;var flushInterval=trackerFactoryOptions.flushInterval||1e4;var timestamp=trackerFactoryOptions.timestamp||function(){return new Date};var context=trackerFactoryOptions.context;var version=trackerFactoryOptions.version;var debug=trackerFactoryOptions.debug;var flush=trackerFactoryOptions.flush;if(!flush){flush=makePostFlush(trackerFactoryOptions.url)}var host=os.hostname();var buffer=[];var flushing=false;function doFlush(){if(flushing||buffer.length===0)return;flushing=true;var eventsToFlush=buffer.slice();flush(eventsToFlush).then(function(){logger_1.LOGGER.log("Posted "+eventsToFlush.length+" tracking events");buffer=buffer.slice(eventsToFlush.length);flushing=false},function(e){logger_1.LOGGER.error("Failed to post "+eventsToFlush.length+" tracking events: "+e.message);flushing=false})}setInterval(doFlush,flushInterval).unref();var track=function(options){if(buffer.length>bufferSize)return;var event=Object.assign({},context,options.attr,flattenUser(options.user),{timestamp:timestamp(),version:version,host:host,type:options.type||"?",metric:options.metric||"?",value:options.value||0});if(debug){logger_1.LOGGER.log("Tracking event: "+JSON.stringify(event))}buffer.push(event)};var addRequestId=function(requestId){return{track:function(options){if(!options.attr)options.attr={};options.attr.request_id=requestId;track(options)},addRequestId:addRequestId}};return{track:track,addRequestId:addRequestId}}exports.TRACKER={track:function(){return null},init:function(opt){var tempTracker=trackerFactory(opt);exports.TRACKER.track=tempTracker.track;exports.TRACKER.addRequestId=tempTracker.addRequestId},addRequestId:function(){return exports.TRACKER}};