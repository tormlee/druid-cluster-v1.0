"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var little_pictures_1=require("@implydata/little-pictures");var classNames=require("classnames");var im_pigeon_maps_1=require("im-pigeon-maps");var React=require("react");var button_1=require("../button/button");var global_event_listener_1=require("../global-event-listener/global-event-listener");var _marker_map_circle_1=require("./_marker-map-circle");var START_POSITION=[19.642587534,20.7421875];var START_ZOOM=3;var MarkerMap=function(t){tslib_1.__extends(e,t);function e(){var e=t.call(this)||this;e.state={visibleMarkers:[],zoom:START_ZOOM,position:START_POSITION,containerHeight:0,containerWidth:0};return e}e.geoMidPoint=function(t){var e=t.length;var r=0;var n=0;var i=0;t.forEach(function(t){var e=t.lat,a=t.lng;e=e*Math.PI/180;a=a*Math.PI/180;r+=Math.cos(e)*Math.cos(a);n+=Math.cos(e)*Math.sin(a);i+=Math.sin(e)});var a=r/e;var o=n/e;var s=i/e;return{lat:Math.atan2(s,Math.sqrt(a*a+o*o))*180/Math.PI,lng:Math.atan2(o,a)*180/Math.PI}};e.prototype.getScaleFromMarkers=function(t){var e=Number.POSITIVE_INFINITY;var r=Number.NEGATIVE_INFINITY;t.forEach(function(t){if(t.value>r)r=t.value;if(t.value<e)e=t.value});if(e===r)return function(t){return 5};var n=3;var i=21;return function(t){return n+(t-e)*(i-n)/(r-e)}};e.prototype.componentWillReceiveProps=function(t){if(t.markers)this.preProcessMarkers(t.markers)};e.prototype.isWithinBounds=function(t,e){var r=t.sw,n=t.ne;var i=e.latLng,a=i.lat,o=i.lng;var s=(n[0]-r[0])/5;var l=(n[1]-r[1])/5;var c=r[0]-s<a&&a<n[0]+s;var p=r[1]-l<o&&o<n[1]+l;return p&&c};e.prototype.preProcessMarkers=function(t){if(!this._map)return;this.setState({visibleMarkers:t.filter(this.isWithinBounds.bind(this,this._map.getBounds()))})};e.prototype.renderMarkers=function(){var t=this;if(!this._map)return[];var e=this.props.markers;var r=this.state.visibleMarkers;var n=this.getScaleFromMarkers(e);return r.map(function(e,r){return React.createElement(_marker_map_circle_1.MarkerMapCircle,{key:e.latLng.lat+"-"+e.latLng.lng+"-"+r,anchor:[e.latLng.lat,e.latLng.lng],onClick:t.onMarkerClick.bind(t,e),onMouseEnter:t.onMarkerOver.bind(t,e),onMouseLeave:t.onMarkerOut.bind(t,e),radius:n(e.value),focused:e.outerCircle,color:"hsla(201, 81%, 49%, 1.00)",fillOpacity:e.additionalOptions?e.additionalOptions.fillOpacity:1})})};e.prototype.componentDidMount=function(){this.onResize()};e.prototype.onMapClick=function(t){var e=this.props.onMapClick;if(this._hoveredMarker)return;if(e)e()};e.prototype.onBoundsChanged=function(t){var e=t.center,r=t.zoom,n=t.bounds,i=t.initial;var a=this.props,o=a.onAppear,s=a.markers;this.preProcessMarkers(s);if(i&&o)o()};e.prototype.onMarkerOver=function(t,e){var r=this.props.onMarkerOver;this._hoveredMarker=t;if(r)r(t,e.nativeEvent)};e.prototype.onMarkerClick=function(t,e){var r=this.props.onMarkerClick;if(r)r(t,e.nativeEvent)};e.prototype.onMarkerOut=function(t,e){var r=this.props.onMarkerOut;this._hoveredMarker=undefined;if(r)r(t,e.nativeEvent)};e.prototype.onResize=function(){var t=this._container.getBoundingClientRect();var e=this.state,r=e.containerWidth,n=e.containerHeight;if(t.width!==r||t.height!==n){this.setState({containerHeight:t.height,containerWidth:t.width})}};e.prototype.zoom=function(t){this.setState({zoom:this._map._lastZoom+t,position:this._map._lastCenter})};e.prototype.resetZoom=function(){this._map.setCenterZoomTarget(START_POSITION,START_ZOOM)};e.prototype.render=function(){var t=this;var e=this.props,r=e.disableZoomButtons,n=e.disablePan,i=e.disableMouseWheel;var a=this.state,o=a.zoom,s=a.position,l=a.containerHeight,c=a.containerWidth;var p=function(t,e,r){return"http://c.tile.osm.org/"+r+"/"+t+"/"+e+".png"};return React.createElement("div",{className:classNames("marker-map",{"pigeon-drag-block":n}),ref:function(e){return t._container=e}},React.createElement(global_event_listener_1.GlobalEventListener,{resize:this.onResize.bind(this)}),React.createElement(im_pigeon_maps_1.default,{ref:function(e){return t._map=e},center:s,zoom:o,width:c,height:l,onClick:this.onMapClick.bind(this),attribution:false,provider:p,onBoundsChanged:this.onBoundsChanged.bind(this),zoomOnMouseWheel:!i},this.renderMarkers(),this.props.children||[]),React.createElement("div",{className:"buttons"},!r?React.createElement("div",{className:"zoom-cont"},React.createElement(button_1.Button,{className:"icon-only",type:"primary",title:"+",onClick:this.zoom.bind(this,1)}),React.createElement(button_1.Button,{className:"icon-only",type:"primary",title:"-",onClick:this.zoom.bind(this,-1)})):null,React.createElement(button_1.Button,{type:"primary",svg:little_pictures_1.RESET,onClick:this.resetZoom.bind(this)})))};return e}(React.Component);exports.MarkerMap=MarkerMap;