"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var base_store_1=require("./base-store");var NULL_LOGGER={log:function(line){return null},warn:function(line){return null},error:function(line){return null}};var KnexStore=function(_super){tslib_1.__extends(KnexStore,_super);function KnexStore(options){var _this=_super.call(this,options)||this;_this.immutableClass=options.immutableClass;_this.knex=options.knex;_this.table=options.table;_this.initArray=options.initArray||[];_this.logger=options.logger||NULL_LOGGER;return _this}KnexStore.verifyConnectivity=function(knex){return knex.schema.hasTable("store-test").then(function(){return null})};KnexStore.isFriendlyError=function(knex,e){var client=knex.client.config.client;if(client==="mysql"&&e.code==="ER_TABLE_EXISTS_ERROR")return true;if(client==="pg"&&e.code==="42P07")return true;if(client==="sqlite3"&&e.message.includes(" already exists"))return true;return false};KnexStore.prototype.initIfNeeded=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _this=this;var _a,keyFn,knex,table,initArray,logger;return tslib_1.__generator(this,function(_b){_a=this,keyFn=_a.keyFn,knex=_a.knex,table=_a.table,initArray=_a.initArray,logger=_a.logger;if(this._initializedPromise)return[2,this._initializedPromise];this._initializedPromise=knex.schema.createTable(this.table,function(table){if(knex.client.config.client==="mysql"){table.charset("utf8mb4");table.collate("utf8mb4_bin")}table.string("key",120).primary();table.bigInteger("created_at");table.bigInteger("updated_at");table.text("payload","longtext")}).then(function(){if(!initArray.length)return null;var initRows=initArray.map(function(thing){var now=Date.now();return{key:keyFn(thing),created_at:now,updated_at:now,payload:JSON.stringify(thing)}});logger.log("Inserting initial "+initArray.length+" row(s) into table "+table);return knex.batchInsert(table,initRows,500).then(function(){logger.log("Initial insert into "+table+" successful");return null},function(e){logger.error("Initial insert failed: "+e.message);throw e})},function(e){var friendlyError=KnexStore.isFriendlyError(knex,e);if(friendlyError)return null;logger.error("Table creation failed: "+e.message);_this._initializedPromise=null});return[2,this._initializedPromise]})})};KnexStore.prototype.trimOldestToMaxEntries=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,table,maxEntries,currentSize,trimBefore;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,knex=_a.knex,table=_a.table,maxEntries=_a.maxEntries;if(!maxEntries)throw new Error("no max entries");return[4,this.size()];case 1:currentSize=_b.sent();if(currentSize<=maxEntries)return[2];return[4,knex.select("updated_at").from(table).orderBy("updated_at","desc").offset(maxEntries-1).limit(1).then(function(rows){if(rows.length!==1)throw new Error("unexpected results");return rows[0]["updated_at"]})];case 2:trimBefore=_b.sent();return[2,knex(table).whereRaw("updated_at < ?",[trimBefore]).del().then(function(n){return n})]}})})};KnexStore.prototype.size=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,table;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,knex=_a.knex,table=_a.table;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex(table).count("* as cnt").then(function(rows){if(rows.length!==1)throw new Error("unexpected results");return Number(rows[0].cnt)})]}})})};KnexStore.prototype.get=function(key){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,immutableClass,knex,table;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,immutableClass=_a.immutableClass,knex=_a.knex,table=_a.table;if(typeof key!=="string")throw new TypeError("key must be a string");return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex.select("payload").from(table).where({key:key}).then(function(rows){if(!rows.length)return null;return immutableClass.fromJS(JSON.parse(rows[0].payload))})]}})})};KnexStore.prototype.getAll=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,immutableClass,knex,table;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this,immutableClass=_a.immutableClass,knex=_a.knex,table=_a.table;return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex.select("payload").from(table).orderBy("created_at","asc").then(function(rows){return rows.map(function(row){return immutableClass.fromJS(JSON.parse(row.payload))})})]}})})};KnexStore.prototype.deleteByKey=function(key){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,table;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:this.ensureWritable();_a=this,knex=_a.knex,table=_a.table;if(typeof key!=="string")throw new TypeError("key must be a string");return[4,this.initIfNeeded()];case 1:_b.sent();return[2,knex(table).where({key:key}).del().then(function(){return null})]}})})};KnexStore.prototype.addOrUpdate=function(thing){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,knex,keyFn,table,key,payload,inserted;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:this.ensureWritable();_a=this,knex=_a.knex,keyFn=_a.keyFn,table=_a.table;return[4,this.initIfNeeded()];case 1:_b.sent();key=keyFn(thing);payload=JSON.stringify(thing);inserted=false;return[4,knex.transaction(function(trx){return trx.select("key").from(table).where({key:key}).then(function(rows){var now=Date.now();if(rows.length){return trx(table).where({key:key}).update({updated_at:now,payload:payload})}else{inserted=true;return trx(table).insert({key:key,created_at:now,updated_at:now,payload:payload})}})})];case 2:_b.sent();if(!(inserted&&this.maxEntries))return[3,4];return[4,this.trimOldestToMaxEntries()];case 3:_b.sent();_b.label=4;case 4:return[2]}})})};return KnexStore}(base_store_1.ImmutableStore);exports.KnexStore=KnexStore;