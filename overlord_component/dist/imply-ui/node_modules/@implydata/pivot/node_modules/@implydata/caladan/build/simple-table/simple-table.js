"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var little_pictures_1=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var scroller_1=require("../scroller/scroller");var svg_icon_1=require("../svg-icon/svg-icon");var ACTIONS_PADDING={left:14,right:24};var ROW_HEIGHT=42;var HEADER_HEIGHT=30;var ACTION_WIDTH=30;var SimpleTable=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.state={scrollLeft:0,scrollTop:0};return t}t.prototype.componentWillReceiveProps=function(e){this.computeColumnsPositions(e.columns)};t.prototype.componentDidMount=function(){this.computeColumnsPositions(this.props.columns);this.calculateSize()};t.prototype.componentDidUpdate=function(){var e=this.state,t=e.actionMenuTarget,r=e.activeActionIndices;if(!r)return;var n=this.getActionTarget(r);if(n&&n!==t)this.setState({actionMenuTarget:n})};t.prototype.computeColumnsPositions=function(e){if(e){var t=[];var r=0;e.forEach(function(e,n){t[n]=r;r+=e.width});this.setState({columnsPosition:t})}};t.prototype.onScroll=function(e,t){if(this.state.scrollLeft!==t||this.state.scrollTop!==e){this.setState({scrollLeft:t,scrollTop:e})}};t.prototype.calculateSize=function(){var e=this.state,t=e.viewportWidth,r=e.viewportHeight;var n=ReactDOM.findDOMNode(this._scroller);if(!n)return;var i=n.getBoundingClientRect();if(r!==i.height||t!==i.width){this.setState({viewportHeight:i.height,viewportWidth:i.width})}};t.prototype.renderHeaders=function(){var e=this.props,t=e.columns,r=e.rows,n=e.actions;var i=this.state,o=i.hoveredRowIndex,s=i.hoveredColumnIndex,a=i.sortAscending,l=i.sortColumn;var c=[];for(var d=0;d<t.length;d++){var h=t[d];var u=o===-1&&d===s;if(h.renderHeader){c.push(h.renderHeader(h,u));continue}var v=null;if(l&&l===h){v=React.createElement(svg_icon_1.SvgIcon,{svg:little_pictures_1.SORT_ARROW,className:"sort-arrow "+(a?"ascending":"descending")})}c.push(React.createElement("div",{className:classNames("header",{hover:u}),style:{width:h.width},key:"column-"+d},h.label,v))}return React.createElement("div",{className:"column-headers",style:{minWidth:this.getHeaderWidth(t)}},c)};t.prototype.getIcons=function(e,t){if(!t||!t.length)return null;var r=[];for(var n=0;n<t.length;n++){var i=t[n];r.push(React.createElement("div",{className:"cell action",key:"action-"+n,onClick:i.callback.bind(this,e)},React.createElement(svg_icon_1.SvgIcon,{svg:i.icon})))}return r};t.prototype.labelizer=function(e){var t=e.field,r=e.cellRenderer;if(r){return function(e){return r(e)}}if(typeof t==="string"){return function(e){return e.get?e.get(t):""+e[t]}}return t};t.prototype.sortRows=function(e,t,r){if(!t)return e;var n=this.labelizer(t);var i=function(t){return e.indexOf(t)};e=e.concat();if(r){return e.sort(function(e,t){if(n(e)<n(t)){return-1}else if(n(e)>n(t)){return 1}else{return i(t)-i(e)}})}return e.sort(function(e,t){if(n(e)<n(t)){return 1}else if(n(e)>n(t)){return-1}else{return i(e)-i(t)}})};t.prototype.renderRow=function(e,t,r,n,i){var o=this.props.rowHeight;var s=this.state,a=s.hoveredRowIndex,l=s.hoveredColumnIndex,c=s.columnsPosition;var d=[];var h=this.getHeaderWidth(t);var u=function(n){var i=t[n];var o=i.cellIcon;var s=function(e){return typeof o==="function"?o(e):o};var h=o?React.createElement(svg_icon_1.SvgIcon,{svg:s(e),className:"prefix-icon"}):null;d.push(React.createElement("div",{className:classNames("cell",{"has-icon":!!i.cellIcon},i.cellClassName?i.cellClassName(e):"",{hover:l===n&&a===r}),style:{width:i.width,left:c[n]},key:"cell-"+n},h,v.labelizer(i)(e)))};var v=this;for(var p=n;p<i;p++){u(p)}return React.createElement("div",{className:classNames("row",{hover:a===r}),key:"row-"+r,style:{height:o,top:r*o,minWidth:h}},d)};t.prototype.renderEmptyRow=function(e,t,r,n){var i=this.props.rowHeight;var o=this.state.columnsPosition;var s=[];var a=this.getHeaderWidth(e);for(var l=r;l<n;l++){var c=e[l];s.push(React.createElement("div",{className:"cell",style:{width:c.width,left:o[l]},key:"cell-"+l}))}return React.createElement("div",{className:"row",key:"row-"+t,style:{height:i,top:t*i,minWidth:a}},s)};t.prototype.renderEmptyRows=function(e){var t=this.getXBoundaries(e);var r={start:0,end:this.getVisibleRowsCount()};var n=[];for(var i=r.start;i<r.end;i++){n.push(this.renderEmptyRow(e,i,t.start,t.end))}return n};t.prototype.renderAfterLastRow=function(e,t,r){var n=this.props,i=n.rowHeight,o=n.renderAfterLastRow;var s=this.state.hoveredRowIndex;var a=this.getHeaderWidth(t);return React.createElement("div",{className:classNames("after-last-row",{hover:s===e.length}),style:{height:i,top:r*i,minWidth:a},key:"after-last-row"},o())};t.prototype.renderRows=function(){var e=this.props,t=e.columns,r=e.rows,n=e.renderAfterLastRow;var i=this.state,o=i.sortColumn,s=i.sortAscending;if(!t||!t.length)return null;if(!r||!r.length){return this.renderEmptyRows(t)}var a=this.getYBoundaries(r);var l=this.getXBoundaries(t);var c=this.sortRows(r,o,s);var d=[];for(var h=a.start;h<a.end;h++){d.push(this.renderRow(c[h],t,h,l.start,l.end))}if(a.end===c.length&&typeof n==="function"){d.push(this.renderAfterLastRow(c,t,a.end))}return d};t.prototype.getXBoundaries=function(e){var t=this.state,r=t.viewportWidth,n=t.scrollLeft;var i=0;var o=-1;var s=-1;var a=e.length;for(var l=0;l<a;l++){var c=e[l];if(o===-1&&i+c.width>n){o=l}if(s===-1&&i>n+r){s=l}if(s===-1&&l===a-1){s=a}if(o!==-1&&s!==-1)break;i+=c.width}return{start:o,end:s}};t.prototype.getYBoundaries=function(e){var t=this.props.rowHeight;var r=this.state,n=r.viewportHeight,i=r.scrollTop;var o=Math.floor(i/t);return{start:o,end:Math.min(o+Math.ceil(n/t),e.length)}};t.prototype.getVisibleRowsCount=function(){var e=this.props.rowHeight;var t=this.state.viewportHeight;return Math.ceil(t/e)};t.prototype.getLayout=function(){var e=this.props,t=e.columns,r=e.rows,n=e.rowHeight,i=e.paddingLeft,o=e.paddingRight,s=e.paddingBottom,a=e.actions,l=e.renderAfterLastRow;var c=this.getHeaderWidth(t);var d=r.length*n;if(typeof l==="function")d+=n;return{bodyWidth:c,bodyHeight:d,top:this.props.headerHeight,right:a.length*30+(a.length>0?ACTIONS_PADDING.left+ACTIONS_PADDING.right:0),bottom:0,left:0,bodyPadding:{left:i||10,right:o||10,bottom:s||50}}};t.prototype.renderActions=function(){var e=this.props,t=e.rowHeight,r=e.renderAfterLastRow,n=e.rows,i=e.actions;var o=this.state,s=o.hoveredRowIndex,a=o.hoveredActionIndex,l=o.activeActionIndices;var c=this.getYBoundaries(n);var d=[];var h=function(e){var r=e===s;var o=n[e];var c=i.map(function(t,n){var i={hover:r&&(l?n===l.actionIndex:n===a),disabled:typeof t.disabled==="function"?t.disabled(o):!!t.disabled};return React.createElement("div",{className:classNames("icon action-"+e+"-"+n,i),key:"icon-"+n,style:{width:ACTION_WIDTH}},React.createElement(svg_icon_1.SvgIcon,{svg:t.icon}))});d.push(React.createElement("div",{className:classNames("row action",{hover:r}),key:"action-"+e,style:{height:t,top:e*t}},c))};for(var u=c.start;u<c.end;u++){h(u)}if(c.end===n.length&&typeof r==="function"){var v=n.length===s;d.push(React.createElement("div",{className:classNames("after-last-row-action",{hover:v}),key:"after-last-action",style:{height:t,top:n.length*t,width:ACTION_WIDTH*i.length}}))}return d};t.prototype.getRowIndex=function(e){var t=this.props.rowHeight;var r=-1;if(e>this.props.headerHeight){r=Math.floor((e-this.props.headerHeight)/t)}return r};t.prototype.getActionIndex=function(e,t){var r=this.props.actions;var n=Math.floor((e-t-ACTIONS_PADDING.left)/ACTION_WIDTH);if(n>r.length-1)return-1;return n};t.prototype.getColumnIndex=function(e,t){var r=this.props,n=r.columns,i=r.paddingLeft;if(e>=t+i)return-1;if(e<i)return-1;e-=i;var o=0;while((e-=n[o].width)>0)o++;return o};t.prototype.getHeaderWidth=function(e){var t=this.state.columnsPosition;if(!t)return 0;var r=e.length;if(r===0)return 0;return t[r-1]+e[r-1].width};t.prototype.onClick=function(e,t,r,n){var i=this.props,o=i.columns,s=i.rows,a=i.actions,l=i.onAfterLastRowClick;var c=this.state.actionMenuTarget;if(c){this.closeActionMenu();return}if(r===scroller_1.Scroller.TOP_RIGHT_CORNER)return;var d=this.getHeaderWidth(o);var h=this.getColumnIndex(e,d);var u=this.getRowIndex(t);if(r===scroller_1.Scroller.RIGHT_GUTTER){var v=this.getActionIndex(e,d);if(v>-1){this.onActionClick(u,v,n);return}}if(r===scroller_1.Scroller.TOP_GUTTER){this.onHeaderClick(o[h]);return}if(u===s.length&&typeof l==="function"){l()}this.onCellClick(s[u],o[h])};t.prototype.onCellClick=function(e,t){if(t&&t.onClick){var r=t.onClick(e);if(r===false)return}if(this.props.onRowClick&&e){this.props.onRowClick(e)}};t.prototype.onHeaderClick=function(e){if(this.props.onHeaderClick){var t=this.props.onHeaderClick(e);if(!t)return}this.setState({sortColumn:e,sortAscending:this.state.sortColumn===e?!this.state.sortAscending:true})};t.prototype.onActionClick=function(e,t,r){var n=this.props,i=n.rows,o=n.actions;var s=this.state.activeActionIndices;if(s&&e===s.rowIndex&&t===s.actionIndex){this.closeActionMenu();return}var a=o[t];var l=i[e];if(a.disabled===true||typeof a.disabled==="function"&&a.disabled(l))return;if(typeof a.callback==="function")a.callback(l,r);if(typeof a.renderMenu==="function"){this.setState({activeActionIndices:{rowIndex:e,actionIndex:t},actionMenuTarget:this.getActionTarget({rowIndex:e,actionIndex:t})})}};t.prototype.renderActionMenu=function(e,t){var r=this.state,n=r.activeActionIndices,i=r.actionMenuTarget;if(!n)return null;var o=this.getYBoundaries(e),s=o.start,a=o.end;var l=n.rowIndex,c=n.actionIndex;if(l>=a||l<s)return null;var d=t[c];if(!d||!d.renderMenu)return null;return d.renderMenu(e[l],i,this.closeActionMenu.bind(this))};t.prototype.getActionTarget=function(e){var t=ReactDOM.findDOMNode(this._scroller);return t.getElementsByClassName("action-"+e.rowIndex+"-"+e.actionIndex)[0]};t.prototype.onGlobalClick=function(e){if(!beltful_1.DOMUtils.isInside(e.target,ReactDOM.findDOMNode(this._scroller))){this.closeActionMenu()}};t.prototype.closeActionMenu=function(){this.setState({activeActionIndices:undefined,actionMenuTarget:undefined,hoveredRowIndex:undefined,hoveredColumnIndex:undefined,hoveredActionIndex:undefined})};t.prototype.onMouseMove=function(e,t,r){var n=this.props,i=n.rows,o=n.columns;var s=this.state.activeActionIndices;var a=this.getHeaderWidth(o);var l=s?s.rowIndex:this.getRowIndex(t);var c=s?-1:this.getColumnIndex(e,a);this.setState({hoveredColumnIndex:c,hoveredRowIndex:l>i.length?undefined:l,hoveredActionIndex:r===scroller_1.Scroller.RIGHT_GUTTER?this.getActionIndex(e,a):undefined})};t.prototype.isClickable=function(e,t,r){var n=this.props,i=n.onRowClick,o=n.columns;if(e===-1)return true;var s=o[t];if(e>-1)return!!i||r>-1||t>-1&&!!o[t].onClick;return false};t.prototype.getCurrentTitle=function(){var e=this.state.hoveredActionIndex;var t=this.props.actions;if(e>-1){return t[e].title||""}return null};t.prototype.onMouseLeave=function(){var e=this.state.activeActionIndices;if(e)return;this.setState({hoveredRowIndex:undefined,hoveredColumnIndex:undefined,hoveredActionIndex:undefined})};t.prototype.render=function(){var e=this;var t=this.props,r=t.columns,n=t.rows,i=t.actions;var o=this.state,s=o.hoveredRowIndex,a=o.hoveredColumnIndex,l=o.hoveredActionIndex;if(!r)return null;var c=this.isClickable(s,a,l);return React.createElement("div",{className:classNames("simple-table",{clickable:c}),title:this.getCurrentTitle()},React.createElement(global_event_listener_1.GlobalEventListener,{resize:this.calculateSize.bind(this),click:this.onGlobalClick.bind(this),escape:this.closeActionMenu.bind(this)}),React.createElement(scroller_1.Scroller,{ref:function(t){return e._scroller=t},layout:this.getLayout(),topRightCorner:React.createElement("div",null),topGutter:this.renderHeaders(),rightGutter:this.renderActions(),body:this.renderRows(),onClick:this.onClick.bind(this),onMouseMove:this.onMouseMove.bind(this),onMouseLeave:this.onMouseLeave.bind(this),onScroll:this.onScroll.bind(this)}),this.renderActionMenu(n,i))};t.defaultProps={actions:[],headerHeight:HEADER_HEIGHT,rowHeight:ROW_HEIGHT,paddingLeft:0,paddingRight:0};return t}(React.Component);exports.SimpleTable=SimpleTable;