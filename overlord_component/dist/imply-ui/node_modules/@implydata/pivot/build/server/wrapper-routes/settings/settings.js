"use strict";var _this=this;var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var bodyParser=require("body-parser");var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var models_1=require("../../../common/models");var views_1=require("../../views");var customization_1=require("../../../common/models/customization/customization");var router=nike_hercules_1.HerculesServer.makeRouter();router.use(bodyParser.json({limit:"1mb"}));router.post("/load",function(e,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r,a,n,u,o,i;return tslib_1.__generator(this,function(c){switch(c.label){case 0:c.trys.push([0,8,,9]);return[4,e.customizationStore.get("x")];case 1:s=c.sent()||customization_1.Customization.BLANK;if(!(e.authorizer&&e.authorizer.isManagingUsers()))return[3,3];return[4,e.authorizer.getAllUsers()];case 2:o=c.sent();return[3,4];case 3:o=[];c.label=4;case 4:r=o;return[4,e.clusterStore.getAll()];case 5:a=c.sent();return[4,e.dataCubeStore.getAll()];case 6:n=c.sent();return[4,e.collectionStore.getAll()];case 7:u=c.sent();return[3,9];case 8:i=c.sent();t.sendError({status:500,error:"could not get settings",e:i});return[2];case 9:t.send({customization:s,users:r,clusters:a,dataCubes:n,collections:u});return[2]}})})});router.post("/set-customization",function(e,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r,a,n,u;return tslib_1.__generator(this,function(o){switch(o.label){case 0:s=e.body.customization;try{r=customization_1.Customization.fromJS(s)}catch(e){t.status(400).send({error:"bad customization",message:e.message});return[2]}o.label=1;case 1:o.trys.push([1,3,,4]);return[4,e.customizationStore.addOrUpdate(r)];case 2:o.sent();return[3,4];case 3:a=o.sent();t.status(501).send({error:"could not update",message:a.message});return[2];case 4:o.trys.push([4,6,,7]);return[4,e.customizationStore.get("x")];case 5:n=o.sent();return[3,7];case 6:u=o.sent();t.status(501).send({error:"could not get new version",message:u.message});return[2];case 7:t.send({customization:n});return[2]}})})});router.post("/set-users",function(e,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r,a,n,u,o,i,c;return tslib_1.__generator(this,function(l){switch(l.label){case 0:s=e.body.userDiffs;if(!e.authorizer&&!e.authorizer.isManagingUsers()){t.status(403).send({error:"should not be here"});return[2]}try{r=immutable_class_1.Diff.inflateFromJSs(im_auth_1.User,s)}catch(e){t.status(400).send({error:"bad userDiffs",message:e.message});return[2]}l.label=1;case 1:l.trys.push([1,6,,7]);a=0,n=r;l.label=2;case 2:if(!(a<n.length))return[3,5];u=n[a];return[4,e.authorizer.applyUserDiff(u)];case 3:l.sent();l.label=4;case 4:a++;return[3,2];case 5:return[3,7];case 6:o=l.sent();t.status(501).send({error:"could not update",message:o.message});return[2];case 7:l.trys.push([7,9,,10]);return[4,e.authorizer.getAllUsers()];case 8:i=l.sent();return[3,10];case 9:c=l.sent();t.status(501).send({error:"could get new version",message:c.message});return[2];case 10:t.send({users:i});return[2]}})})});router.post("/set-clusters",function(e,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r,a,n,u,o,i,c;return tslib_1.__generator(this,function(l){switch(l.label){case 0:s=e.body.clusterDiffs;try{r=immutable_class_1.Diff.inflateFromJSs(models_1.Cluster,s)}catch(e){t.status(400).send({error:"bad clusterDiffs",message:e.message});return[2]}l.label=1;case 1:l.trys.push([1,6,,7]);a=0,n=r;l.label=2;case 2:if(!(a<n.length))return[3,5];u=n[a];return[4,e.clusterStore.applyDiff(u)];case 3:l.sent();l.label=4;case 4:a++;return[3,2];case 5:return[3,7];case 6:o=l.sent();t.status(501).send({error:"could not update",message:o.message});return[2];case 7:l.trys.push([7,9,,10]);return[4,e.clusterStore.getAll()];case 8:i=l.sent();return[3,10];case 9:c=l.sent();t.status(501).send({error:"could get new version",message:c.message});return[2];case 10:t.send({clusters:i});return[2]}})})});router.post("/set-datacubes",function(e,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r,a,n,u,o,i,c;return tslib_1.__generator(this,function(l){switch(l.label){case 0:s=e.body.dataCubeDiffs;try{r=immutable_class_1.Diff.inflateFromJSs(models_1.DataCube,s)}catch(e){t.status(400).send({error:"bad dataCubeDiffs",message:e.message});return[2]}l.label=1;case 1:l.trys.push([1,6,,7]);a=0,n=r;l.label=2;case 2:if(!(a<n.length))return[3,5];u=n[a];return[4,e.dataCubeStore.applyDiff(u)];case 3:l.sent();l.label=4;case 4:a++;return[3,2];case 5:return[3,7];case 6:o=l.sent();t.status(501).send({error:"could not update",message:o.message});return[2];case 7:l.trys.push([7,9,,10]);return[4,e.dataCubeStore.getAll()];case 8:i=l.sent();return[3,10];case 9:c=l.sent();t.status(501).send({error:"could get new version",message:c.message});return[2];case 10:t.send({dataCubes:i});return[2]}})})});router.post("/cluster-connection",function(e,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r,a,n;return tslib_1.__generator(this,function(u){switch(u.label){case 0:s=e.body.cluster;if(typeof s==="undefined"){t.status(400).send({error:"must have a cluster"});return[2]}try{r=models_1.Cluster.fromJS(s)}catch(e){t.status(400).send({error:"invalid cluster",message:e.message});return[2]}u.label=1;case 1:u.trys.push([1,3,,4]);return[4,e.clusterActions.getSources(r,e.dbAuthToken)];case 2:a=u.sent();return[3,4];case 3:n=u.sent();t.sendError({status:500,error:"could not get cluster",e:n});return[3,4];case 4:t.send({cluster:r,sources:a});return[2]}})})});router.get("/?*",function(e,t,s){return tslib_1.__awaiter(_this,void 0,void 0,function(){var s,r;return tslib_1.__generator(this,function(a){switch(a.label){case 0:a.trys.push([0,2,,3]);return[4,e.customizationStore.get("x")];case 1:s=a.sent()||customization_1.Customization.BLANK;return[3,3];case 2:r=a.sent();t.sendError({status:500,error:"could not get customization",e:r});return[2];case 3:t.send(views_1.settingsLayout({version:e.version,mountPoint:e.mountPoint,title:s.getTitleWithVersion(e.version),user:e.user,customization:s,stateful:e.stateful,showUserTab:Boolean(e.authorizer&&e.authorizer.isManagingUsers()),logoutHref:e.logoutHref}));return[2]}})})});module.exports=router;