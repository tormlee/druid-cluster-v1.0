"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var models_1=require("@implydata/im-auth/build/server/models");var authorizer_1=require("@implydata/im-auth/build/server/authorizer");var utils_1=require("@implydata/im-auth/build/server/utils");var authApp=require("@implydata/im-auth/build/server/app");var path=require("path");var innerApp=require("./inner-app");var settingsRoutes=require("./wrapper-routes/settings/settings");var immutable_store_1=require("@implydata/immutable-store");var utils_2=require("./utils");var models_2=require("../common/models");function makeGuardForSettings(){return function(e,r,t){var s=e.user;if(!(s instanceof im_auth_1.User)){r.status(403).send({error:"no user"});return}if(!s.canAccessSettings()){r.status(403).send({error:"no settings access"});return}t()}}function wrapperAppFactory(e){var r=this;var t=e.version,s=e.logger,a=e.tracker,i=e.serverConfig,o=e.knex,n=e.initialSettings,l=n===void 0?{}:n;var u=new nike_hercules_1.HerculesServer({serverRoot:i.getServerRoot()});u.getApp().set("port",i.getPort());if(i.getTrustProxy()==="always"){u.getApp().set("trust proxy",1)}function m(e,r){var t=makeGuardForSettings();u.getApp().use(e,t,r);u.getApp().use(i.getServerRoot()+e,t,r)}u.addCompress();u.getApp().use(nike_hercules_1.logAndTrack({morganFormat:i.getRequestLogFormat()}));u.decorateReqRes();if(i.getStrictTransportSecurity()==="always"){u.addHsts()}u.addStaticRoutes([path.join(__dirname,"../../assets")]);u.addHealth();u.addClientError();var p=i.getUserMode();var c=i.isStateful();var d=i.getResolvedVarDir();var g=new utils_1.LicenseManager({appName:"Pivot",logger:s,varDir:d,licenseFile:i.getResolvedLicenseFile()});var _=i.getStateStore().getTablePrefix();var v;if(p==="native-users"||p==="ldap-authentication"||p==="header-user"){var h=null;if(o){h=new immutable_store_1.KnexStore({immutableClass:im_auth_1.User,readOnly:!c,knex:o,table:_+"users",initArray:l.users,logger:s})}else{h=new immutable_store_1.FileStore({immutableClass:im_auth_1.User,readOnly:!c,filepath:path.resolve(d,"users.json"),initArray:l.users})}if(p==="native-users"){var f=void 0;if(o){f=new immutable_store_1.KnexStore({immutableClass:models_1.UserAuth,readOnly:!c,knex:o,table:_+"user-auths",initArray:l.userAuths,logger:s})}else{f=new immutable_store_1.FileStore({immutableClass:models_1.UserAuth,readOnly:!c,filepath:path.resolve(d,"user-auths.json"),initArray:l.userAuths})}v=new authorizer_1.StoreAuthorizer({userStore:h,authStore:f})}else if(p==="ldap-authentication"){var b=i.getLdapOptions();v=new authorizer_1.LDAPAuthorizer({userStore:h,ldapOptions:b,defaultRole:b.defaultRole,logger:s})}else if(p==="header-user"){v=new authorizer_1.StoreAuthorizer({userStore:h})}else{throw new Error("should never get here")}}var y;if(o){y=new immutable_store_1.KnexStore({immutableClass:models_1.InviteToken,readOnly:!c,knex:o,table:_+"invite-tokens",logger:s})}else{y=new immutable_store_1.FileStore({immutableClass:models_1.InviteToken,readOnly:!c,filepath:path.resolve(d,"inviteTokens.json")})}var A;if(o){A=new immutable_store_1.KnexStore({immutableClass:models_2.SettingsVersion,readOnly:!c,knex:o,keyFn:function(){return"x"},table:_+"settings-versions",logger:s})}else{A=new immutable_store_1.FileStore({immutableClass:models_2.Customization,readOnly:!c,keyFn:function(){return"x"},filepath:path.resolve(d,"settingsVersions.json")})}var S;if(o){S=new immutable_store_1.KnexStore({immutableClass:models_2.Customization,readOnly:!c,knex:o,keyFn:function(){return"x"},table:_+"customizations",initArray:l.customization?[l.customization]:[],logger:s})}else{S=new immutable_store_1.FileStore({immutableClass:models_2.Customization,readOnly:!c,keyFn:function(){return"x"},filepath:path.resolve(d,"customizations.json"),initArray:l.customization?[l.customization]:[]})}var w;if(o){w=new immutable_store_1.KnexStore({immutableClass:models_2.Cluster,readOnly:!c,knex:o,table:_+"clusters",initArray:l.clusters,logger:s})}else{w=new immutable_store_1.FileStore({immutableClass:models_2.Cluster,readOnly:!c,filepath:path.resolve(d,"clusters.json"),initArray:l.clusters})}var C;if(o){C=new immutable_store_1.KnexStore({immutableClass:models_2.DataCube,readOnly:!c,knex:o,table:_+"data-cubes",initArray:l.dataCubes,logger:s})}else{C=new immutable_store_1.FileStore({immutableClass:models_2.DataCube,readOnly:!c,filepath:path.resolve(d,"data-cubes.json"),initArray:l.dataCubes})}var k;if(o){k=new immutable_store_1.KnexStore({immutableClass:models_2.Collection,readOnly:!c,knex:o,table:_+"collections",initArray:l.collections,logger:s})}else{k=new immutable_store_1.FileStore({immutableClass:models_2.Collection,readOnly:!c,filepath:path.resolve(d,"collections.json"),initArray:l.collections})}var x;if(o){x=new immutable_store_1.KnexStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},knex:o,table:_+"urls",logger:s,maxEntries:i.getMaxUrlEntries()})}else{x=new immutable_store_1.FileStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},filepath:path.resolve(d,"urls.json"),maxEntries:i.getMaxUrlEntries()})}var F=new utils_2.Decorators({logger:s,decorators:i.getResolvedDecorators()});var O=new utils_2.ClusterActions({verbose:i.verbose,logger:s,decorators:F});u.getApp().use(function(e,r,s){e.user=null;e.version=t;e.stateful=c;e.pathResolver=function(e){return i.resolvePath(e)};e.authorizer=v;e.inviteTokenStore=y;s()});if(i.needsLogin()){u.addRoutes("/",authApp.makeAuthApp({version:t,title:"Login to "+i.getAppName(),appName:i.getAppName(),showTerms:false,userNameLabel:i.getUserNameLabel(),sessionStore:i.getSessionStore(),authorizer:v}))}else if(p==="all-admin"){u.getApp().use(function(e,r,t){e.user=im_auth_1.User.DEFAULT_ADMIN;t()})}else if(p==="all-users"){u.getApp().use(function(e,r,t){e.user=im_auth_1.User.fromJS({name:"user",email:"user@user.com",firstName:"Default",lastName:"User",status:"ok"});t()})}else if(p==="header-user"){u.getApp().use(function(e,t,s){return tslib_1.__awaiter(r,void 0,void 0,function(){var r,a,i,o,n;return tslib_1.__generator(this,function(l){switch(l.label){case 0:r=e.header("x-im-user");try{i=JSON.parse(new Buffer(r,"base64").toString("utf-8"));a=im_auth_1.User.fromJS(i)}catch(e){t.status(403).send({error:"bad user"});return[2]}l.label=1;case 1:l.trys.push([1,3,,4]);return[4,v.updateWithTrustedUser(a)];case 2:o=l.sent();return[3,4];case 3:n=l.sent();t.status(500).send({error:"simple auth fail"});return[2];case 4:e.user=o;s();return[2]}})})})}else{throw new Error("unexpected userMode "+p)}var z=i.getQueryCache();var R;switch(z.type){case"none":R=null;break;case"local":R=new utils_2.LocalQueryCache({config:z,logger:s});break;case"memcached":R=new utils_2.MemcachedQueryCache({config:z,logger:s});break;default:throw new Error("unknown query cache type: '"+z.type+"'")}var q=p==="header-user";var U=i.getServerRoot();var E=i.needsLogin()?"/logout":null;var L=c?"settings":null;u.getApp().use(function(e,r,t){e.mountPoint=(q?e.header("x-mount-point"):null)||U;e.logoutHref=E;e.licenseManager=g;e.settingsVersionStore=A;e.customizationStore=S;e.clusterStore=w;e.dataCubeStore=C;e.collectionStore=k;e.queryCache=R;e.clusterActions=O;e.urlStore=x;e.launcherHref=null;e.settingsHref=L;t()});if(i.getIframe()==="deny"){u.getApp().use(function(e,r,t){r.setHeader("X-Frame-Options","DENY");r.setHeader("Content-Security-Policy","frame-ancestors 'none'");t()})}if(c){m("/settings",settingsRoutes)}u.addRoutes("/",innerApp.getApp());u.getApp().use(function(e,r,t){if(e.path!=="/"){r.redirect("/")}else{t()}});if(u.getApp().get("env")==="development"){u.getApp().use(function(e,r,s,a){r.logger.error("Server Error: "+e.message);r.logger.error(e.stack);s.status(e.status||500);s.send({version:t,error:e.message,err:e})})}u.getApp().use(function(e,r,s,a){r.logger.error("Server Error: "+e.message);r.logger.error(e.stack);s.status(e.status||500);s.send({version:t,error:e.message})});return u.getApp()}exports.wrapperAppFactory=wrapperAppFactory;