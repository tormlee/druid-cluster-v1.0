"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var NodeCache=require("node-cache");var beltful_1=require("@implydata/beltful");var plywood_1=require("plywood");var file_manager_1=require("../file-manager/file-manager");var VERSION_CACHE_LIFE=3600;var DATASET_CACHE_LIFE=2*3600;var versionCache=new NodeCache({stdTTL:VERSION_CACHE_LIFE});var datasetCache=new NodeCache({stdTTL:DATASET_CACHE_LIFE});function getClusterVersion(e,t){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,a,s;return tslib_1.__generator(this,function(n){switch(n.label){case 0:r=versionCache.get(e.name);if(r)return[2,r];a=plywood_1.External.getConstructorFor(e.type);if(!a)throw new Error("unknown external");return[4,a.getVersion(t)];case 1:s=n.sent();versionCache.set(e.name,s);return[2,s]}})})}var DataCubeActions=function(){function e(){}e.prototype.executorFactory=function(e){if(e.dataCube.clusterName==="native"){return this.fileExecutorFactory(e)}else{return this.clusterExecutorFactory(e)}};e.prototype.clusterExecutorFactory=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,r,a,s,n,o,i,u;return tslib_1.__generator(this,function(c){switch(c.label){case 0:t=e.clusterActions,r=e.dataCube,a=e.instance,s=e.cluster,n=e.authToken;return[4,t.makeRequester(s,n)];case 1:o=c.sent();if(!!s.version)return[3,3];return[4,getClusterVersion(s,o)];case 2:i=c.sent();s=s.changeVersion(i);c.label=3;case 3:u=r.toExternal(s,a,o);if(u.needsIntrospect())throw new Error("must be introspected at this point, something went very wrong");return[2,plywood_1.basicExecutorFactory({datasets:{main:u}})]}})})};e.prototype.fileExecutorFactory=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,r,a,s,n,o;return tslib_1.__generator(this,function(i){switch(i.label){case 0:t=e.logger,r=e.dataCube,a=e.pathResolver;s=beltful_1.StringUtils.objectHash({source:r.source,subset:r.subsetExpression});n=datasetCache.get(s);if(!!n)return[3,2];o=new file_manager_1.FileManager({logger:t,verbose:false,pathResolver:a,uri:r.source,subsetExpression:r.subsetExpression});return[4,o.loadDataset()];case 1:n=i.sent();datasetCache.set(s,n);i.label=2;case 2:return[2,plywood_1.basicExecutorFactory({datasets:{main:n}})]}})})};return e}();exports.DataCubeActions=DataCubeActions;