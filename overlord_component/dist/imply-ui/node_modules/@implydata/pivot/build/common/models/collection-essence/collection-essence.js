"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var lz_string_1=require("lz-string");var beltful_1=require("@implydata/beltful");var filter_1=require("../filter/filter");var highlight_1=require("../highlight/highlight");var essence_1=require("../essence/essence");var splits_1=require("../splits/splits");var check;var CollectionEssence=function(){function t(t){var e=t.actualCollection,i=t.commonDataCube,n=t.collection,l=t.instance,o=t.timezone,r=t.filter,a=t.highlight,h=t.highlightOwner;this.actualCollection=e;this.commonDataCube=i;if(i){r=i.addMandatoryFiltersIfNeeded(r)}this.collection=n;this.instance=l;this.timezone=o;this.filter=r;this.highlight=a;this.highlightOwner=h}t.isCollectionEssence=function(e){return e instanceof t};t.fromFullHash=function(e,i){if(i===void 0){i={}}var n=i.actualCollection,l=i.collections;try{var o=JSON.parse(lz_string_1.decompressFromBase64(beltful_1.StringUtils.untidyB64(e)));var r={};if(!n&&l){var a=immutable_class_1.NamedArray.findByName(l,o.collection);if(!a)return null;r.actualCollection=a}return t.fromJS(o,r)}catch(t){return null}};t.fromCollection=function(e){var i=e.getCommonDataCube();return new t({actualCollection:e,commonDataCube:i,collection:e.name,instance:i?i.getDefaultInstance():null,timezone:i?i.getDefaultTimezone():chronoshift_1.Timezone.UTC,filter:i?i.getDefaultFilter():filter_1.Filter.EMPTY,highlight:null,highlightOwner:null})};t.fromJS=function(e,i){if(i===void 0){i={}}var n=i.collections,l=i.actualCollection;var o=e.collection;var r=e.timezone?chronoshift_1.Timezone.fromJS(e.timezone):null;var a=e.filter?filter_1.Filter.fromJS(e.filter):filter_1.Filter.EMPTY;var h=e.highlight?highlight_1.Highlight.fromJS(e.highlight):null;var s=e.highlightOwner;if(!l&&n){l=immutable_class_1.NamedArray.findByName(n,e.collection)}var c=null;if(l){if(o!==l.name)throw new Error("data cube '"+o+"' and actual data cube name "+l.name);c=l.getCommonDataCube();if(c){a=a.constrainToDimensions(c.dimensions);if(h){h=h.constrainToDimensions(c.dimensions)}}}else{if(!e.collection)throw new Error("must have collection or actual collection")}return new t({actualCollection:l,commonDataCube:c,collection:o,instance:e.instance,timezone:r,filter:a,highlight:h,highlightOwner:s})};t.prototype.valueOf=function(){return{actualCollection:this.actualCollection,commonDataCube:this.commonDataCube,collection:this.collection,instance:this.instance,timezone:this.timezone,filter:this.filter,highlight:this.highlight,highlightOwner:this.highlightOwner}};t.prototype.toJS=function(){var t={collection:this.collection,timezone:this.timezone.toJS(),filter:this.filter.toJS()};if(this.instance)t.instance=this.instance;if(this.highlight){t.highlight=this.highlight.toJS();t.highlightOwner=this.highlightOwner}return t};t.prototype.toJSON=function(){return this.toJS()};t.prototype.toString=function(){return"[CollectionEssence]"};t.prototype.equals=function(e){return t.isCollectionEssence(e)&&this.collection===e.collection&&this.instance===e.instance&&this.timezone.equals(e.timezone)&&this.filter.equals(e.filter)&&immutable_class_1.immutableEqual(this.highlight,e.highlight)&&this.highlightOwner===e.highlightOwner};t.prototype.getEssence=function(t){var e=this,i=e.commonDataCube,n=e.instance,l=e.timezone,o=e.filter,r=e.highlight;if(!i)return null;return new essence_1.Essence({actualDataCube:i,visualizations:t,defaultMeasureModes:{},dataCube:i.name,instance:n,visualization:null,timezone:l,filter:o,splits:splits_1.Splits.EMPTY,singleMeasure:i.getDefaultSortMeasure(),selectedMeasures:i.getDefaultSelectedMeasures(),pinnedDimensions:[],colors:null,pinnedSort:null,highlight:r})};t.prototype.getHash=function(){return beltful_1.StringUtils.objectHashHex18(this.toJS())};t.prototype.toFullHash=function(){return beltful_1.StringUtils.tidyB64(lz_string_1.compressToBase64(JSON.stringify(this)))};t.prototype.ensureActualCollection=function(){var t=this.actualCollection;if(!t)throw new Error("must have actual collection");return t};t.prototype.changeInstance=function(e){var i=this.valueOf();i.instance=e;return new t(i)};t.prototype.changeFilter=function(e,i){if(i===void 0){i=false}var n=this.valueOf();n.filter=e;if(i){n.highlight=null}return new t(n)};t.prototype.addToFilter=function(t,e){if(e===void 0){e=false}return this.changeFilter(this.filter.applyDelta(t),e)};t.prototype.changeTimezone=function(e){var i=this.timezone;if(i===e)return this;var n=this.valueOf();n.timezone=e;return new t(n)};t.prototype.acceptHighlight=function(){var t=this.highlight;if(!t)return this;return this.addToFilter(t.delta,true)};t.prototype.changeHighlightFor=function(e,i){var n=this,l=n.highlight,o=n.highlightOwner;var r;if(l&&o!==e){r=this.addToFilter(l.delta).valueOf()}else{r=this.valueOf()}r.highlight=i;r.highlightOwner=e;return new t(r)};t.prototype.dropHighlight=function(){var e=this.valueOf();e.highlight=null;return new t(e)};t.prototype.canInvertHighlight=function(){var t=this.highlight;if(!t)return false;if(immutable_class_1.NamedArray.findByName(this.commonDataCube.dimensions,t.delta.clauses[0].dimension).isContinuous())return false;return true};t.prototype.invertHighlight=function(){var t=this,e=t.highlight,i=t.highlightOwner;return this.changeHighlightFor(i,e.invert())};t.prototype.getTileEssence=function(t){if(!t.isVisualization()||!t.getDataCube())return null;var e=this,i=e.filter,n=e.highlight,l=e.highlightOwner,o=e.instance,r=e.timezone;var a=t.essence.addToFilter(i).changeHighlight(n);if(n&&l!==t.name){a=a.acceptHighlight()}if(o){a=a.changeInstance(o)}if(r){a=a.changeTimezone(r)}return a};t.prototype.hasSpecialTimeDimension=function(){var t=this.ensureActualCollection();return t.tiles.some(function(t){var e=t.getDataCube();return Boolean(e&&e.getSpecialTimeDimensionObject())})};t.prototype.updatedText=function(t){var e=this.ensureActualCollection();var i=e.tiles;for(var n=0,l=i;n<l.length;n++){var o=l[n];var r=o.getDataCube();if(!r||!r.getSpecialTimeDimensionObject())continue;return r.updatedText(t,this.timezone||chronoshift_1.Timezone.UTC)}return null};return t}();exports.CollectionEssence=CollectionEssence;check=CollectionEssence;