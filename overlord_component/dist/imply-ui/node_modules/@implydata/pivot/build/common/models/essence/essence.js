"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var lz_string_1=require("lz-string");var beltful_1=require("@implydata/beltful");var plywood_1=require("plywood");var colors_1=require("../colors/colors");var dimension_1=require("../dimension/dimension");var filter_clause_1=require("../filter-clause/filter-clause");var filter_1=require("../filter/filter");var highlight_1=require("../highlight/highlight");var splits_1=require("../splits/splits");var general_1=require("../../utils/general/general");function addToSetInOrder(e,t,i){return e.filter(function(e){return t.includes(e)||e===i})}var VisStrategy;(function(e){e[e["FairGame"]=0]="FairGame";e[e["UnfairGame"]=1]="UnfairGame";e[e["KeepAlways"]=2]="KeepAlways"})(VisStrategy=exports.VisStrategy||(exports.VisStrategy={}));var TO_MEASURE_MODE={false:"single",true:"multi",single:"single",multi:"multi"};function evaluationLog(e){}var check;var Essence=function(){function e(t){var i=t.actualDataCube,n=t.visualizations,s=t.defaultMeasureModes,r=t.dataCube,a=t.instance,u=t.visualization,o=t.timezone,l=t.filter,h=t.splits,f=t.measureMode,c=t.singleMeasure,p=t.selectedMeasures,g=t.pinnedDimensions,m=t.colors,d=t.pinnedSort,v=t.highlight;o=o||chronoshift_1.Timezone.UTC;if(i){l=i.addMandatoryFiltersIfNeeded(l);if(v){v=v.constrainToDimensions(i.dimensions)}}this.actualDataCube=i;this.visualizations=n;this.defaultMeasureModes=s||e.DEFAULT_DEFAULT_MEASURE_MODE;this.dataCube=r;this.instance=a;this.visualization=u;this.timezone=o;this.filter=l;this.splits=h;this.measureMode=f;this.singleMeasure=c;this.selectedMeasures=p;this.pinnedDimensions=g;this.colors=m;this.pinnedSort=d;this.highlight=v}e.isEssence=function(t){return t instanceof e};e.getBestVisualization=function(e,t,i,n,s,r,a){var u=a?a.name:null;var o=i.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(t,e.dimension)});var l=e.filter(function(e){return e.canHandleSplitDimensions(t,o,n,s).proceedWithDimensions()});evaluationLog("Start evaluation");return l.map(function(e){var n=e.getEffectiveSplits(i,t,s);var a=e.getSuitability(t,n,r,e.name===u);evaluationLog("> "+e.name+": "+a.score);return{suitability:a,visualization:e}}).sort(function(e,t){return t.suitability.score-e.suitability.score})[0]};e.fromFullHash=function(t,i){try{var n=JSON.parse(lz_string_1.decompressFromBase64(beltful_1.StringUtils.untidyB64(t)));if(!i.actualDataCube&&i.dataCubes){var s=immutable_class_1.NamedArray.findByName(i.dataCubes,n.dataCube);if(!s)return null;i.actualDataCube=s}return e.fromJS(n,i)}catch(e){return null}};e.fromLegacyHash=function(t){if(t[0]==="#")t=t.substr(1);var i=t.split("/");if(i.length<4)return null;var n=i.shift();var s=i.shift();if(i.shift()!=="2")return null;var r=null;try{r=JSON.parse("["+lz_string_1.decompressFromBase64(i.join("/"))+"]")}catch(e){return null}var a=r.length;if(!(8<=a&&a<=11))return null;var u;try{u=e.fromJS({dataCube:n,visualization:s,timezone:r[0],filter:r[1],splits:r[2],measureMode:r[3],singleMeasure:r[4],selectedMeasures:r[5],pinnedDimensions:r[6],pinnedSort:r[7],colors:r[8]||null,highlight:r[9]||null})}catch(e){return null}return u};e.fromDataCube=function(t,i){return new e({actualDataCube:t,visualizations:i.visualizations,defaultMeasureModes:i.defaultMeasureModes,dataCube:t.name,instance:t.getDefaultInstance(),visualization:null,timezone:t.getDefaultTimezone(),filter:t.getDefaultFilter(),splits:t.getDefaultSplits(),singleMeasure:t.getDefaultSortMeasure(),selectedMeasures:t.getDefaultSelectedMeasures(),pinnedDimensions:t.getDefaultPinnedDimensions(),colors:null,pinnedSort:t.getDefaultSortMeasure(),highlight:null})};e.fromJS=function(t,i){if(i===void 0){i={}}var n=i.dataCubes,s=i.actualDataCube,r=i.visualizations,a=i.defaultMeasureModes;var u=t.dataCube;var o=t.timezone?chronoshift_1.Timezone.fromJS(t.timezone):null;var l=t.filter?filter_1.Filter.fromJS(t.filter):filter_1.Filter.EMPTY;var h=t.splits?splits_1.Splits.fromJS(t.splits):splits_1.Splits.EMPTY;var f=TO_MEASURE_MODE[t.measureMode||t.multiMeasureMode];var c=t.singleMeasure;var p=t.selectedMeasures||[];var g=t.pinnedDimensions||[];var m=t.colors?colors_1.Colors.fromJS(t.colors):null;var d=t.pinnedSort;var v=t.highlight?highlight_1.Highlight.fromJS(t.highlight):null;if(!s&&n){s=immutable_class_1.NamedArray.findByName(n,u)}if(s){if(u){if(u!==s.name)throw new Error("data cube '"+u+"' and actual data cube name "+s.name)}else{u=s.name}}else{if(!t.dataCube)throw new Error("must have data cube or actual data cube")}return new e({actualDataCube:s,visualizations:r,defaultMeasureModes:a,dataCube:u,instance:t.instance,visualization:t.visualization,timezone:o,filter:l,splits:h,measureMode:f,singleMeasure:c,selectedMeasures:p,pinnedDimensions:g,colors:m,pinnedSort:d,highlight:v})};e.prototype.valueOf=function(){return{actualDataCube:this.actualDataCube,visualizations:this.visualizations,defaultMeasureModes:this.defaultMeasureModes,dataCube:this.dataCube,instance:this.instance,visualization:this.visualization,timezone:this.timezone,filter:this.filter,splits:this.splits,measureMode:this.measureMode,singleMeasure:this.singleMeasure,selectedMeasures:this.selectedMeasures,pinnedDimensions:this.pinnedDimensions,colors:this.colors,pinnedSort:this.pinnedSort,highlight:this.highlight}};e.prototype.toJS=function(){var e={dataCube:this.dataCube,timezone:this.timezone.toJS(),filter:this.filter.toJS(),splits:this.splits.toJS(),selectedMeasures:this.selectedMeasures,pinnedDimensions:this.pinnedDimensions};if(this.visualization)e.visualization=this.visualization;if(this.instance)e.instance=this.instance;if(this.singleMeasure)e.singleMeasure=this.singleMeasure;if(this.measureMode)e.measureMode=this.measureMode;if(this.colors)e.colors=this.colors.toJS();if(this.pinnedSort)e.pinnedSort=this.pinnedSort;if(this.highlight)e.highlight=this.highlight.toJS();return e};e.prototype.toJSON=function(){return this.toJS()};e.prototype.toString=function(){return"[Essence]"};e.prototype.equals=function(t){return e.isEssence(t)&&this.dataCube===t.dataCube&&this.instance===t.instance&&this.visualization===t.visualization&&this.timezone.equals(t.timezone)&&this.filter.equals(t.filter)&&this.splits.equals(t.splits)&&this.measureMode===t.measureMode&&this.singleMeasure===t.singleMeasure&&immutable_class_1.generalArraysEqual(this.selectedMeasures,t.selectedMeasures)&&immutable_class_1.generalArraysEqual(this.pinnedDimensions,t.pinnedDimensions)&&immutable_class_1.immutableEqual(this.colors,t.colors)&&this.pinnedSort===t.pinnedSort&&immutable_class_1.immutableEqual(this.highlight,t.highlight)};e.prototype.getHash=function(){return beltful_1.StringUtils.objectHashHex18(this.toJS())};e.prototype.toFullHash=function(){return beltful_1.StringUtils.tidyB64(lz_string_1.compressToBase64(JSON.stringify(this)))};e.prototype.getTitle=function(){var e=this.getDimensions();var t=this.getEffectiveMeasures();var i=this.splits.toArray().map(function(t){return t.getDimension(e).title}).join(", ")||"Total";if(t.length===1){i=i+" by "+t[0].title}return i};e.prototype.ensureActualDataCube=function(){var e=this.actualDataCube;if(!e)throw new Error("must have actual data cube");return e};e.prototype.getDimensions=function(){return this.ensureActualDataCube().dimensions};e.prototype.getDimension=function(e){return dimension_1.Dimension.getDimension(this.getDimensions(),e)};e.prototype.evaluateSelection=function(e,t){var i=this,n=i.timezone,s=i.actualDataCube;if(!s)return null;return filter_clause_1.FilterClause.evaluate(e,t.now(),s.getMaxTime(t),n)};e.prototype.evaluateClause=function(e,t){var i=this,n=i.timezone,s=i.actualDataCube;if(!s)return null;return e.evaluate(t.now(),s.getMaxTime(t),n)};e.prototype.getEffectiveFilter=function(){var e=this.ensureActualDataCube();return this.filter.constrainToDimensions(e.dimensions)};e.prototype.getSplitDimensions=function(){var e=this.ensureActualDataCube();return this.getConstrainedSplits().getSplitDimensions(e.dimensions)};e.prototype.getSpecificFilter=function(e,t){if(t===void 0){t=null}var i=this,n=i.actualDataCube,s=i.timezone;if(!n)return null;var r=this.getEffectiveFilter();if(t)r=r.remove(t.name);return r.getSpecificFilter(e.now(),n.getMaxTime(e),s)};e.prototype.getSpecificFilterWithHighlight=function(e,t){if(t===void 0){t=null}var i=this,n=i.actualDataCube,s=i.highlight,r=i.timezone;if(!n)return null;var a=this.getEffectiveFilter();if(s)a=a.applyDelta(s.delta);if(t)a=a.remove(t.name);return a.getSpecificFilter(e.now(),n.getMaxTime(e),r)};e.prototype.getRealTimeSelection=function(){var e=this.ensureActualDataCube();var t=e.getSpecialTimeDimensionObject();if(!t)return null;return this.filter.getSelection(t.name)};e.prototype.isSpecialTimeDimension=function(e){return this.ensureActualDataCube().isSpecialTimeDimension(e)};e.prototype.getMeasureMode=function(){if(!this.getVisualizationManifest().supportsMultipleMeasureMode)return"single";var e=this.defaultMeasureModes;return this.measureMode||e[this.getVisualizationManifest().name]||"single"};e.prototype.getEffectiveMeasures=function(){var e=this.ensureActualDataCube();var t;if(this.getMeasureMode()==="multi"){t=this.getMeasures()}else{t=[e.getMeasure(this.singleMeasure)||e.getMeasure(e.getDefaultSortMeasure())]}if(e.title.match(/#test$/)){t=t.map(function(e){return e.changeCompanion(JSON.stringify(e.expression.multiply(1.2)))})}else if(e.title.match(/@test$/)){t=t.map(function(e){return e.changeCompanion(JSON.stringify(e.expression.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name==="main"){return plywood_1.$("cmp")}else{return null}})))})}return t};e.prototype.getFirstSelectedMeasure=function(){var e=this.selectedMeasures;return e?e[0]:null};e.prototype.getMeasures=function(){var e=this.ensureActualDataCube();return this.selectedMeasures.map(function(t){return e.getMeasure(t)}).filter(Boolean)};e.prototype.getSortMeasure=function(){var e=this,t=e.actualDataCube,i=e.singleMeasure;if(!t)return null;return(this.getMeasureMode()==="multi"?this.getFirstSelectedMeasure():i)||t.getDefaultSortMeasure()};e.prototype.getEffectiveSelectedMeasure=function(){if(this.getMeasureMode()==="multi"){return this.selectedMeasures}else{var e=this.ensureActualDataCube();return[this.singleMeasure?this.singleMeasure:e.getDefaultSortMeasure()]}};e.prototype.getCountExpression=function(){var e=this.ensureActualDataCube();var t=e.getMeasure("count");return t?t.expression:plywood_1.$("main").count()};e.prototype.differentDataCube=function(e){return this.dataCube!==e.dataCube||this.instance!==e.instance};e.prototype.differentTimezone=function(e){return!this.timezone.equals(e.timezone)};e.prototype.differentTimezoneMatters=function(e){return this.splits.timezoneDependant()&&this.differentTimezone(e)};e.prototype.differentFilter=function(e){return!this.filter.equals(e.filter)};e.prototype.differentSplits=function(e){return!this.splits.equals(e.splits)};e.prototype.differentEffectiveSplits=function(e){return this.differentSplits(e)||this.differentTimezoneMatters(e)};e.prototype.differentColors=function(e){if(Boolean(this.colors)!==Boolean(e.colors))return true;if(!this.colors)return false;return!this.colors.equals(e.colors)};e.prototype.differentSelectedMeasures=function(e){return!immutable_class_1.generalArraysEqual(this.selectedMeasures,e.selectedMeasures)};e.prototype.differentEffectiveMeasures=function(e){return!immutable_class_1.generalArraysEqual(this.getEffectiveSelectedMeasure(),e.getEffectiveSelectedMeasure())};e.prototype.newSelectedMeasures=function(e){return!general_1.isSubset(this.selectedMeasures,e.selectedMeasures)};e.prototype.newEffectiveMeasures=function(e){return!general_1.isSubset(this.getEffectiveSelectedMeasure(),e.getEffectiveSelectedMeasure())};e.prototype.differentPinnedDimensions=function(e){return!immutable_class_1.generalArraysEqual(this.pinnedDimensions,e.pinnedDimensions)};e.prototype.differentPinnedSort=function(e){return this.pinnedSort!==e.pinnedSort};e.prototype.differentHighlight=function(e){if(Boolean(this.highlight)!==Boolean(e.highlight))return true;return Boolean(this.highlight&&!this.highlight.equals(e.highlight))};e.prototype.differentSpecificFilter=function(e,t,i,n){if(n===void 0){n=null}var s=this.getSpecificFilter(t,n);var r=e.getSpecificFilter(i,n);return!s.equals(r)};e.prototype.differentSpecificFilterWithHighlight=function(e,t,i,n){if(n===void 0){n=null}var s=this.getSpecificFilterWithHighlight(t,n);var r=e.getSpecificFilterWithHighlight(i,n);return!s.equals(r)};e.prototype.getHighlightEffectiveMeasure=function(){var e=this.highlight;if(!e)return null;var t=this.getEffectiveMeasures();var i=e.measure;return t.find(function(e){return e.name===i})||t[0]};e.prototype.hasHighlight=function(e){var t=this.getHighlightEffectiveMeasure();return t&&(!e||t.name===e)};e.prototype.getSingleHighlightSet=function(){var e=this.highlight;if(!e)return null;return e.delta.getSingleClauseSet()};e.prototype.getApplyForSort=function(e,t){var i=this.ensureActualDataCube();var n=e.expression.name;var s=i.getMeasure(n);if(!s)return null;return s.toApplyAction(t)};e.prototype.updateDefaultMeasureModes=function(t){var i=this.valueOf();i.defaultMeasureModes=t;return new e(i)};e.prototype.changeInstance=function(t){var i=this.valueOf();i.instance=t;return new e(i)};e.prototype.changeFilter=function(t,i){if(i===void 0){i=false}var n=this.filter;var s=this.valueOf();s.filter=t;if(i){s.highlight=null}return new e(s).updateSplitsAfterFilterChange(n)};e.prototype.addToFilter=function(e,t){if(t===void 0){t=false}return this.changeFilter(this.filter.applyDelta(e),t)};e.prototype.changeTimezone=function(t){var i=this.timezone;if(i===t)return this;var n=this.valueOf();n.timezone=t;return new e(n)};e.prototype.convertToSpecificFilter=function(e){var t=this.timezone;var i=this.actualDataCube;if(!i)throw new Error("must have actualDataCube");var n=this.getEffectiveFilter();if(!n.isDynamic())return this;return this.changeFilter(n.getSpecificFilter(e.now(),i.getMaxTime(e),t))};e.prototype.getVisualizationManifest=function(){var t=this,i=t.visualizations,n=t.visualization;if(!i)throw new Error("must have visualizations");var s=immutable_class_1.NamedArray.findByName(i,n);if(!s){var r=this,a=r.actualDataCube,u=r.singleMeasure;var o=u||a.getDefaultSortMeasure();s=e.getBestVisualization(i,a.dimensions,this.getConstrainedSplits(),this.getEffectiveFilter(),o,this.colors,null).visualization}return s};e.prototype.getVisResolve=function(){var e=this.ensureActualDataCube();var t=this.getVisualizationManifest();var i=this.getSplitDimensions();var n=this.singleMeasure||e.getDefaultSortMeasure();var s=t.canHandleSplitDimensions(e.dimensions,i,this.getEffectiveFilter(),n);if(s.proceedWithDimensions()){var r=this.splits.constrainToDimensions(e.dimensions);var a=t.getEffectiveSplits(r,e.dimensions,n);var u=t.getSuitability(e.dimensions,a,this.colors,true);if(u.cantHandleCombine){s=u.cantHandleCombine}}return s};e.prototype.getEffectiveColors=function(){var e=this,t=e.splits,i=e.colors;var n=this.getVisualizationManifest();if(!n)return i;return n.getEffectiveColors(t,i)};e.prototype.getConstrainedSplits=function(){var e=this.ensureActualDataCube();return this.splits.constrainToDimensions(e.dimensions)};e.prototype.getEffectiveSplits=function(){var e=this.ensureActualDataCube();var t=this.getVisualizationManifest();var i=this.getConstrainedSplits();if(!t)return i;return t.getEffectiveSplits(i,e.dimensions,this.getSortMeasure())};e.prototype.isMandatoryTimeFilter=function(e){return this.ensureActualDataCube().isMandatoryTimeFilter(e)};e.prototype.getSpecialTimeDimension=function(){return this.ensureActualDataCube().getSpecialTimeDimensionObject()};e.prototype.hasSpecialTimeDimension=function(){return Boolean(this.getSpecialTimeDimension())};e.prototype.getSplitForDimension=function(e){return this.splits.findSplitForDimension(e)};e.prototype.getEffectiveSplitForDimension=function(e){return this.getEffectiveSplits().findSplitForDimension(e)};e.prototype.getEffectiveColorSplit=function(){var e=this.getEffectiveColors();if(!e)return null;return this.getEffectiveSplitForDimension(e.dimension)};e.prototype.updateWithNewSplits=function(t,i){var n=this,s=n.visualizations,r=n.filter,a=n.colors;var u=this.getVisualizationManifest();if(!u)return null;var o=this.getDimensions();var l=this.splits;if(this.getVisResolve().rejectedDimensions()){var h=t.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(o,e.dimension)});if(!u.canHandleSplitDimensions(o,h,r,this.getSortMeasure()).rejectedDimensions()){i=VisStrategy.KeepAlways}}if(l.sameOnDimensions(t)){i=VisStrategy.KeepAlways}if(i==null)i=l.getStrategyForSplitChange(t);if(i!==VisStrategy.KeepAlways){var f=e.getBestVisualization(s,o,t,r,this.getSortMeasure(),a,i===VisStrategy.FairGame?null:u);u=f.visualization}var c=this.valueOf();c.splits=t;if(c.visualization!==u.name){c.visualization=u.name;c.measureMode=this.defaultMeasureModes[u.name]||"single"}if(c.highlight){c.filter=c.filter.applyDelta(c.highlight.delta);c.highlight=null}return new e(c)};e.prototype.changeSplit=function(e,t){var i=this.splits;var n=i.splitCombines.find(function(t){return t.dimension===e.dimension});var s=n?i.replace(n,e):i.addSplit(e);return this.updateWithNewSplits(s,t)};e.prototype.initializeAndChangeSplits=function(e,t){var i=e.initializeGivenFilter(this.getEffectiveFilter(),this.getDimensions(),this.getSortMeasure());return this.updateWithNewSplits(i,t)};e.prototype.addSplit=function(e,t){return this.initializeAndChangeSplits(this.getConstrainedSplits().addSplit(e),t)};e.prototype.removeSplit=function(e,t){return this.initializeAndChangeSplits(this.getConstrainedSplits().removeSplit(e))};e.prototype.updateSplitsAfterFilterChange=function(t){var i=this.valueOf();var n=i.splits;var s=n.recalculateBucketsWithFilterChange(t,this.getEffectiveFilter(),this.getDimensions());if(n===s)return this;i.splits=s;return new e(i)};e.prototype.changeColors=function(t){var i=this.valueOf();i.colors=t;return new e(i)};e.prototype.summonVisualization=function(t){if(t.name===this.visualization)return this;var i=this,n=i.splits,s=i.filter,r=i.singleMeasure,a=i.colors;var u=this.getDimensions();var o=t.canHandleSplitDimensions(u,n.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(u,e.dimension)}),s,this.getSortMeasure());var l=this.valueOf();if(o.proceedWithDimensions()){var h=t.summon(u,n,s,r,a);if(h){l.splits=h.splits;l.colors=h.colors}}l.visualization=t.name;l.measureMode=this.defaultMeasureModes[t.name]||"single";return new e(l)};e.prototype.pin=function(t){var i=this.valueOf();i.pinnedDimensions=immutable_class_1.SimpleArray.append(i.pinnedDimensions,t.name);return new e(i)};e.prototype.unpin=function(t){var i=this.valueOf();i.pinnedDimensions=immutable_class_1.SimpleArray.delete(i.pinnedDimensions,t.name);return new e(i)};e.prototype.getPinnedSortMeasure=function(){var e=this.ensureActualDataCube();return e.getMeasure(this.pinnedSort)||e.getMeasure(e.getDefaultSortMeasure())};e.prototype.changePinnedSortMeasure=function(t){var i=this.valueOf();i.pinnedSort=t.name;return new e(i)};e.prototype.switchToMeasure=function(e){var t=this.changeSingleMeasure(e);return t.measureMode?t.toggleMultiMeasureMode():t};e.prototype.toggleMultiMeasureMode=function(){var t=this,i=t.measureMode,n=t.selectedMeasures,s=t.singleMeasure;var r=this.ensureActualDataCube();var a=this.valueOf();a.measureMode=i==="multi"?"single":"multi";if(i==="multi"){if(n.length&&!n.includes(s)){a.singleMeasure=n[0]}}else{a.selectedMeasures=addToSetInOrder(r.getMeasures().map(function(e){return e.name}),a.selectedMeasures,s)}return new e(a)};e.prototype.changeSingleMeasure=function(t){if(t.name===this.singleMeasure)return this;var i=this.valueOf();i.singleMeasure=t.name;i.splits=i.splits.changeSortIfOnMeasure(this.singleMeasure,t.name);i.pinnedSort=t.name;return new e(i)};e.prototype.toggleSelectedMeasure=function(t){var i=this.ensureActualDataCube();var n=this.valueOf();var s=n.selectedMeasures;var r=t.name;if(s.includes(r)){n.selectedMeasures=immutable_class_1.SimpleArray.delete(s,r)}else{n.selectedMeasures=addToSetInOrder(i.getMeasures().map(function(e){return e.name}),s,r)}return new e(n)};e.prototype.toggleEffectiveMeasure=function(e){if(this.getMeasureMode()==="multi"){return this.toggleSelectedMeasure(e)}else{return this.changeSingleMeasure(e)}};e.prototype.acceptHighlight=function(){var e=this.highlight;if(!e)return this;return this.addToFilter(e.delta,true)};e.prototype.changeHighlight=function(t){var i=this.valueOf();i.highlight=t;return new e(i)};e.prototype.dropHighlight=function(){var t=this.valueOf();t.highlight=null;return new e(t)};e.prototype.canInvertHighlight=function(){var e=this.highlight;if(!e)return false;if(this.getDimension(e.delta.clauses[0].dimension).isContinuous())return false;return true};e.prototype.invertHighlight=function(){var e=this.highlight;return this.changeHighlight(e.invert())};e.prototype.updatedText=function(e){return this.ensureActualDataCube().updatedText(e,this.timezone)};e.DEFAULT_DEFAULT_MEASURE_MODE={totals:"multi"};return e}();exports.Essence=Essence;check=Essence;